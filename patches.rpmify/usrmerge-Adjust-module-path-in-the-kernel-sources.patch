From 5e6b2a46d4342a6a0ac2f2a3235666154f74d0f8 Mon Sep 17 00:00:00 2001
From: Michal Suchanek <msuchanek@suse.de>
Date: Thu, 29 Jun 2023 17:47:16 +0200
Subject: [PATCH] usrmerge: Adjust module path in the kernel sources.

References: bsc#1212835
Patch-mainline: not yet, to get throuhg more testing

Get the module path prefix from patched kmod output.

On systems with unpatched kmod the prefix correctly resolves to empty
string.

Signed-off-by: Michal Suchanek <msuchanek@suse.de>
---
 Makefile          | 4 +++-
 scripts/depmod.sh | 8 ++++----
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/Makefile b/Makefile
index 1dc91aa36c1f..d702e7a637c6 100644
--- a/Makefile
+++ b/Makefile
@@ -1166,7 +1166,9 @@ export INSTALL_DTBS_PATH ?= $(INSTALL_PATH)/dtbs/$(KERNELRELEASE)
 # makefile but the argument can be passed to make if needed.
 #
 
-MODLIB	= $(INSTALL_MOD_PATH)/lib/modules/$(KERNELRELEASE)
+export KERNEL_MODULE_PREFIX := $(shell kmod config | jq -r .module_prefix)
+
+MODLIB	= $(INSTALL_MOD_PATH)$(KERNEL_MODULE_PREFIX)/lib/modules/$(KERNELRELEASE)
 export MODLIB
 
 PHONY += prepare0
