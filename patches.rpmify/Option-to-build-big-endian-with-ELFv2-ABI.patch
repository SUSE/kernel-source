From npiggin@gmail.com Mon Oct 31 13:16:55 2022
From: Nicholas Piggin <npiggin@gmail.com>
Subject: [PATCH v5 2/2] powerpc/64: Option to build big-endian with ELFv2 ABI
Date: Mon, 31 Oct 2022 22:16:39 +1000
Message-Id: <20221031121639.3957300-3-npiggin@gmail.com>

References: ppc64 ELFv2
Patch-mainline: submitted (v5 not visible on patchwork)

Provide an option to build big-endian kernels using the ELFv2 ABI. This
works on GCC only for now. Clang is rumored to support this, but core
build files need updating first, at least.

This gives big-endian kernels useful advantages of the ELFv2 ABI, e.g.,
less stack usage, -mprofile-kernel support, better compatibility with
eBPF tools.

BE+ELFv2 is not officially supported by the GNU toolchain, but it works
fine in testing and has been used by some userspace for some time (e.g.,
Void Linux).

Tested-by: Michal Such√°nek <msuchanek@suse.de>
Reviewed-by: Segher Boessenkool <segher@kernel.crashing.org>
Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
Acked-by: Michal Suchanek <msuchanek@suse.de>
---
 arch/powerpc/Kconfig                   | 21 +++++++++++++++++++++
 arch/powerpc/platforms/Kconfig.cputype |  4 ++--
 2 files changed, 23 insertions(+), 2 deletions(-)

diff --git a/arch/powerpc/Kconfig b/arch/powerpc/Kconfig
index 699df27b0e2f..2b04906838d2 100644
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@ -1,6 +1,9 @@
 # SPDX-License-Identifier: GPL-2.0
 source "arch/powerpc/platforms/Kconfig.cputype"
 
+config CC_HAS_ELFV2
+	def_bool PPC64 && $(cc-option, -mabi=elfv2)
+
 config 32BIT
 	bool
 	default y if PPC32
@@ -582,6 +585,24 @@ config KEXEC_FILE
 config ARCH_HAS_KEXEC_PURGATORY
 	def_bool KEXEC_FILE
 
+config PPC64_BIG_ENDIAN_ELF_ABI_V2
+	bool "Build big-endian kernel using ELF ABI V2 (EXPERIMENTAL)"
+	depends on PPC64 && CPU_BIG_ENDIAN && EXPERT
+	depends on CC_HAS_ELFV2
+	depends on LD_IS_BFD && LD_VERSION >= 22400
+	default n
+	help
+	  This builds the kernel image using the "Power Architecture 64-Bit ELF
+	  V2 ABI Specification", which has a reduced stack overhead and faster
+	  function calls. This internal kernel ABI option does not affect
+          userspace compatibility.
+
+	  The V2 ABI is standard for 64-bit little-endian, but for big-endian
+	  it is less well tested by kernel and toolchain. However some distros
+	  build userspace this way, and it can produce a functioning kernel.
+
+	  This requires GCC and binutils 2.24 or newer.
+
 config RELOCATABLE
 	bool "Build a relocatable kernel"
 	depends on PPC64 || (FLATMEM && (44x || PPC_85xx))
diff --git a/arch/powerpc/platforms/Kconfig.cputype b/arch/powerpc/platforms/Kconfig.cputype
index 0c4eed9aea80..6e94d45f3baa 100644
--- a/arch/powerpc/platforms/Kconfig.cputype
+++ b/arch/powerpc/platforms/Kconfig.cputype
@@ -575,10 +575,10 @@ config CPU_LITTLE_ENDIAN
 endchoice
 
 config PPC64_ELF_ABI_V1
-	def_bool PPC64 && CPU_BIG_ENDIAN
+	def_bool PPC64 && (CPU_BIG_ENDIAN && !PPC64_BIG_ENDIAN_ELF_ABI_V2)
 
 config PPC64_ELF_ABI_V2
-	def_bool PPC64 && CPU_LITTLE_ENDIAN
+	def_bool PPC64 && !PPC64_ELF_ABI_V1
 
 config PPC64_BOOT_WRAPPER
 	def_bool n
-- 
2.37.2


From segher@kernel.crashing.org Mon Oct 31 20:04:28 2022
Return-Path: <segher@kernel.crashing.org>
Delivered-To: msuchanek
Received: from dovecot-director2.suse.de ([192.168.254.65])
	(using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits))
	by imap2.suse-dmz.suse.de with LMTPS
	id 0CGuBTwcYGPvAgAAMHmgww
	(envelope-from <segher@kernel.crashing.org>)
	for <msuchanek>; Mon, 31 Oct 2022 19:04:28 +0000
Received: from smtp-in1.suse.de ([192.168.254.77])
	(using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits))
	by dovecot-director2.suse.de with LMTPS
	id EM/GBDwcYGOfSAAApTUePA
	(envelope-from <segher@kernel.crashing.org>)
	for <msuchanek@imap.suse.de>; Mon, 31 Oct 2022 19:04:28 +0000
Received: from gate.crashing.org (gate.crashing.org [63.228.1.57])
	by smtp-in1.suse.de (Postfix) with ESMTP id 4N1MyZ4TVyzZ9y
	for <msuchanek@suse.de>; Mon, 31 Oct 2022 19:04:22 +0000 (UTC)
Received: from gate.crashing.org (localhost.localdomain [127.0.0.1])
	by gate.crashing.org (8.14.1/8.14.1) with ESMTP id 29VJ2J6m001600;
	Mon, 31 Oct 2022 14:02:19 -0500
Received: (from segher@localhost)
	by gate.crashing.org (8.14.1/8.14.1/Submit) id 29VJ2JbX001599;
	Mon, 31 Oct 2022 14:02:19 -0500
X-Authentication-Warning: gate.crashing.org: segher set sender to segher@kernel.crashing.org using -f
Date: Mon, 31 Oct 2022 14:02:19 -0500
From: Segher Boessenkool <segher@kernel.crashing.org>
To: Nicholas Piggin <npiggin@gmail.com>
Cc: Michal =?iso-8859-1?Q?Such=E1nek?= <msuchanek@suse.de>
Subject: Re: [PATCH v5 2/2] powerpc/64: Option to build big-endian with ELFv2 ABI
Message-ID: <20221031190219.GJ25951@gate.crashing.org>
References: <20221031121639.3957300-1-npiggin@gmail.com> <20221031121639.3957300-3-npiggin@gmail.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20221031121639.3957300-3-npiggin@gmail.com>
User-Agent: Mutt/1.4.2.3i
X-Spam-Level: *
X-Spamd-Bar: +
Authentication-Results: smtp-in1.suse.de;
	dkim=none;
	dmarc=none;
	spf=pass (smtp-in1.suse.de: domain of segher@kernel.crashing.org designates 63.228.1.57 as permitted sender) smtp.mailfrom=segher@kernel.crashing.org
X-Rspamd-Server: rspamd1
X-Spamd-Result: default: False [1.34 / 50.00];
	 ARC_NA(0.00)[];
	 FROM_HAS_DN(0.00)[];
	 MV_CASE(0.50)[];
	 R_SPF_ALLOW(-0.20)[+ip4:63.228.1.56/29];
	 MIME_GOOD(-0.10)[text/plain];
	 HAS_XAW(0.00)[];
	 DMARC_NA(1.20)[crashing.org];
	 NEURAL_HAM_LONG(-0.99)[-0.988];
	 TO_MATCH_ENVRCPT_SOME(0.00)[];
	 TO_DN_ALL(0.00)[];
	 MX_GOOD(-0.01)[];
	 RCPT_COUNT_TWO(0.00)[2];
	 NEURAL_HAM_SHORT(-0.42)[-0.421];
	 MID_RHS_MATCH_FROMTLD(0.00)[];
	 FREEMAIL_TO(0.00)[gmail.com];
	 RCVD_NO_TLS_LAST(0.10)[];
	 FROM_EQ_ENVFROM(0.00)[];
	 R_DKIM_NA(2.20)[];
	 MIME_TRACE(0.00)[0:+];
	 ASN(0.00)[asn:209, ipnet:63.228.0.0/20, country:US];
	 RCVD_COUNT_TWO(0.00)[2];
	 BAYES_HAM(-0.94)[86.53%]
X-Spam-Score: 1.34
X-Rspamd-Queue-Id: 4N1MyZ4TVyzZ9y
X-Spam-Flag: NO
X-TUID: 9BYTKfpsg1xH
Status: RO
Content-Length: 834

On Mon, Oct 31, 2022 at 10:16:39PM +1000, Nicholas Piggin wrote:
> Provide an option to build big-endian kernels using the ELFv2 ABI. This
> works on GCC only for now. Clang is rumored to support this, but core
> build files need updating first, at least.
> 
> This gives big-endian kernels useful advantages of the ELFv2 ABI, e.g.,
> less stack usage, -mprofile-kernel support, better compatibility with
> eBPF tools.
> 
> BE+ELFv2 is not officially supported by the GNU toolchain, but it works
> fine in testing and has been used by some userspace for some time (e.g.,
> Void Linux).

It *is* supported by GCC.  But as long as the ABI isn't used by anything
mainstream we do not get the testing coverage we want, and you will be
more likely to hit problems than usual.

There is no such thing as "officially supported" :-)


Segher

From npiggin@gmail.com Mon Oct 31 13:16:53 2022
Return-Path: <npiggin@gmail.com>
Delivered-To: msuchanek
Received: from dovecot-director2.suse.de ([192.168.254.65])
	(using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits))
	by imap2.suse-dmz.suse.de with LMTPS
	id aEY6ErW8X2NUNAAAMHmgww
	(envelope-from <npiggin@gmail.com>)
	for <msuchanek>; Mon, 31 Oct 2022 12:16:53 +0000
Received: from smtp-in1.suse.de ([192.168.254.77])
	(using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits))
	by dovecot-director2.suse.de with LMTPS
	id EEk7EbW8X2NqYQAApTUePA
	(envelope-from <npiggin@gmail.com>)
	for <msuchanek@imap.suse.de>; Mon, 31 Oct 2022 12:16:53 +0000
Received: from mail-pl1-x631.google.com (mail-pl1-x631.google.com [IPv6:2607:f8b0:4864:20::631])
	(using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
	 key-exchange X25519 server-signature ECDSA (P-384) server-digest SHA384)
	(No client certificate requested)
	by smtp-in1.suse.de (Postfix) with ESMTPS id 4N1BwN4zszzZ9y
	for <msuchanek@suse.de>; Mon, 31 Oct 2022 12:16:52 +0000 (UTC)
Received: by mail-pl1-x631.google.com with SMTP id v17so7545245plo.1
        for <msuchanek@suse.de>; Mon, 31 Oct 2022 05:16:52 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20210112;
        h=content-transfer-encoding:mime-version:references:in-reply-to
         :message-id:date:subject:cc:to:from:from:to:cc:subject:date
         :message-id:reply-to;
        bh=1UNoFZjpqfGudip0kcMOvEq1qB17vDLLLPW/9fqGP8Y=;
        b=Foa2x83nhxep+P8MOOAlJdC10G/YjDD6nQxc9+tHgcthFggIUa1sOwbOfFhagCFLsI
         pUoUAee9XscQwE3AC/COflvdH5NPVrsVMYw1To6KReB8xY/GnnoZk9TiIOBq5Hr8RBuB
         LTt+DL9Rba9qlMTP3e9SkAUSL7e2ZNdpWZv7MZRYuEu5DMhssn6WjSd0uTeBZWA250g3
         /xaIIXD8Af0i8AImRBLZ5Mggf+3Q/AtRWnl1zWvlVLz2BzTfoUDooyP7lz3lcg//C253
         sszGidEqsOlkvJKkRKctzkcpxtsmEu44t1LkN1bFZNFtH8Zn1wtJi7izXRv+u8Jnu/bQ
         0QeQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=content-transfer-encoding:mime-version:references:in-reply-to
         :message-id:date:subject:cc:to:from:x-gm-message-state:from:to:cc
         :subject:date:message-id:reply-to;
        bh=1UNoFZjpqfGudip0kcMOvEq1qB17vDLLLPW/9fqGP8Y=;
        b=Uq00ak1ymplcv5h+321uxTCRSJgphrogoLQSpZy9W8xiq6HVJy8R12pL/fYb3XbpJK
         ZTukW5FGK/OiWpD4jPIKLP8Nf+mgECo9JAAGUdfcXLjOYhFh83R8+2/aUqoeqMsNIMOd
         14FhPdhHDRDFlwR0jCwAFHvsOLlRRfmHeZmA/Xd9oGf22HU5Hh4+wyENPjC/le8U1fCv
         XagBGQMJhR2UbgWA1qXPhlfgdNUEWAjeX79psejM1tJZ8e/eKDET4lxBt+L55/BIJiiq
         PAL+1F7nTidodi+mJcTmcgVOp1mKWTBIuSU4HTTSKRdDjgzvTvATMuZ7Kt16hhJrIdyy
         HF7Q==
X-Gm-Message-State: ACrzQf2TJDBpJXJySfARRRPIPJvqEoL5Q1/O7zEg4/ExejG0lkQIUfoC
	3dRRvEISgLG3621xNZPK3YSxYNrAUg0=
X-Google-Smtp-Source: AMsMyM7wnp+iSiov8pX/uPjHaWBP87COpopnYi5f9Skdw7sfnWAUXcn7RxQN7DJ63BzCcdiWJnaXhg==
X-Received: by 2002:a17:90b:254e:b0:20b:7e26:f0a0 with SMTP id nw14-20020a17090b254e00b0020b7e26f0a0mr31075608pjb.203.1667218611206;
        Mon, 31 Oct 2022 05:16:51 -0700 (PDT)
Received: from bobo.ozlabs.ibm.com (193-116-106-251.tpgi.com.au. [193.116.106.251])
        by smtp.gmail.com with ESMTPSA id l14-20020a17090a4d4e00b002130ad34d24sm4124475pjh.4.2022.10.31.05.16.48
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 31 Oct 2022 05:16:50 -0700 (PDT)
From: Nicholas Piggin <npiggin@gmail.com>
To: 
Cc: Nicholas Piggin <npiggin@gmail.com>,
	=?UTF-8?q?Michal=20Such=C3=A1nek?= <msuchanek@suse.de>,
	Segher Boessenkool <segher@kernel.crashing.org>
Subject: [PATCH v5 1/2] powerpc/64: Add big-endian ELFv2 flavour to crypto VMX asm generation
Date: Mon, 31 Oct 2022 22:16:38 +1000
Message-Id: <20221031121639.3957300-2-npiggin@gmail.com>
X-Mailer: git-send-email 2.37.2
In-Reply-To: <20221031121639.3957300-1-npiggin@gmail.com>
References: <20221031121639.3957300-1-npiggin@gmail.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Spam-Level: **
X-Spamd-Bar: ++
Authentication-Results: smtp-in1.suse.de;
	dkim=pass header.d=gmail.com header.s=20210112 header.b=Foa2x83n;
	dmarc=pass (policy=none) header.from=gmail.com;
	spf=pass (smtp-in1.suse.de: domain of npiggin@gmail.com designates 2607:f8b0:4864:20::631 as permitted sender) smtp.mailfrom=npiggin@gmail.com
X-Rspamd-Server: rspamd1
X-Spamd-Result: default: False [2.79 / 50.00];
	 RCVD_VIA_SMTP_AUTH(0.00)[];
	 R_SPF_ALLOW(-0.20)[+ip6:2607:f8b0:4000::/36:c];
	 FREEMAIL_FROM(0.50)[gmail.com];
	 R_MISSING_CHARSET(2.50)[];
	 BROKEN_CONTENT_TYPE(1.50)[];
	 RCVD_COUNT_THREE(0.00)[3];
	 TO_DN_ALL(0.00)[];
	 DKIM_TRACE(0.00)[gmail.com:+];
	 DMARC_POLICY_ALLOW(-0.50)[gmail.com,none];
	 MX_GOOD(-0.01)[];
	 NEURAL_HAM_SHORT(-1.00)[-1.000];
	 FROM_EQ_ENVFROM(0.00)[];
	 MIME_TRACE(0.00)[0:+];
	 FREEMAIL_ENVFROM(0.00)[gmail.com];
	 ASN(0.00)[asn:15169, ipnet:2607:f8b0::/32, country:US];
	 BAYES_HAM(-3.00)[100.00%];
	 DWL_DNSWL_NONE(1.20)[gmail.com:dkim];
	 ARC_NA(0.00)[];
	 R_DKIM_ALLOW(-0.20)[gmail.com:s=20210112];
	 RECEIVED_SPAMHAUS_PBL(0.00)[193.116.106.251:received];
	 FROM_HAS_DN(0.00)[];
	 RCPT_COUNT_THREE(0.00)[3];
	 NEURAL_HAM_LONG(-0.90)[-0.904];
	 MIME_GOOD(-0.10)[text/plain];
	 PREVIOUSLY_DELIVERED(0.00)[msuchanek@suse.de];
	 TO_MATCH_ENVRCPT_SOME(0.00)[];
	 MID_CONTAINS_FROM(1.00)[];
	 RCVD_IN_DNSWL_NONE(2.00)[2607:f8b0:4864:20::631:from];
	 FREEMAIL_CC(0.00)[gmail.com,suse.de,kernel.crashing.org];
	 RCVD_TLS_ALL(0.00)[]
X-Spam-Score: 2.79
X-Rspamd-Queue-Id: 4N1BwN4zszzZ9y
X-Spam-Flag: NO
X-TUID: KQSVS8mIIh5N
Status: RO
Content-Length: 2586

This allows asm generation for big-endian ELFv2 builds.

Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
---
 drivers/crypto/vmx/Makefile     | 12 +++++++++++-
 drivers/crypto/vmx/ppc-xlate.pl | 10 ++++++----
 2 files changed, 17 insertions(+), 5 deletions(-)

diff --git a/drivers/crypto/vmx/Makefile b/drivers/crypto/vmx/Makefile
index 2560cfea1dec..e33c7238e7f8 100644
--- a/drivers/crypto/vmx/Makefile
+++ b/drivers/crypto/vmx/Makefile
@@ -2,8 +2,18 @@
 obj-$(CONFIG_CRYPTO_DEV_VMX_ENCRYPT) += vmx-crypto.o
 vmx-crypto-objs := vmx.o aesp8-ppc.o ghashp8-ppc.o aes.o aes_cbc.o aes_ctr.o aes_xts.o ghash.o
 
+ifeq ($(CONFIG_CPU_LITTLE_ENDIAN),y)
+override flavour := linux-ppc64le
+else
+ifdef CONFIG_PPC64_ELF_ABI_V2
+override flavour := linux-ppc64-elfv2
+else
+override flavour := linux-ppc64
+endif
+endif
+
 quiet_cmd_perl = PERL    $@
-      cmd_perl = $(PERL) $< $(if $(CONFIG_CPU_LITTLE_ENDIAN), linux-ppc64le, linux-ppc64) > $@
+      cmd_perl = $(PERL) $< $(flavour) > $@
 
 targets += aesp8-ppc.S ghashp8-ppc.S
 
diff --git a/drivers/crypto/vmx/ppc-xlate.pl b/drivers/crypto/vmx/ppc-xlate.pl
index 36db2ef09e5b..b583898c11ae 100644
--- a/drivers/crypto/vmx/ppc-xlate.pl
+++ b/drivers/crypto/vmx/ppc-xlate.pl
@@ -9,6 +9,8 @@ open STDOUT,">$output" || die "can't open $output: $!";
 
 my %GLOBALS;
 my $dotinlocallabels=($flavour=~/linux/)?1:0;
+my $elfv2abi=(($flavour =~ /linux-ppc64le/) or ($flavour =~ /linux-ppc64-elfv2/))?1:0;
+my $dotfunctions=($elfv2abi=~1)?0:1;
 
 ################################################################
 # directives which need special treatment on different platforms
@@ -40,7 +42,7 @@ my $globl = sub {
 };
 my $text = sub {
     my $ret = ($flavour =~ /aix/) ? ".csect\t.text[PR],7" : ".text";
-    $ret = ".abiversion	2\n".$ret	if ($flavour =~ /linux.*64le/);
+    $ret = ".abiversion	2\n".$ret	if ($elfv2abi);
     $ret;
 };
 my $machine = sub {
@@ -56,8 +58,8 @@ my $size = sub {
     if ($flavour =~ /linux/)
     {	shift;
 	my $name = shift; $name =~ s|^[\.\_]||;
-	my $ret  = ".size	$name,.-".($flavour=~/64$/?".":"").$name;
-	$ret .= "\n.size	.$name,.-.$name" if ($flavour=~/64$/);
+	my $ret  = ".size	$name,.-".($dotfunctions?".":"").$name;
+	$ret .= "\n.size	.$name,.-.$name" if ($dotfunctions);
 	$ret;
     }
     else
@@ -142,7 +144,7 @@ my $vmr = sub {
 
 # Some ABIs specify vrsave, special-purpose register #256, as reserved
 # for system use.
-my $no_vrsave = ($flavour =~ /linux-ppc64le/);
+my $no_vrsave = ($elfv2abi);
 my $mtspr = sub {
     my ($f,$idx,$ra) = @_;
     if ($idx == 256 && $no_vrsave) {
-- 
2.37.2


