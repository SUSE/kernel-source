From 8d58e56c03dba9cc461ccfd36a3ca35eaa19229a Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Mon, 29 Aug 2022 07:42:19 +0200
Subject: [PATCH] Revert "block: freeze the queue earlier in del_gendisk"
References: bsc#1202534 bsc#1202589
Patch-mainline: Not yet, temporary workaround until the upstream fix

This reverts commit a09b314005f3a0956ebf56e01b3b80339df577cc.

The commit above seems causing a hang at shutdown/reboot with the
mysterious repeated dying message:
  block device autoloading is deprecated and will be removed.

Revert the commit for fixing the regression.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 block/genhd.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/block/genhd.c b/block/genhd.c
index d36fabf0abc1..988ba52fd331 100644
--- a/block/genhd.c
+++ b/block/genhd.c
@@ -602,7 +602,6 @@ void del_gendisk(struct gendisk *disk)
 	 * Prevent new I/O from crossing bio_queue_enter().
 	 */
 	blk_queue_start_drain(q);
-	blk_mq_freeze_queue_wait(q);
 
 	if (!(disk->flags & GENHD_FL_HIDDEN)) {
 		sysfs_remove_link(&disk_to_dev(disk)->kobj, "bdi");
@@ -626,6 +625,8 @@ void del_gendisk(struct gendisk *disk)
 	pm_runtime_set_memalloc_noio(disk_to_dev(disk), false);
 	device_del(disk_to_dev(disk));
 
+	blk_mq_freeze_queue_wait(q);
+
 	blk_throtl_cancel_bios(disk->queue);
 
 	blk_sync_queue(q);
-- 
2.35.3

