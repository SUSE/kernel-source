From: Miklos Szeredi <mszeredi@redhat.com>
Date: Thu, 21 Jul 2022 16:06:18 +0200
Subject: fuse: ioctl: translate ENOSYS
Mime-version: 1.0
Content-type: text/plain; charset=UTF-8
Content-transfer-encoding: 8bit
Git-commit: 02c0cab8e7345b06f1c0838df444e2902e4138d3
Patch-mainline: v6.0-rc1
References: bsc#1203136

Overlayfs may fail to complete updates when a filesystem lacks
fileattr/xattr syscall support and responds with an ENOSYS error code,
resulting in an unexpected "Function not implemented" error.

This bug may occur with FUSE filesystems, such as davfs2.

Steps to reproduce:

  # install davfs2, e.g., apk add davfs2
  mkdir /test mkdir /test/lower /test/upper /test/work /test/mnt
  yes '' | mount -t davfs -o ro http://some-web-dav-server/path \
    /test/lower
  mount -t overlay -o upperdir=/test/upper,lowerdir=/test/lower \
    -o workdir=/test/work overlay /test/mnt

  # when "some-file" exists in the lowerdir, this fails with "Function
  # not implemented", with dmesg showing "overlayfs: failed to retrieve
  # lower fileattr (/some-file, err=-38)"
  touch /test/mnt/some-file

The underlying cause of this regresion is actually in FUSE, which fails to
translate the ENOSYS error code returned by userspace filesystem (which
means that the ioctl operation is not supported) to ENOTTY.

Reported-by: Christian Kohlsch√ºtter <christian@kohlschutter.com>
Fixes: 72db82115d2b ("ovl: copy up sync/noatime fileattr flags")
Fixes: 59efec7b9039 ("fuse: implement ioctl support")
Cc: <stable@vger.kernel.org>
Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
[As we don't have 72227eac177d ("fuse: convert to fileattr"), inline error
 translation and drop the last hunk.]
Acked-by: Luis Henriques <lhenriques@suse.com>

---
 fs/fuse/file.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/fs/fuse/file.c
+++ b/fs/fuse/file.c
@@ -2865,6 +2865,9 @@ long fuse_do_ioctl(struct file *file, un
 	ap.args.out_argvar = true;
 
 	transferred = fuse_simple_request(fc, &ap.args);
+	/* Translate ENOSYS, which shouldn't be returned from fs */
+	if (transferred == -ENOSYS)
+		transferred = -ENOTTY;
 	err = transferred;
 	if (transferred < 0)
 		goto out;
