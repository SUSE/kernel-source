From: Steve French <stfrench@microsoft.com>
Date: Thu, 11 Jun 2020 22:28:49 -0500
Subject: [PATCH] smb311: Add support for lookup with posix extensions query
 info
Git-commit: 790434ff9848a4d44f067a6a5416b49a2db89a59
Patch-mainline: v5.8-rc1
References: bsc#1192606

Improve support for lookup when using SMB3.1.1 posix mounts.
Use new info level 100 (posix query info)

Signed-off-by: Steve French <stfrench@microsoft.com>
Reviewed-by: Aurelien Aptel <aaptel@suse.com>
Acked-by: Enzo Matsumiya <ematsumiya@suse.de>
---
 fs/cifs/dir.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/fs/cifs/dir.c b/fs/cifs/dir.c
index 36e7b2fd2190..aa61ffab8ab8 100644
--- a/fs/cifs/dir.c
+++ b/fs/cifs/dir.c
@@ -700,7 +700,9 @@ cifs_lookup(struct inode *parent_dir_inode, struct dentry *direntry,
 	cifs_dbg(FYI, "Full path: %s inode = 0x%p\n",
 		 full_path, d_inode(direntry));
 
-	if (pTcon->unix_ext) {
+	if (pTcon->posix_extensions)
+		rc = smb311_posix_get_inode_info(&newInode, full_path, parent_dir_inode->i_sb, xid);
+	else if (pTcon->unix_ext) {
 		rc = cifs_get_inode_info_unix(&newInode, full_path,
 					      parent_dir_inode->i_sb, xid);
 	} else {
-- 
2.33.1

