From: Johannes Berg <johannes.berg@intel.com>
Date: Wed, 15 May 2024 14:16:00 +0200
Subject: [PATCH] wifi: nl80211: disallow setting special AP channel widths
Git-commit: 23daf1b4c91db9b26f8425cc7039cf96d22ccbfe
Patch-mainline: v6.11-rc1
References: CVE-2024-43912 bsc#1229830

[ Dropped hunk validating link_id channel and NL80211_CHAN_WIDTH_320, code not
  present. ]

Setting the AP channel width is meant for use with the normal
20/40/... MHz channel width progression, and switching around
in S1G or narrow channels isn't supported. Disallow that.

Reported-by: syzbot+bc0f5b92cc7091f45fb6@syzkaller.appspotmail.com
Link: https://msgid.link/20240515141600.d4a9590bfe32.I19a32d60097e81b527eafe6b0924f6c5fbb2dc45@changeid
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: David Sterba <dsterba@suse.com>
---
 net/wireless/nl80211.c |   13 +++++++++++++
 1 file changed, 13 insertions(+)

--- a/net/wireless/nl80211.c
+++ b/net/wireless/nl80211.c
@@ -3183,6 +3183,19 @@ static int __nl80211_set_channel(struct
 				result = -EBUSY;
 				break;
 			}
+			/* only allow this for regular channel widths */
+			switch (chandef.width) {
+			case NL80211_CHAN_WIDTH_20_NOHT:
+			case NL80211_CHAN_WIDTH_20:
+			case NL80211_CHAN_WIDTH_40:
+			case NL80211_CHAN_WIDTH_80:
+			case NL80211_CHAN_WIDTH_80P80:
+			case NL80211_CHAN_WIDTH_160:
+				break;
+			default:
+				return -EINVAL;
+			}
+
 			result = rdev_set_ap_chanwidth(rdev, dev, &chandef);
 			if (result)
 				break;
