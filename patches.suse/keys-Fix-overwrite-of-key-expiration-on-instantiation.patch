From 9da27fb65a14c18efd4473e2e82b76b53ba60252 Mon Sep 17 00:00:00 2001
From: Silvio Gissi <sifonsec@amazon.com>
Date: Fri, 15 Mar 2024 15:05:39 -0400
Subject: [PATCH] keys: Fix overwrite of key expiration on instantiation
Git-commit: 9da27fb65a14c18efd4473e2e82b76b53ba60252
Patch-mainline: v6.10-rc1
References: git-fixes CVE-2024-36031 bsc#1225713

The expiry time of a key is unconditionally overwritten during
instantiation, defaulting to turn it permanent. This causes a problem
for DNS resolution as the expiration set by user-space is overwritten to
TIME64_MAX, disabling further DNS updates. Fix this by restoring the
condition that key_set_expiry is only called when the pre-parser sets a
specific expiry.

Fixes: 39299bdd2546 ("keys, dns: Allow key types (eg. DNS) to be reclaimed immediately on expiry")
Signed-off-by: Silvio Gissi <sifonsec@amazon.com>
Cc: David Howells <dhowells@redhat.com>
Cc: Hazem Mohamed Abuelfotoh <abuehaze@amazon.com>
Cc: linux-afs@lists.infradead.org
Cc: linux-cifs@vger.kernel.org
Cc: keyrings@vger.kernel.org
Cc: netdev@vger.kernel.org
Cc: stable@vger.kernel.org
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
Acked-by: Anthony Iliopoulos <ailiop@suse.com>

---
 security/keys/key.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/security/keys/key.c b/security/keys/key.c
index 2a9a769e795e..3d7d185019d3 100644
--- a/security/keys/key.c
+++ b/security/keys/key.c
@@ -465,7 +465,8 @@ static int __key_instantiate_and_link(struct key *key,
 			if (authkey)
 				key_invalidate(authkey);
 
-			key_set_expiry(key, prep->expiry);
+			if (prep->expiry != TIME64_MAX)
+				key_set_expiry(key, prep->expiry);
 		}
 	}
 
-- 
2.47.0

