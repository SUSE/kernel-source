From: Trond Myklebust <trond.myklebust@hammerspace.com>
Date: Sat, 2 Oct 2021 19:04:59 -0400
Subject: [PATCH] NFS: Do not flush the readdir cache in nfs_dentry_iput()
Git-commit: b97583b26326ad559d1b1ba7dafec98712ffd834
Patch-mainline: v5.16
References: bsc#1231847

The original premise in commit 83672d392f7b ("NFS: Fix directory caching
problem - with test case and patch.") was that readdirplus was caching
attribute information and replaying it later. This is no longer the
case.

Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Acked-by: NeilBrown <neilb@suse.com>

---
 fs/nfs/dir.c |    4 ----
 1 file changed, 4 deletions(-)

--- a/fs/nfs/dir.c
+++ b/fs/nfs/dir.c
@@ -1581,10 +1581,6 @@ static void nfs_drop_nlink(struct inode
  */
 static void nfs_dentry_iput(struct dentry *dentry, struct inode *inode)
 {
-	if (S_ISDIR(inode->i_mode))
-		/* drop any readdir cache as it could easily be old */
-		NFS_I(inode)->cache_validity |= NFS_INO_INVALID_DATA;
-
 	if (dentry->d_flags & DCACHE_NFSFS_RENAMED) {
 		nfs_complete_unlink(dentry, inode);
 		nfs_drop_nlink(inode);
