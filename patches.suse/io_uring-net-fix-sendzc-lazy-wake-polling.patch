From ef42b85a5609cd822ca0a68dd2bef2b12b5d1ca3 Mon Sep 17 00:00:00 2001
From: Pavel Begunkov <asml.silence@gmail.com>
Date: Tue, 30 Apr 2024 16:42:30 +0100
Subject: [PATCH] io_uring/net: fix sendzc lazy wake polling
Git-commit: ef42b85a5609cd822ca0a68dd2bef2b12b5d1ca3
Patch-mainline: v6.10-rc1
References: git-fixes

SEND[MSG]_ZC produces multiple CQEs via notifications, LAZY_WAKE doesn't
handle it and so disable LAZY_WAKE for sendzc polling. It should be
fine, sends are not likely to be polled in the first place.

Fixes: 6ce4a93dbb5b ("io_uring/poll: use IOU_F_TWQ_LAZY_WAKE for wakeups")
Signed-off-by: Pavel Begunkov <asml.silence@gmail.com>
Link: https://lore.kernel.org/r/5b360fb352d91e3aec751d75c87dfb4753a084ee.1714488419.git.asml.silence@gmail.com
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Gabriel Krisman Bertazi <krisman@suse.de>
---
 io_uring/net.c |    1 +
 1 file changed, 1 insertion(+)

--- a/io_uring/net.c
+++ b/io_uring/net.c
@@ -1091,6 +1091,7 @@ int io_send_zc_prep(struct io_kiocb *req
 		req->flags |= REQ_F_NOWAIT;
 
 	zc->done_io = 0;
+	req->flags |= REQ_F_POLL_NO_LAZY;
 
 #ifdef CONFIG_COMPAT
 	if (req->ctx->compat)
