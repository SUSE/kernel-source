From: Stanislav Fomichev <sdf@google.com>
Date: Mon, 18 Mar 2024 09:54:27 -0700
Subject: xsk: Don't assume metadata is always requested in TX completion
Patch-mainline: v6.9-rc2
Git-commit: f6e922365faf4cd576bd1cf3e64b58c8a32e1856
References: git-fixes

`compl->tx_timestam != NULL` means that the user has explicitly
requested the metadata via XDP_TX_METADATA+XDP_TX_METADATA_TIMESTAMP.

Fixes: 48eb03dd2630 ("xsk: Add TX timestamp and TX checksum offload support")
Reported-by: Daniele Salvatore Albano <d.albano@gmail.com>
Signed-off-by: Stanislav Fomichev <sdf@google.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Tested-by: Daniele Salvatore Albano <d.albano@gmail.com>
Link: https://lore.kernel.org/bpf/20240318165427.1403313-1-sdf@google.com
Acked-by: Pedro Falcato <pfalcato@suse.de>
---
 include/net/xdp_sock.h |    2 ++
 1 file changed, 2 insertions(+)

--- a/include/net/xdp_sock.h
+++ b/include/net/xdp_sock.h
@@ -188,6 +188,8 @@ static inline void xsk_tx_metadata_compl
 {
 	if (!compl)
 		return;
+	if (!compl->tx_timestamp)
+		return;
 
 	*compl->tx_timestamp = ops->tmo_fill_timestamp(priv);
 }
