From: Zhu Yanjun <yanjun.zhu@linux.dev>
Date: Thu, 6 Jan 2022 13:03:59 -0500
Subject: RDMA/rxe: Use the standard method to produce udp source port
Patch-mainline: v5.17-rc1
Git-commit: 104f062fd1b9c8571dba6a3020649da6bbc66259
References: jsc#PED-1111

Use the standard method to produce udp source port.

Link: https://lore.kernel.org/r/20220106180359.2915060-5-yanjun.zhu@linux.dev
Signed-off-by: Zhu Yanjun <yanjun.zhu@linux.dev>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 drivers/infiniband/sw/rxe/rxe_verbs.c |    5 +++++
 1 file changed, 5 insertions(+)

--- a/drivers/infiniband/sw/rxe/rxe_verbs.c
+++ b/drivers/infiniband/sw/rxe/rxe_verbs.c
@@ -468,6 +468,11 @@ static int rxe_modify_qp(struct ib_qp *i
 	if (err)
 		goto err1;
 
+	if ((mask & IB_QP_AV) && (attr->ah_attr.ah_flags & IB_AH_GRH))
+		qp->src_port = rdma_get_udp_sport(attr->ah_attr.grh.flow_label,
+						  qp->ibqp.qp_num,
+						  qp->attr.dest_qp_num);
+
 	return 0;
 
 err1:
