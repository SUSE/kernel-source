From: Konstantin Komarov <almaz.alexandrovich@paragon-software.com>
Date: Wed, 28 Aug 2024 11:55:53 +0300
Subject: [PATCH] fs/ntfs3: Fix possible deadlock in mi_read
Git-commit: 03b097099eef255fbf85ea6a786ae3c91b11f041
Patch-mainline: v6.12-rc3
References: CVE-2024-50245 bsc#1233203

Mutex lock with another subclass used in ni_lock_dir().

Reported-by: syzbot+bc7ca0ae4591cb2550f9@syzkaller.appspotmail.com
Signed-off-by: Konstantin Komarov <almaz.alexandrovich@paragon-software.com>
Signed-off-by: David Sterba <dsterba@suse.com>
---
 fs/ntfs3/namei.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/fs/ntfs3/namei.c
+++ b/fs/ntfs3/namei.c
@@ -81,7 +81,7 @@ static struct dentry *ntfs_lookup(struct
 		if (err < 0)
 			inode = ERR_PTR(err);
 		else {
-			ni_lock(ni);
+			ni_lock_dir(ni);
 			inode = dir_search_u(dir, uni, NULL);
 			ni_unlock(ni);
 		}
