From 0c9efe4ba2f496642427c35bc3e3b2b482d5291d Mon Sep 17 00:00:00 2001
From: Jiang Liu <gerry@linux.alibaba.com>
Date: Fri, 7 Feb 2025 14:44:14 +0800
Subject: drm/amdgpu: avoid buffer overflow attach in smu_sys_set_pp_table()
Git-commit: 1abb2648698bf10783d2236a6b4a7ca5e8021699
Patch-mainline: v6.14-rc3
References: bsc#1239115 CVE-2025-21780

It malicious user provides a small pptable through sysfs and then
a bigger pptable, it may cause buffer overflow attack in function
smu_sys_set_pp_table().

Reviewed-by: Lijo Lazar <lijo.lazar@amd.com>
Signed-off-by: Jiang Liu <gerry@linux.alibaba.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Acked-by: Thomas Zimmermann <tzimmermann@suse.com>
---
 drivers/gpu/drm/amd/powerplay/amdgpu_smu.c | 10 ++++++----
 1 file changed, 6 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/amd/powerplay/amdgpu_smu.c b/drivers/gpu/drm/amd/powerplay/amdgpu_smu.c
index e88b09e074e19..2ac3d0ceb9ead 100644
--- a/drivers/gpu/drm/amd/powerplay/amdgpu_smu.c
+++ b/drivers/gpu/drm/amd/powerplay/amdgpu_smu.c
@@ -431,11 +431,13 @@ int smu_sys_set_pp_table(struct smu_context *smu,  void *buf, size_t size)
 	}
 
 	mutex_lock(&smu->mutex);
-	if (!smu_table->hardcode_pptable)
+	if (!smu_table->hardcode_pptable || smu_table->power_play_table_size < size) {
+		kfree(smu_table->hardcode_pptable);
 		smu_table->hardcode_pptable = kzalloc(size, GFP_KERNEL);
-	if (!smu_table->hardcode_pptable) {
-		ret = -ENOMEM;
-		goto failed;
+		if (!smu_table->hardcode_pptable) {
+			ret = -ENOMEM;
+			goto failed;
+		}
 	}
 
 	memcpy(smu_table->hardcode_pptable, buf, size);
-- 
2.48.1

