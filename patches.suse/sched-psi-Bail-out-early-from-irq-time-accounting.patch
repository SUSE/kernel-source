From 3467604844b5ce80a4ae844a71c7081b9f3a288c Mon Sep 17 00:00:00 2001
From: Haifeng Xu <haifeng.xu@shopee.com>
Date: Tue, 26 Sep 2023 11:57:22 +0000
Subject: [PATCH] sched/psi: Bail out early from irq time accounting

References: bsc#1212887 (Scheduler functional and performance backports)
Git-commit: 0c2924079f5a83ed715630680e338b3685a0bf7d
Patch-mainline: v6.7-rc1

We could bail out early when psi was disabled.

Signed-off-by: Haifeng Xu <haifeng.xu@shopee.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Reviewed-by: Chengming Zhou <zhouchengming@bytedance.com>
Link: https://lore.kernel.org/r/20230926115722.467833-1-haifeng.xu@shopee.com
Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 kernel/sched/psi.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/kernel/sched/psi.c b/kernel/sched/psi.c
index 44a78774ae87..519bc922a960 100644
--- a/kernel/sched/psi.c
+++ b/kernel/sched/psi.c
@@ -998,6 +998,9 @@ void psi_account_irqtime(struct task_struct *task, u32 delta)
 	struct psi_group_cpu *groupc;
 	u64 now;
 
+	if (static_branch_likely(&psi_disabled))
+		return;
+
 	if (!task->pid)
 		return;
 
