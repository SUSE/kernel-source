From: =?utf-8?q?Uwe_Kleine-K=C3=B6nig_=3Cu=2Ekleine-koenig=40pengutronix=2Ede=3E?=
Date: Tue, 26 Sep 2023 10:32:29 +0200
Subject: soc: qcom: llcc: Handle a second device without data corruption
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Git-commit: f1a1bc8775b26345aba2be278118999e7f661d3d
Patch-mainline: v6.7-rc1
References: bsc#1225534 CVE-2023-52871

Usually there is only one llcc device. But if there were a second, even
a failed probe call would modify the global drv_data pointer. So check
if drv_data is valid before overwriting it.

Signed-off-by: Uwe Kleine-KÃ¶nig <u.kleine-koenig@pengutronix.de>
Fixes: a3134fb09e0b ("drivers: soc: Add LLCC driver")
Link: https://lore.kernel.org/r/20230926083229.2073890-1-u.kleine-koenig@pengutronix.de
Signed-off-by: Bjorn Andersson <andersson@kernel.org>
[iivanov: Adjust file path]
Acked-by: Ivan T. Ivanov <iivanov@suse.de>
---
 drivers/soc/qcom/llcc-slice.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/drivers/soc/qcom/llcc-slice.c
+++ b/drivers/soc/qcom/llcc-slice.c
@@ -334,6 +334,9 @@ int qcom_llcc_probe(struct platform_devi
 	int ret, i;
 	struct platform_device *llcc_edac;
 
+	if (!IS_ERR(drv_data))
+		return -EBUSY;
+
 	drv_data = devm_kzalloc(dev, sizeof(*drv_data), GFP_KERNEL);
 	if (!drv_data) {
 		ret = -ENOMEM;
