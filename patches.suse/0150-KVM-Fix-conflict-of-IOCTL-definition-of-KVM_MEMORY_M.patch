Patch-mainline: Queued in subsystem maintainer repository
Git-repo: https://gitlab.suse.de/coco/tdx/kernel-downstream-suse.git
Git-commit: 8eb2be2978f6dd4da8b7a73f85633744f4b4b06e
References: jsc#PED-6143
From: Feng Tang <feng.tang@intel.com>
Date: Tue, 8 Oct 2024 19:47:35 +0800
Subject: [PATCH 150/155] KVM: Fix conflict of IOCTL definition of
 KVM_MEMORY_MAPPING

Newer kernel implment now instance which conflit with QEMU definitions.

Signed-off-by: Feng Tang <feng.tang@intel.com>
Signed-off-by: Juergen Gross <jgross@suse.com>
---
 include/uapi/linux/kvm.h |  3 ++-
 virt/kvm/kvm_main.c      | 22 +++++++++++-----------
 2 files changed, 13 insertions(+), 12 deletions(-)

diff --git a/include/uapi/linux/kvm.h b/include/uapi/linux/kvm.h
index 2a7334d258be..d350d3deba1c 100644
--- a/include/uapi/linux/kvm.h
+++ b/include/uapi/linux/kvm.h
@@ -1654,7 +1654,7 @@ struct kvm_create_guest_memfd {
 	__u64 padding[5];
 };
 
-#define KVM_MEMORY_MAPPING	_IOWR(KVMIO, 0xd5, struct kvm_memory_mapping)
+#define KVM_MEMORY_MAPPING	_IOWR(KVMIO, 0xd6, struct kvm_memory_mapping)
 
 struct kvm_memory_mapping {
 	__u64 base_gfn;
diff --git a/virt/kvm/kvm_main.c b/virt/kvm/kvm_main.c
index 62560ed8941d..755900f66c3f 100644
--- a/virt/kvm/kvm_main.c
+++ b/virt/kvm/kvm_main.c
@@ -4725,6 +4725,17 @@ static long kvm_vcpu_ioctl(struct file *filp,
 		break;
 	}
 #endif
+	case KVM_MEMORY_MAPPING: {
+		struct kvm_memory_mapping mapping;
+
+		r = -EFAULT;
+		if (copy_from_user(&mapping, argp, sizeof(mapping)))
+			break;
+		r = kvm_vcpu_memory_mapping(vcpu, &mapping);
+		if (copy_to_user(argp, &mapping, sizeof(mapping)))
+			r = -EFAULT;
+		break;
+	}
 	default:
 		r = kvm_arch_vcpu_ioctl(filp, ioctl, arg);
 	}
@@ -4769,17 +4780,6 @@ static long kvm_vcpu_compat_ioctl(struct file *filp,
 			r = kvm_vcpu_ioctl_set_sigmask(vcpu, NULL);
 		break;
 	}
-	case KVM_MEMORY_MAPPING: {
-		struct kvm_memory_mapping mapping;
-
-		r = -EFAULT;
-		if (copy_from_user(&mapping, argp, sizeof(mapping)))
-			break;
-		r = kvm_vcpu_memory_mapping(vcpu, &mapping);
-		if (copy_to_user(argp, &mapping, sizeof(mapping)))
-			r = -EFAULT;
-		break;
-	}
 	default:
 		r = kvm_vcpu_ioctl(filp, ioctl, arg);
 	}
-- 
2.43.0

