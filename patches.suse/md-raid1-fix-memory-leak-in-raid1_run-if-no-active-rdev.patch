From: Zheng Qixing <zhengqixing@huawei.com>
Date: Sat, 15 Feb 2025 10:01:37 +0800
Subject: md/raid1: fix memory leak in raid1_run() if no active rdev
Git-commit: 5fbcf76e0dfe68578ffa2a8a691cc44cf586ae35
Patch-mainline: v6.15-rc1
References: git-fixes

When `raid1_set_limits()` fails or when the array has no active
`rdev`, the allocated memory for `conf` is not properly freed.

Add raid1_free() call to properly free the conf in error path.

[lduncan: hunk 2 of 3 removed since that code doesn't exist here]
Fixes: 799af947ed13 ("md/raid1: don't free conf on raid0_run failure")
Signed-off-by: Zheng Qixing <zhengqixing@huawei.com>
Link: https://lore.kernel.org/linux-raid/20250215020137.3703757-1-zhengqixing@huaweicloud.com
Singed-off-by: Yu Kuai <yukuai3@huawei.com>
Acked-by: Lee Duncan <lduncan@suse.com>
---
 drivers/md/raid1.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/drivers/md/raid1.c
+++ b/drivers/md/raid1.c
@@ -45,6 +45,7 @@
 
 static void allow_barrier(struct r1conf *conf, sector_t sector_nr);
 static void lower_barrier(struct r1conf *conf, sector_t sector_nr);
+static void raid1_free(struct mddev *mddev, void *priv);
 
 #define RAID_1_10_NAME "raid1"
 #include "raid1-10.c"
@@ -3260,6 +3261,8 @@ static int raid1_run(struct mddev *mddev
 	 */
 	if (conf->raid_disks - mddev->degraded < 1) {
 		md_unregister_thread(mddev, &conf->thread);
+		if (!mddev->private)
+			raid1_free(mddev, conf);
 		return -EINVAL;
 	}
 
