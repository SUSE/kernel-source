From 9d1110f99c253ccef82e480bfe9f38a12eb797a7 Mon Sep 17 00:00:00 2001
From: Li Nan <linan122@huawei.com>
Date: Wed, 17 Jan 2024 11:19:46 +0800
Subject: [PATCH] md: don't account sync_io if iostats of the disk is disabled
Git-commit: 9d1110f99c253ccef82e480bfe9f38a12eb797a7
Patch-mainline: v6.10-rc1
References: git-fixes

If iostats is disabled, disk_stats will not be updated and
part_stat_read_accum() only returns a constant value. In this case,
continuing to count sync_io and to check is_mddev_idle() is no longer
meaningful.

(Coly Li: rebased for Linux 6.4 based SUSE Linux)

Signed-off-by: Li Nan <linan122@huawei.com>
Reviewed-by: Yu Kuai <yukuai3@huawei.com>
Link: https://lore.kernel.org/r/20240117031946.2324519-3-linan666@huaweicloud.com
Signed-off-by: Song Liu <song@kernel.org>
Signed-off-by: Coly Li <colyli@suse.de>

---
 drivers/md/md.c |    4 ++++
 drivers/md/md.h |    3 ++-
 2 files changed, 6 insertions(+), 1 deletion(-)

--- a/drivers/md/md.c
+++ b/drivers/md/md.c
@@ -8578,6 +8578,10 @@ static int is_mddev_idle(struct mddev *m
 	rcu_read_lock();
 	rdev_for_each_rcu(rdev, mddev) {
 		struct gendisk *disk = rdev->bdev->bd_disk;
+
+		if (!init && !blk_queue_io_stat(disk->queue))
+			continue;
+
 		curr_events = (int)part_stat_read_accum(disk->part0, sectors) -
 			      atomic_read(&disk->sync_io);
 		/* sync IO will cause sync_io to increase before the disk_stats
--- a/drivers/md/md.h
+++ b/drivers/md/md.h
@@ -623,7 +623,8 @@ extern void mddev_unlock(struct mddev *m
 
 static inline void md_sync_acct(struct block_device *bdev, unsigned long nr_sectors)
 {
-	atomic_add(nr_sectors, &bdev->bd_disk->sync_io);
+	if (blk_queue_io_stat(bdev->bd_disk->queue))
+		atomic_add(nr_sectors, &bdev->bd_disk->sync_io);
 }
 
 static inline void md_sync_acct_bio(struct bio *bio, unsigned long nr_sectors)
