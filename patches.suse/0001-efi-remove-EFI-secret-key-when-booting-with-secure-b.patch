From 0ce533e033ec748fd340f4cdb859144d530ffd7a Mon Sep 17 00:00:00 2001
From: Chun-Yi Lee <jlee@suse.com>
Date: Mon, 20 Jan 2025 12:57:51 +0800
Subject: [PATCH] efi: remove EFI secret key when booting with secure boot
 disabled.
Patch-mainline: Never, SUSE-specific
References: jsc#PED-1444

EFI secret key is no longer safe when EFI secure boot is disabled. So
we removed the key when EFI stub booting with secure boot disabled.
If user want to use hibernation with secure boot. User should trigger key
re-generate process when secure boot be enabled again.

Signed-off-by: Chun-Yi Lee <jlee@suse.com>
---
 arch/x86/include/asm/efi.h                    |  2 ++
 drivers/firmware/efi/libstub/efi_secret_key.c | 13 +++++++++++++
 drivers/firmware/efi/libstub/x86-stub.c       |  5 +++++
 3 files changed, 20 insertions(+)

diff --git a/arch/x86/include/asm/efi.h b/arch/x86/include/asm/efi.h
index 1c62d2824..41633de2a 100644
--- a/arch/x86/include/asm/efi.h
+++ b/arch/x86/include/asm/efi.h
@@ -174,9 +174,11 @@ extern void parse_efi_setup(u64 phys_addr, u32 data_len);
 #ifdef CONFIG_EFI_SECRET_KEY
 extern void efi_setup_secret_key(struct boot_params *params);
 extern void parse_efi_secret_key_setup(u64 phys_addr, u32 data_len);
+extern void efi_clean_secret_key(void);
 #else
 static inline void efi_setup_secret_key(struct boot_params *params) {}
 static inline void parse_efi_secret_key_setup(u64 phys_addr, u32 data_len) {}
+static inline void efi_clean_secret_key(void) {}
 #endif /* CONFIG_EFI_SECRET_KEY */
 
 extern void efi_thunk_runtime_setup(void);
diff --git a/drivers/firmware/efi/libstub/efi_secret_key.c b/drivers/firmware/efi/libstub/efi_secret_key.c
index 01c59c824..a88425bea 100644
--- a/drivers/firmware/efi/libstub/efi_secret_key.c
+++ b/drivers/firmware/efi/libstub/efi_secret_key.c
@@ -247,3 +247,16 @@ void efi_setup_secret_key(struct boot_params *params)
 	else
 		params->hdr.setup_data = (unsigned long)skey_setup_data;
 }
+
+void efi_clean_secret_key(void)
+{
+	u32 attributes = 0;
+	unsigned long key_size = 0;
+	efi_status_t status;
+
+	/* detect and remove secret key variable */
+	status = get_efi_var(secret_key_name, &EFI_SECRET_GUID,
+			     &attributes, &key_size, NULL);
+	if (status == EFI_BUFFER_TOO_SMALL)
+		remove_secret_key(attributes);
+}
diff --git a/drivers/firmware/efi/libstub/x86-stub.c b/drivers/firmware/efi/libstub/x86-stub.c
index ad8589ab1..286c0490a 100644
--- a/drivers/firmware/efi/libstub/x86-stub.c
+++ b/drivers/firmware/efi/libstub/x86-stub.c
@@ -1040,8 +1040,13 @@ void __noreturn efi_stub_entry(efi_handle_t handle,
 
 	setup_efi_pci(boot_params);
 
+	/* EFI secret key is no longer safe when EFI secure boot is
+	 * disabled. So we removed it. User should trigger key
+	 * re-generate when secure boot be enabled again */
 	if (boot_params->secure_boot == efi_secureboot_mode_enabled)
 		efi_setup_secret_key(boot_params);
+	else
+		efi_clean_secret_key();
 
 	setup_quirks(boot_params);
 
-- 
2.35.3

