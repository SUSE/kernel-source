From 29adc5c2dd7a0e8dba9aac38a3116df38220dc4b Mon Sep 17 00:00:00 2001
From: Alex Deucher <alexander.deucher@amd.com>
Date: Thu, 20 Feb 2025 16:08:02 -0500
Subject: drm/amdgpu/userq: fix hardcoded uq functions
Git-commit: 29adc5c2dd7a0e8dba9aac38a3116df38220dc4b
Patch-mainline: v6.16-rc1
References: jsc#PED-13979 jsc#PED-14039 jsc#PED-14046 jsc#PED-14211 jsc#PED-14333 jsc#PED-14487 jsc#PED-14488 jsc#PED-14497 jsc#PED-14499 jsc#PED-15868

Use the IP type to look up the userq functions rather
than hardcoding it.

Reviewed-by: Saleemkhan Jamadar <saleemkhan.jamadar@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Acked-by: Patrik Jakobsson <pjakobsson@suse.de>

---
 drivers/gpu/drm/amd/amdgpu/amdgpu_userqueue.c | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_userqueue.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_userqueue.c
index f1d4e29772a5..0664e04828c0 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_userqueue.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_userqueue.c
@@ -415,11 +415,11 @@ amdgpu_userqueue_resume_all(struct amdgpu_userq_mgr *uq_mgr)
 	int queue_id;
 	int ret = 0;
 
-	userq_funcs = adev->userq_funcs[AMDGPU_HW_IP_GFX];
-
 	/* Resume all the queues for this process */
-	idr_for_each_entry(&uq_mgr->userq_idr, queue, queue_id)
+	idr_for_each_entry(&uq_mgr->userq_idr, queue, queue_id) {
+		userq_funcs = adev->userq_funcs[queue->queue_type];
 		ret = userq_funcs->resume(uq_mgr, queue);
+	}
 
 	if (ret)
 		DRM_ERROR("Failed to resume all the queue\n");
@@ -570,11 +570,11 @@ amdgpu_userqueue_suspend_all(struct amdgpu_userq_mgr *uq_mgr)
 	int queue_id;
 	int ret = 0;
 
-	userq_funcs = adev->userq_funcs[AMDGPU_HW_IP_GFX];
-
 	/* Try to suspend all the queues in this process ctx */
-	idr_for_each_entry(&uq_mgr->userq_idr, queue, queue_id)
+	idr_for_each_entry(&uq_mgr->userq_idr, queue, queue_id) {
+		userq_funcs = adev->userq_funcs[queue->queue_type];
 		ret += userq_funcs->suspend(uq_mgr, queue);
+	}
 
 	if (ret)
 		DRM_ERROR("Couldn't suspend all the queues\n");
-- 
2.52.0

