From: Eddie James <eajames@linux.ibm.com>
Date: Wed, 25 Sep 2024 10:55:23 -0500
Subject: net/ncsi: Disable the ncsi work before freeing the associated
 structure
Patch-mainline: v6.12-rc2
Git-commit: a0ffa68c70b367358b2672cdab6fa5bc4c40de2c
References: CVE-2024-49945 bsc#1232165

The work function can run after the ncsi device is freed, resulting
in use-after-free bugs or kernel panic.

Fixes: 2d283bdd079c ("net/ncsi: Resource management")
Signed-off-by: Eddie James <eajames@linux.ibm.com>
Link: https://patch.msgid.link/20240925155523.1017097-1-eajames@linux.ibm.com
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 net/ncsi/ncsi-manage.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/net/ncsi/ncsi-manage.c
+++ b/net/ncsi/ncsi-manage.c
@@ -1964,6 +1964,8 @@ void ncsi_unregister_dev(struct ncsi_dev
 	list_del_rcu(&ndp->node);
 	spin_unlock_irqrestore(&ncsi_dev_lock, flags);
 
+	cancel_work_sync(&ndp->work);
+
 	kfree(ndp);
 }
 EXPORT_SYMBOL_GPL(ncsi_unregister_dev);
