From b6a3dc92edb5ad0bf6de8bca70225e68540e15a9 Mon Sep 17 00:00:00 2001
From: Vasant Karasulli <vkarasulli@suse.de>
Date: Fri, 23 Aug 2024 15:00:48 +0200
Subject: [PATCH] iommu/vt-d: Fix NULL domain on device release
Patch-mainline: Never, upstream fix doesn't apply since code has changed
References: bsc#1223742 CVE-2024-27079

In the kdump kernel, the IOMMU operates in deferred_attach mode. In this
mode, info->domain may not yet be assigned by the time the release_device
function is called. It leads to the following crash in the crash kernel:

    BUG: kernel NULL pointer dereference, address: 000000000000003c
    ...
    RIP: 0010:do_raw_spin_lock+0xa/0xa0
    ...
    _raw_spin_lock_irqsave+0x1b/0x30
    intel_iommu_release_device+0x96/0x170
    iommu_deinit_device+0x39/0xf0
    __iommu_group_remove_device+0xa0/0xd0
    iommu_bus_notifier+0x55/0xb0
    notifier_call_chain+0x5a/0xd0
    blocking_notifier_call_chain+0x41/0x60
    bus_notify+0x34/0x50
    device_del+0x269/0x3d0
    pci_remove_bus_device+0x77/0x100
    p2sb_bar+0xae/0x1d0
    ...
    i801_probe+0x423/0x740

Add a null pointer check to avoid the crash.

Fixes: 586081d3f6b1 ("iommu/vt-d: Remove DEFER_DEVICE_DOMAIN_INFO")
Reported-by: Eric Badger <ebadger@purestorage.com>
Suggested-by: Joerg Roedel <jroedel@suse.de>
Signed-off-by: Vasant Karasulli <vkarasulli@suse.de>

---
 drivers/iommu/intel/iommu.c | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/drivers/iommu/intel/iommu.c b/drivers/iommu/intel/iommu.c
index 76883fab2..71b93aa48 100644
--- a/drivers/iommu/intel/iommu.c
+++ b/drivers/iommu/intel/iommu.c
@@ -4107,12 +4107,14 @@ static void dmar_remove_one_dev_info(struct device *dev)
 		intel_pasid_free_table(info->dev);
 	}
 
-	spin_lock_irqsave(&domain->lock, flags);
-	list_del(&info->link);
-	spin_unlock_irqrestore(&domain->lock, flags);
+	if (domain) {
+		spin_lock_irqsave(&domain->lock, flags);
+		list_del(&info->link);
+		spin_unlock_irqrestore(&domain->lock, flags);
 
-	domain_detach_iommu(domain, iommu);
-	info->domain = NULL;
+		domain_detach_iommu(domain, iommu);
+		info->domain = NULL;
+	}
 }
 
 static int md_domain_init(struct dmar_domain *domain, int guest_width)
-- 
2.34.1

