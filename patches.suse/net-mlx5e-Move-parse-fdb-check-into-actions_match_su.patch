From: Roi Dayan <roid@nvidia.com>
Date: Sun, 15 Aug 2021 13:36:01 +0300
Subject: net/mlx5e: Move parse fdb check into actions_match_supported_fdb()
Patch-mainline: v5.16-rc1
Git-commit: d4f401d9ab189b8283e661e57b1ac148bec147fe
References: jsc#SLE-19253

The parse fdb/nic actions funcs parse the actions and then call
actions_match_supported() for final check.
Move related check in parse_tc_fdb_actions() into
actions_match_supported_fdb() for more organized code.

Signed-off-by: Roi Dayan <roid@nvidia.com>
Reviewed-by: Maor Dickman <maord@nvidia.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 drivers/net/ethernet/mellanox/mlx5/core/en_tc.c |   20 +++++++++++---------
 1 file changed, 11 insertions(+), 9 deletions(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
@@ -3177,13 +3177,14 @@ actions_match_supported_fdb(struct mlx5e
 			    struct mlx5e_tc_flow *flow,
 			    struct netlink_ext_ack *extack)
 {
+	struct mlx5_esw_flow_attr *esw_attr = flow->attr->esw_attr;
 	bool ct_flow, ct_clear;
 
 	ct_clear = flow->attr->ct_attr.ct_action & TCA_CT_ACT_CLEAR;
 	ct_flow = flow_flag_test(flow, CT) && !ct_clear;
 
-	if (flow->attr->esw_attr->split_count && ct_flow &&
-	    !MLX5_CAP_GEN(flow->attr->esw_attr->in_mdev, reg_c_preserve)) {
+	if (esw_attr->split_count && ct_flow &&
+	    !MLX5_CAP_GEN(esw_attr->in_mdev, reg_c_preserve)) {
 		/* All registers used by ct are cleared when using
 		 * split rules.
 		 */
@@ -3191,6 +3192,14 @@ actions_match_supported_fdb(struct mlx5e
 		return false;
 	}
 
+	if (esw_attr->split_count > 0 && !mlx5_esw_has_fwd_fdb(priv->mdev)) {
+		NL_SET_ERR_MSG_MOD(extack,
+				   "current firmware doesn't support split rule for port mirroring");
+		netdev_warn_once(priv->netdev,
+				 "current firmware doesn't support split rule for port mirroring\n");
+		return false;
+	}
+
 	return true;
 }
 
@@ -4110,13 +4119,6 @@ static int parse_tc_fdb_actions(struct m
 		return -EOPNOTSUPP;
 	}
 
-	if (esw_attr->split_count > 0 && !mlx5_esw_has_fwd_fdb(priv->mdev)) {
-		NL_SET_ERR_MSG_MOD(extack,
-				   "current firmware doesn't support split rule for port mirroring");
-		netdev_warn_once(priv->netdev, "current firmware doesn't support split rule for port mirroring\n");
-		return -EOPNOTSUPP;
-	}
-
 	/* Allocate sample attribute only when there is a sample action and
 	 * no errors after parsing.
 	 */
