From: Guixin Liu <kanie@linux.alibaba.com>
Date: Wed, 18 Dec 2024 09:42:14 +0800
Subject: [PATCH] scsi: ufs: bsg: Set bsg_queue to NULL after removal
Git-commit: 1e95c798d8a7f70965f0f88d4657b682ff0ec75f
Patch-mainline: v6.14-rc1
References: CVE-2024-54458 bsc#1238992

Currently, this does not cause any issues, but I believe it is necessary to
set bsg_queue to NULL after removing it to prevent potential use-after-free
(UAF) access.

Signed-off-by: Guixin Liu <kanie@linux.alibaba.com>
Link: https://lore.kernel.org/r/20241218014214.64533-3-kanie@linux.alibaba.com
Reviewed-by: Avri Altman <avri.altman@wdc.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: David Sterba <dsterba@suse.com>
---
 drivers/ufs/core/ufs_bsg.c |    1 +
 1 file changed, 1 insertion(+)

--- a/drivers/ufs/core/ufs_bsg.c
+++ b/drivers/ufs/core/ufs_bsg.c
@@ -216,6 +216,7 @@ void ufs_bsg_remove(struct ufs_hba *hba)
 		return;
 
 	bsg_remove_queue(hba->bsg_queue);
+	hba->bsg_queue = NULL;
 
 	device_del(bsg_dev);
 	put_device(bsg_dev);
