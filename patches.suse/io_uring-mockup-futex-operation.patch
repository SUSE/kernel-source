From: Gabriel Krisman Bertazi <krisman@suse.de>
Subject: io_uring: mockup implementation of futex operations
References: bsc#1230569
Patch-mainline: Never, this is a hack

We won't support io_uring futex operations in SLE15-SP7 because it would
require large changes to the futex code.  Nevertheless, operations in
io_uring are numbered sequentially and skipping some number is not
allowed.  Since we need to support newer operations, add a mock up
implementation of OP_FUTEX_{WAIT,WAKE,WAITV} that just returns
-EOPNOTSUPP, but which occupy the respective slots of these operations.

This patch must be dropped if we ever introduce the futex operation to a
SLE15 kernel, or when we upgrade past v6.7.

Signed-off-by: Gabriel Krisman Bertazi <krisman@suse.de>

---
 include/uapi/linux/io_uring.h |    4 +++-
 io_uring/opdef.c              |   18 ++++++++++++++++++
 2 files changed, 21 insertions(+), 1 deletion(-)

--- a/include/uapi/linux/io_uring.h
+++ b/include/uapi/linux/io_uring.h
@@ -244,9 +244,11 @@ enum io_uring_op {
 	IORING_OP_SENDMSG_ZC,
 	IORING_OP_READ_MULTISHOT,
 	IORING_OP_WAITID,
+ 	IORING_OP_FUTEX_WAIT,
+ 	IORING_OP_FUTEX_WAKE,
+ 	IORING_OP_FUTEX_WAITV,
 	IORING_OP_FIXED_FD_INSTALL,
 
-
 	/* this goes last, obviously */
 	IORING_OP_LAST,
 };
--- a/io_uring/opdef.c
+++ b/io_uring/opdef.c
@@ -444,6 +444,15 @@ const struct io_issue_def io_issue_defs[
 		.prep			= io_waitid_prep,
 		.issue			= io_waitid,
 	},
+	[IORING_OP_FUTEX_WAIT] = {
+		.prep			= io_eopnotsupp_prep,
+	},
+	[IORING_OP_FUTEX_WAKE] = {
+		.prep			= io_eopnotsupp_prep,
+	},
+	[IORING_OP_FUTEX_WAITV] = {
+		.prep			= io_eopnotsupp_prep,
+	},
 	[IORING_OP_FIXED_FD_INSTALL] = {
 		.needs_file		= 1,
 		.audit_skip		= 1,
@@ -676,6 +685,15 @@ const struct io_cold_def io_cold_defs[]
 		.name			= "WAITID",
 		.async_size		= sizeof(struct io_waitid_async),
 	},
+	[IORING_OP_FUTEX_WAIT] = {
+		.name			= "FUTEX_WAIT",
+	},
+	[IORING_OP_FUTEX_WAKE] = {
+		.name			= "FUTEX_WAKE",
+	},
+	[IORING_OP_FUTEX_WAITV] = {
+		.name			= "FUTEX_WAITV",
+	},
 	[IORING_OP_FIXED_FD_INSTALL] = {
 		.name			= "FIXED_FD_INSTALL",
 	},
