From: Gregory Price <gourry@gourry.net>
Date: Fri, 13 Sep 2024 19:19:54 -0400
Subject: libstub,tpm: do not ignore failure case when reading final event log
Patch-mainline: v6.13-rc1
Git-commit: 63971b0f51faff0ff844a85d297e27861555c328
References: jsc#PED-12274

Current code fails to check for an error case when reading events
from final event log to calculate offsets.  Check the error case,
and break early because all subsequent calls will also fail.

Signed-off-by: Gregory Price <gourry@gourry.net>
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
Acked-by: Chun-Yi Lee <jlee@suse.com>
---
 drivers/firmware/efi/libstub/tpm.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/drivers/firmware/efi/libstub/tpm.c
+++ b/drivers/firmware/efi/libstub/tpm.c
@@ -124,6 +124,9 @@ static void efi_retrieve_tcg2_eventlog(i
 			event_size = __calc_tpm2_event_size(header,
 						   (void *)(long)log_location,
 						   false);
+			/* If calc fails this is a malformed log */
+			if (!event_size)
+				break;
 			final_events_size += event_size;
 			i--;
 		}
