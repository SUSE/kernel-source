Patch-mainline: Queued in subsystem maintainer repository
Git-repo: https://gitlab.suse.de/coco/tdx/kernel-downstream-suse.git
Git-commit: 2edcf414148bff17c04e96b403b5b04e036fe0b5
References: jsc#PED-6143
From: Isaku Yamahata <isaku.yamahata@intel.com>
Date: Mon, 26 Feb 2024 15:23:57 -0800
Subject: [PATCH 137/155] KVM: TDX: Don't use NO_RBP_MOD for backward
 compatibility

Currently NO_RBP_MOD requires fixes to TDVF and the TDX module.  As
workaround in transition period, don't use NO_RBP_MOD for now.

Signed-off-by: Isaku Yamahata <isaku.yamahata@intel.com>
Signed-off-by: Juergen Gross <jgross@suse.com>
---
 arch/x86/kvm/vmx/tdx.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/arch/x86/kvm/vmx/tdx.c b/arch/x86/kvm/vmx/tdx.c
index cdd15637d6a7..eb9e9216414d 100644
--- a/arch/x86/kvm/vmx/tdx.c
+++ b/arch/x86/kvm/vmx/tdx.c
@@ -2494,7 +2494,7 @@ static int setup_tdparams(struct kvm *kvm, struct td_params *td_params,
 
 	td_params->max_vcpus = kvm->max_vcpus;
 	td_params->attributes = init_vm->attributes;
-	td_params->exec_controls = TDX_CONTROL_FLAG_NO_RBP_MOD;
+	/* td_params->exec_controls = TDX_CONTROL_FLAG_NO_RBP_MOD; */
 	td_params->tsc_frequency = TDX_TSC_KHZ_TO_25MHZ(kvm->arch.default_tsc_khz);
 
 	ret = setup_tdparams_eptp_controls(cpuid, td_params);
@@ -3299,6 +3299,7 @@ static int __init tdx_module_setup(void)
 	 */
 	tdx_info->nr_tdvpx_pages = tdvps_base_size / PAGE_SIZE - 1;
 
+#if 0
 	/*
 	 * Make TDH.VP.ENTER preserve RBP so that the stack unwinder
 	 * always work around it.  Query the feature.
@@ -3309,6 +3310,7 @@ static int __init tdx_module_setup(void)
 		ret = -EOPNOTSUPP;
 		goto error_out;
 	}
+#endif
 
 	return 0;
 
-- 
2.43.0

