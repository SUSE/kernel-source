From: Anthony Iliopoulos <ailiop@suse.com>
Date: Thu, 7 Aug 2025 12:03:26 +0200
Subject: [PATCH] kabi fix for NFSv4: fairly test all delegations on a SEQ4_
 revocation
Patch-mainline: never, kABI fix
References: bsc#1246211

Move the newly introduced member to the end of struct nfs_server, and
hide it from the kABI checker. This should be safe since the struct is
allocated and initialized through nfs_alloc_server().

For the second introduced member in struct nfs_delegation just hide it
from the kABI checker, since this struct is only internally defined and
not really exposed outside NFS code.

Signed-off-by: Anthony Iliopoulos <ailiop@suse.com>
Acked-by: Anthony Iliopoulos <ailiop@suse.com>

---
 fs/nfs/delegation.h       | 2 ++
 include/linux/nfs_fs_sb.h | 2 +-
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/fs/nfs/delegation.h b/fs/nfs/delegation.h
index a6f495d012cf..a7aada1daa92 100644
--- a/fs/nfs/delegation.h
+++ b/fs/nfs/delegation.h
@@ -21,7 +21,9 @@ struct nfs_delegation {
 	fmode_t type;
 	unsigned long pagemod_limit;
 	__u64 change_attr;
+#ifndef __GENKSYMS__
 	unsigned long test_gen;
+#endif
 	unsigned long flags;
 	refcount_t refcount;
 	spinlock_t lock;
diff --git a/include/linux/nfs_fs_sb.h b/include/linux/nfs_fs_sb.h
index 4cc44127b8ab..0c0f9fdb5e2c 100644
--- a/include/linux/nfs_fs_sb.h
+++ b/include/linux/nfs_fs_sb.h
@@ -233,7 +233,6 @@ struct nfs_server {
 	struct list_head	delegations;
 	struct list_head	ss_copies;
 
-	unsigned long		delegation_gen;
 	unsigned long		mig_gen;
 	unsigned long		mig_status;
 #define NFS_MIG_IN_TRANSITION		(1)
@@ -260,6 +259,7 @@ struct nfs_server {
 	bool			has_sec_mnt_opts;
 #ifndef __GENKSYMS__
 	struct list_head	ss_src_copies;
+	unsigned long		delegation_gen;
 #endif
 };
 
-- 
2.50.1

