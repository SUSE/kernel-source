From 0298f51652be47b79780833e0b63194e1231fa34 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Amadeusz=20S=C5=82awi=C5=84ski?= <amadeuszx.slawinski@linux.intel.com>
Date: Thu, 13 Jun 2024 11:01:26 +0200
Subject: [PATCH] ASoC: topology: Fix route memory corruption
Mime-version: 1.0
Content-type: text/plain; charset=UTF-8
Content-transfer-encoding: 8bit
Git-commit: 0298f51652be47b79780833e0b63194e1231fa34
Patch-mainline: v6.10-rc6
References: CVE-2024-41069 bsc#1228644

It was reported that recent fix for memory corruption during topology
load, causes corruption in other cases. Instead of being overeager with
checking topology, assume that it is properly formatted and just
duplicate strings.

Reported-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Closes: https://lore.kernel.org/linux-sound/171812236450.201359.3019210915105428447.b4-ty@kernel.org/T/#m8c4bd5abf453960fde6f826c4b7f84881da63e9d
Suggested-by: Péter Ujfalusi <peter.ujfalusi@linux.intel.com>
Signed-off-by: Amadeusz Sławiński <amadeuszx.slawinski@linux.intel.com>
Link: https://lore.kernel.org/r/20240613090126.841189-1-amadeuszx.slawinski@linux.intel.com
Signed-off-by: Mark Brown <broonie@kernel.org>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 sound/soc/soc-topology.c |   15 +++------------
 1 file changed, 3 insertions(+), 12 deletions(-)

--- a/sound/soc/soc-topology.c
+++ b/sound/soc/soc-topology.c
@@ -1273,14 +1273,8 @@ static int soc_tplg_dapm_graph_elems_loa
 			break;
 		}
 
-		routes[i]->source = devm_kmemdup(tplg->dev, elem->source,
-						 min_t(size_t, strlen(elem->source),
-						       SNDRV_CTL_ELEM_ID_NAME_MAXLEN),
-						 GFP_KERNEL);
-		routes[i]->sink = devm_kmemdup(tplg->dev, elem->sink,
-					       min_t(size_t, strlen(elem->sink),
-						     SNDRV_CTL_ELEM_ID_NAME_MAXLEN),
-					       GFP_KERNEL);
+		routes[i]->source = devm_kstrdup(tplg->dev, elem->source, GFP_KERNEL);
+		routes[i]->sink = devm_kstrdup(tplg->dev, elem->sink, GFP_KERNEL);
 		if (!routes[i]->source || !routes[i]->sink) {
 			ret = -ENOMEM;
 			break;
@@ -1291,10 +1285,7 @@ static int soc_tplg_dapm_graph_elems_loa
 		if (strnlen(elem->control, SNDRV_CTL_ELEM_ID_NAME_MAXLEN) == 0) {
 			routes[i]->control = NULL;
 		} else {
-			routes[i]->control = devm_kmemdup(tplg->dev, elem->control,
-							  min_t(size_t, strlen(elem->control),
-								SNDRV_CTL_ELEM_ID_NAME_MAXLEN),
-							  GFP_KERNEL);
+			routes[i]->control = devm_kstrdup(tplg->dev, elem->control, GFP_KERNEL);
 			if (!routes[i]->control) {
 				ret = -ENOMEM;
 				break;
