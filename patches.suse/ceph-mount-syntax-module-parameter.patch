From: Venky Shankar <vshankar@redhat.com>
Date: Wed, 3 Nov 2021 10:30:39 +0530
Subject: ceph: mount syntax module parameter
Git-commit: adbed05ed62d1f3b6f6c5cb88ec52c1ffafc0fd9
Patch-mainline: v5.17-rc1
References: jsc#SES-1880

Add read-only module parameters for supported mount syntaxes. Primary
user is the user-space mount helper for catching v2 syntax bugs during
testing by cross verifying if the kernel supports v2 syntax on mount
failure.

Signed-off-by: Venky Shankar <vshankar@redhat.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
Acked-by: Luis Henriques <lhenriques@suse.com>
---
 fs/ceph/super.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/fs/ceph/super.c b/fs/ceph/super.c
index 31b5786cd98f..2166fc2c1625 100644
--- a/fs/ceph/super.c
+++ b/fs/ceph/super.c
@@ -1461,6 +1461,14 @@ bool disable_send_metrics = false;
 module_param_cb(disable_send_metrics, &param_ops_metrics, &disable_send_metrics, 0644);
 MODULE_PARM_DESC(disable_send_metrics, "Enable sending perf metrics to ceph cluster (default: on)");
 
+/* for both v1 and v2 syntax */
+static bool mount_support = true;
+static const struct kernel_param_ops param_ops_mount_syntax = {
+	.get = param_get_bool,
+};
+module_param_cb(mount_syntax_v1, &param_ops_mount_syntax, &mount_support, 0444);
+module_param_cb(mount_syntax_v2, &param_ops_mount_syntax, &mount_support, 0444);
+
 module_init(init_ceph);
 module_exit(exit_ceph);
 

