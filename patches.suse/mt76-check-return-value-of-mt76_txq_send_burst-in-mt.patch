From 57b8b57516c5108b0078051a31c68dc9dfcbf68f Mon Sep 17 00:00:00 2001
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Wed, 24 Feb 2021 12:29:34 +0100
Subject: [PATCH] mt76: check return value of mt76_txq_send_burst in
 mt76_txq_schedule_list
Git-commit: 57b8b57516c5108b0078051a31c68dc9dfcbf68f
References: git-fixes
Patch-mainline: v5.13-rc1

Since mt76_txq_send_burst routine can report a negative error code,
check the returned value before incrementing the number of transmitted
frames in mt76_txq_schedule_list routine.
Return -EBUSY directly if the device is in reset or in power management.

Fixes: 90fdc1717b186 ("mt76: use mac80211 txq scheduling")
Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
Signed-off-by: Felix Fietkau <nbd@nbd.name>
Signed-off-by: Oliver Neukum <oneukum@suse.com>
---
 drivers/net/wireless/mediatek/mt76/tx.c |    9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

--- a/drivers/net/wireless/mediatek/mt76/tx.c
+++ b/drivers/net/wireless/mediatek/mt76/tx.c
@@ -513,6 +513,8 @@ mt76_txq_schedule_list(struct mt76_phy *
 
 	spin_lock_bh(&hwq->lock);
 	while (1) {
+		int n_frames = 0;
+
 		if (sq->swq_queued >= 4)
 			break;
 
@@ -543,7 +545,12 @@ mt76_txq_schedule_list(struct mt76_phy *
 			spin_lock_bh(&hwq->lock);
 		}
 
-		ret += mt76_txq_send_burst(phy, sq, mtxq);
+		n_frames = mt76_txq_send_burst(phy, sq, mtxq);
+		if (unlikely(n_frames < 0)) {
+			ret = n_frames;
+			break;
+		}
+		ret += n_frames;
 		ieee80211_return_txq(phy->hw, txq,
 				     !skb_queue_empty(&mtxq->retry_q));
 	}
