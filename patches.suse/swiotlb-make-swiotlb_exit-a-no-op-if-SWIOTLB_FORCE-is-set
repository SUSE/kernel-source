From: Christoph Hellwig <hch@lst.de>
Date: Mon, 14 Feb 2022 10:01:26 +0100
Subject: swiotlb: make swiotlb_exit a no-op if SWIOTLB_FORCE is set
Git-commit: 3469d36d470df148e8d940c1a6399510562bf3b0
Patch-mainline: v5.19-rc1
References: jsc#PED-3259

If force bouncing is enabled we can't release the buffers.

Signed-off-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Anshuman Khandual <anshuman.khandual@arm.com>
Reviewed-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
Tested-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
Acked-by: Joerg Roedel <jroedel@suse.de>
---
 kernel/dma/swiotlb.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/kernel/dma/swiotlb.c
+++ b/kernel/dma/swiotlb.c
@@ -376,6 +376,9 @@ void __init swiotlb_exit(void)
 	unsigned long tbl_vaddr;
 	size_t tbl_size, slots_size;
 
+	if (swiotlb_force == SWIOTLB_FORCE)
+		return;
+
 	if (!mem->nslabs)
 		return;
 
