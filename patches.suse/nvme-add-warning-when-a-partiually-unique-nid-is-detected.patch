From: Hannes Reinecke <hare@kernel.org>
Date: Mon, 14 Apr 2025 11:09:59 +0200
Subject: nvme: Add warning when a partiually unique NID is detected
Patch-mainline: Never, upstream NAKed 
References: bsc#1241148

Some devices have a firmware issue where non-unique value are presented
in some of the NID values. To avoid a failure during booting on these
devices after updating past e2724cb9f0c4 ("nvme: fix the check for duplicate
unique identifiers") issue a warning if these devices are encountered and
set the 'partial_nid' quirk automatically.

Fixes: e2724cb9f0c4 ("nvme: fix the check for duplicate unique identifiers")

Signed-off-by: Hannes Reinecke <hare@kernel.org>
Acked-by: Daniel Wagner <dwagner@suse.de>
---
 drivers/nvme/host/core.c | 24 ++++++++++++++++++++----
 1 file changed, 20 insertions(+), 4 deletions(-)

diff --git a/drivers/nvme/host/core.c b/drivers/nvme/host/core.c
index de25187ea83a..7013de6fa69f 100644
--- a/drivers/nvme/host/core.c
+++ b/drivers/nvme/host/core.c
@@ -3553,8 +3553,16 @@ static int nvme_init_ns_head(struct nvme_ns *ns, struct nvme_ns_info *info)
 	int ret;
 
 	ret = nvme_global_check_duplicate_ids(ctrl->subsys, &info->ids);
-	if (ret == -ENOTUNIQ && ctrl->quirks & NVME_QUIRK_PARTIAL_NID)
-		ret = 0;
+	if (ret == -ENOTUNIQ) {
+		if (!(ctrl->quirks & NVME_QUIRK_PARTIAL_NID)) {
+			dev_warn(ctrl->device,
+				 "Non-unique NID detected, add QUIRK_PARTIAL_NID for '%04x' to avoid this warning\n",
+				 ctrl->subsys->vendor_id);
+			ctrl->quirks |= NVME_QUIRK_PARTIAL_NID;
+		}
+		if (ctrl->quirks & NVME_QUIRK_PARTIAL_NID)
+			ret = 0;
+	}
 	if (ret) {
 		/*
 		 * We've found two different namespaces on two different
@@ -3596,8 +3604,16 @@ static int nvme_init_ns_head(struct nvme_ns *ns, struct nvme_ns_info *info)
 	head = nvme_find_ns_head(ctrl, info->nsid);
 	if (!head) {
 		ret = nvme_subsys_check_duplicate_ids(ctrl->subsys, &info->ids);
-		if (ret == -ENOTUNIQ && ctrl->quirks & NVME_QUIRK_PARTIAL_NID)
-			ret = 0;
+		if (ret == -ENOTUNIQ) {
+			if (!(ctrl->quirks & NVME_QUIRK_PARTIAL_NID)) {
+				dev_warn(ctrl->device,
+					 "Non-unique NID detected, add QUIRK_PARTIAL_NID for '%04x' to avoid this warning\n",
+					 ctrl->subsys->vendor_id);
+				ctrl->quirks |= NVME_QUIRK_PARTIAL_NID;
+			}
+			if (ctrl->quirks & NVME_QUIRK_PARTIAL_NID)
+				ret = 0;
+		}
 		if (ret) {
 			dev_err(ctrl->device,
 				"duplicate IDs in subsystem for nsid %d\n",
-- 
2.35.3

