From a020dccec8686810acfecd1db1de438eb8f95dc1 Mon Sep 17 00:00:00 2001
From: Nicolai Stange <nstange@suse.de>
Date: Tue, 15 Jul 2025 10:15:26 +0200
References: bsc#1241200 bsc#1246134
Patch-mainline: Not yet, tentative fix
Subject: [PATCH] crypto: hkdf - skip TVs with unapproved salt lengths in FIPS
 mode

The HMAC implementation's ->setkey() rejects keys shorter than 112 bits
with -EINVAL in FIPS mode and the hkdf_extract() on test vecs with a salt
length less than that fails accordingly.

Make hkdf_test() to skip over TVs with a salt length less than 112 bits.

Fixes: 3241cd0c6c17 ("crypto,fs: Separate out hkdf_extract() and
       hkdf_expand()")
Suggested-by: Hannes Reinecke <hare@kernel.org>
Signed-off-by: Nicolai Stange <nstange@suse.de>
---
 crypto/hkdf.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- a/crypto/hkdf.c
+++ b/crypto/hkdf.c
@@ -11,6 +11,7 @@
 #include <crypto/sha2.h>
 #include <crypto/hkdf.h>
 #include <linux/module.h>
+#include <linux/fips.h>
 
 /*
  * HKDF consists of two steps:
@@ -490,6 +491,13 @@ static int hkdf_test(const char *shash,
 		goto out_free;
 	}
 
+	if (fips_enabled && tv->salt_size < 112 / 8) {
+		pr_debug("%s(%s): skipped in FIPS mode\n",
+			 tv->test, driver);
+		err = 0;
+		goto out_free;
+	}
+
 	err = hkdf_extract(tfm, tv->ikm, tv->ikm_size,
 			   tv->salt, tv->salt_size, prk);
 	if (err) {
