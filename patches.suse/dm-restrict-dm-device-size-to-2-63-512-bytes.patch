From: Mikulas Patocka <mpatocka@redhat.com>
Date: Fri, 14 Mar 2025 13:51:32 +0100
Subject: dm: restrict dm device size to 2^63-512 bytes
Patch-mainline: v6.15-rc1
Git-commit: 45fc728515c14f53f6205789de5bfd72a95af3b8
References: git-fixes

The devices with size >= 2^63 bytes can't be used reliably by userspace
because the type off_t is a signed 64-bit integer.

Therefore, we limit the maximum size of a device mapper device to
2^63-512 bytes.

Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Acked-by: Martin Wilck <mwilck@suse.com>
---
 drivers/md/dm-table.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/drivers/md/dm-table.c
+++ b/drivers/md/dm-table.c
@@ -668,6 +668,10 @@ int dm_table_add_target(struct dm_table
 		DMERR("%s: zero-length target", dm_device_name(t->md));
 		return -EINVAL;
 	}
+	if (start + len < start || start + len > LLONG_MAX >> SECTOR_SHIFT) {
+		DMERR("%s: too large device", dm_device_name(t->md));
+		return -EINVAL;
+	}
 
 	ti->type = dm_get_target_type(type);
 	if (!ti->type) {
