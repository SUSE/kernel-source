From 17a1eab7b70d85fc5711f37bb6e530b771736bb7 Mon Sep 17 00:00:00 2001
From: Takashi Iwai <tiwai@suse.de>
Date: Sun, 20 Aug 2023 19:26:35 +0200
Subject: [PATCH] ALSA: hda/tas2781: Fix PM refcount unbalance at tas2781_hda_bind()
Git-commit: 17a1eab7b70d85fc5711f37bb6e530b771736bb7
Patch-mainline: v6.6-rc1
References: jsc#PED-6045 jsc#PED-6036 jsc#PED-6104 jsc#PED-6114 jsc#PED-6067 jsc#PED-6123

The error path of tas2781_hda_bind() needs to release PM refcount as
well.  Modify the code flow to handle properly.

Fixes: 5be27f1e3ec9 ("ALSA: hda/tas2781: Add tas2781 HDA driver")
Reported-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Closes: https://lore.kernel.org/r/9f910785-e856-1539-e3e4-c9817af5fe67@linux.intel.com
Link: https://lore.kernel.org/r/20230820172635.22236-2-tiwai@suse.de
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 sound/pci/hda/tas2781_hda_i2c.c | 8 +++-----
 1 file changed, 3 insertions(+), 5 deletions(-)

diff --git a/sound/pci/hda/tas2781_hda_i2c.c b/sound/pci/hda/tas2781_hda_i2c.c
index 0968ae915fd0..aa9ce3837336 100644
--- a/sound/pci/hda/tas2781_hda_i2c.c
+++ b/sound/pci/hda/tas2781_hda_i2c.c
@@ -608,15 +608,13 @@ static int tas2781_hda_bind(struct device *dev, struct device *master,
 	strscpy(comps->name, dev_name(dev), sizeof(comps->name));
 
 	ret = tascodec_init(tas_priv, codec, tasdev_fw_ready);
-	if (ret)
-		return ret;
-
-	comps->playback_hook = tas2781_hda_playback_hook;
+	if (!ret)
+		comps->playback_hook = tas2781_hda_playback_hook;
 
 	pm_runtime_mark_last_busy(dev);
 	pm_runtime_put_autosuspend(dev);
 
-	return 0;
+	return ret;
 }
 
 static void tas2781_hda_unbind(struct device *dev,
-- 
2.35.3

