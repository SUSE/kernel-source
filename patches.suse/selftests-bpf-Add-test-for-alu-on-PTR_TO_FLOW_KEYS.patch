From: Hao Sun <sunhao.th@gmail.com>
Date: Mon, 15 Jan 2024 09:20:28 +0100
Subject: selftests/bpf: Add test for alu on PTR_TO_FLOW_KEYS
Patch-mainline: v6.8-rc1
Git-commit: 33772ff3b887eb2f426ed66bcb1808837a40669c
References: bsc#1220255 CVE-2024-26589

Add a test case for PTR_TO_FLOW_KEYS alu. Testing if alu with variable
offset on flow_keys is rejected. For the fixed offset success case, we
already have C code coverage to verify (e.g. via bpf_flow.c).

Signed-off-by: Hao Sun <sunhao.th@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Yonghong Song <yonghong.song@linux.dev>
Link: https://lore.kernel.org/bpf/20240115082028.9992-2-sunhao.th@gmail.com
Acked-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
---
 tools/testing/selftests/bpf/verifier/value_illegal_alu.c |   17 +++++++++++++++
 1 file changed, 17 insertions(+)

--- a/tools/testing/selftests/bpf/verifier/value_illegal_alu.c
+++ b/tools/testing/selftests/bpf/verifier/value_illegal_alu.c
@@ -93,3 +93,20 @@
 	.result = REJECT,
 	.flags = F_NEEDS_EFFICIENT_UNALIGNED_ACCESS,
 },
+{
+	"flow_keys illegal alu op with variable offset",
+	.insns = {
+	BPF_MOV64_REG(BPF_REG_6, BPF_REG_1),
+	BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, offsetof(struct __sk_buff, flow_keys)),
+	BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_6, 0),
+	BPF_MOV64_IMM(BPF_REG_8, 8),
+	BPF_ALU64_IMM(BPF_DIV, BPF_REG_8, 1),
+	BPF_ALU64_IMM(BPF_AND, BPF_REG_8, 8),
+	BPF_ALU64_REG(BPF_ADD, BPF_REG_7, BPF_REG_8),
+	BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_7, 0),
+	BPF_EXIT_INSN(),
+	},
+	.fixup_map_hash_48b = { 3 },
+	.errstr = "R7 pointer arithmetic on flow_keys prohibited",
+	.result = REJECT,
+},
