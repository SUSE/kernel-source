From: Johannes Wikner <kwikner@ethz.ch>
Date: Tue, 8 Oct 2024 12:58:03 +0200
Subject: x86/bugs: Do not use UNTRAIN_RET with IBPB on entry
Git-commit: c62fa117c32bd1abed9304c58e0da6940f8c7fc2
Patch-mainline: v6.12-rc4
References: git-fixes

Since X86_FEATURE_ENTRY_IBPB will invalidate all harmful predictions
with IBPB, no software-based untraining of returns is needed anymore.
Currently, this change affects retbleed and SRSO mitigations so if
either of the mitigations is doing IBPB and the other one does the
software sequence, the latter is not needed anymore.

  [ bp: Massage commit message. ]

Suggested-by: Borislav Petkov <bp@alien8.de>
Signed-off-by: Johannes Wikner <kwikner@ethz.ch>
Cc: <stable@kernel.org>

Acked-by: Nikolay Borisov <nik.borisov@suse.com>
---
 arch/x86/kernel/cpu/bugs.c |   17 +++++++++++++++++
 1 file changed, 17 insertions(+)

--- a/arch/x86/kernel/cpu/bugs.c
+++ b/arch/x86/kernel/cpu/bugs.c
@@ -1051,6 +1051,15 @@ do_cmd_auto:
 	case RETBLEED_MITIGATION_IBPB:
 retbleed_force_ibpb:
 		setup_force_cpu_cap(X86_FEATURE_ENTRY_IBPB);
+
+		/*
+		 * IBPB on entry already obviates the need for
+		 * software-based untraining so clear those in case some
+		 * other mitigation like SRSO has selected them.
+		 */
+		setup_clear_cpu_cap(X86_FEATURE_UNRET);
+		setup_clear_cpu_cap(X86_FEATURE_RETHUNK);
+
 		setup_force_cpu_cap(X86_FEATURE_IBPB_ON_VMEXIT);
 		mitigate_smt = true;
 
@@ -2526,6 +2535,14 @@ static void __init srso_select_mitigatio
 		if (has_microcode) {
 			setup_force_cpu_cap(X86_FEATURE_ENTRY_IBPB);
 			srso_mitigation = SRSO_MITIGATION_IBPB;
+
+			/*
+			 * IBPB on entry already obviates the need for
+			 * software-based untraining so clear those in case some
+			 * other mitigation like Retbleed has selected them.
+			 */
+			setup_clear_cpu_cap(X86_FEATURE_UNRET);
+			setup_clear_cpu_cap(X86_FEATURE_RETHUNK);
 		}
 		break;
 
