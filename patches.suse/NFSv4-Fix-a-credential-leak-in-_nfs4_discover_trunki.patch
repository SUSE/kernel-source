From: Trond Myklebust <trond.myklebust@hammerspace.com>
Date: Thu, 27 Oct 2022 16:50:12 -0400
Subject: [PATCH] NFSv4: Fix a credential leak in _nfs4_discover_trunking()
Git-commit: e83458fce080dc23c25353a1af90bfecf79c7369
Patch-mainline: v6.2
References: git-fixes

Fixes: 4f40a5b55446 ("NFSv4: Add an fattr allocation to _nfs4_discover_trunking()")
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Acked-by: NeilBrown <neilb@suse.com>

---
 fs/nfs/nfs4proc.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/fs/nfs/nfs4proc.c
+++ b/fs/nfs/nfs4proc.c
@@ -3997,7 +3997,7 @@ static int _nfs4_discover_trunking(struc
 
 	page = alloc_page(GFP_KERNEL);
 	if (!page)
-		return -ENOMEM;
+		goto out_put_cred;
 	locations = kmalloc(sizeof(struct nfs4_fs_locations), GFP_KERNEL);
 	if (!locations)
 		goto out_free;
@@ -4015,6 +4015,8 @@ out_free_2:
 	kfree(locations);
 out_free:
 	__free_page(page);
+out_put_cred:
+	put_cred(cred);
 	return status;
 }
 
