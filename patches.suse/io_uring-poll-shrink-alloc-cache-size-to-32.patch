From da22bdf38be2f2ba557d3031108614ebbba265e1 Mon Sep 17 00:00:00 2001
From: Jens Axboe <axboe@kernel.dk>
Date: Thu, 21 Mar 2024 07:53:07 -0600
Subject: [PATCH] io_uring/poll: shrink alloc cache size to 32
Git-commit: da22bdf38be2f2ba557d3031108614ebbba265e1
Patch-mainline: v6.10-rc1
References: bsc#1230569

This should be plenty, rather than the default of 128, and matches what
we have on the rsrc and futex side as well.

Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Gabriel Krisman Bertazi <krisman@suse.de>
---
 io_uring/io_uring.c |    2 +-
 io_uring/poll.h     |    2 ++
 2 files changed, 3 insertions(+), 1 deletion(-)

--- a/io_uring/io_uring.c
+++ b/io_uring/io_uring.c
@@ -313,7 +313,7 @@ static __cold struct io_ring_ctx *io_rin
 	INIT_HLIST_HEAD(&ctx->io_buf_list);
 	ret = io_alloc_cache_init(&ctx->rsrc_node_cache, IO_NODE_ALLOC_CACHE_MAX,
 			    sizeof(struct io_rsrc_node));
-	ret |= io_alloc_cache_init(&ctx->apoll_cache, IO_ALLOC_CACHE_MAX,
+	ret |= io_alloc_cache_init(&ctx->apoll_cache, IO_POLL_ALLOC_CACHE_MAX,
 			    sizeof(struct async_poll));
 	ret |= io_alloc_cache_init(&ctx->netmsg_cache, IO_ALLOC_CACHE_MAX,
 			    sizeof(struct io_async_msghdr));
--- a/io_uring/poll.h
+++ b/io_uring/poll.h
@@ -1,5 +1,7 @@
 // SPDX-License-Identifier: GPL-2.0
 
+#define IO_POLL_ALLOC_CACHE_MAX 32
+
 enum {
 	IO_APOLL_OK,
 	IO_APOLL_ABORTED,
