From: Jiri Slaby <jslaby@suse.cz>
Date: Tue, 26 Nov 2024 04:28:27 +0100
Subject: Revert "tpm: Disable TPM on tpm2_create_primary() failure"
References: bsc#1233752
Patch-mainline: never, temporary workaround

This reverts commit 423893fcbe7e9adc875bce4e55b9b25fc1424977.

Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 drivers/char/tpm/tpm2-sessions.c | 7 ++-----
 1 file changed, 2 insertions(+), 5 deletions(-)

diff --git a/drivers/char/tpm/tpm2-sessions.c b/drivers/char/tpm/tpm2-sessions.c
index b0f13c8ea79c..52d3523042fb 100644
--- a/drivers/char/tpm/tpm2-sessions.c
+++ b/drivers/char/tpm/tpm2-sessions.c
@@ -953,13 +953,10 @@ static int tpm2_load_null(struct tpm_chip *chip, u32 *null_key)
 	/* Deduce from the name change TPM interference: */
 	dev_err(&chip->dev, "null key integrity check failed\n");
 	tpm2_flush_context(chip, tmp_null_key);
+	chip->flags |= TPM_CHIP_FLAG_DISABLE;
 
 err:
-	if (rc) {
-		chip->flags |= TPM_CHIP_FLAG_DISABLE;
-		rc = -ENODEV;
-	}
-	return rc;
+	return rc ? -ENODEV : 0;
 }
 
 /**
-- 
2.47.0

