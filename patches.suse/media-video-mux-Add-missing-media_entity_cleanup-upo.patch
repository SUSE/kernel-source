From ad5929547b545f6335f7a65cd5dd978967a02be3 Mon Sep 17 00:00:00 2001
From: Alexander Stein <alexander.stein@ew.tq-group.com>
Date: Tue, 2 May 2023 16:15:43 +0200
Subject: [PATCH] media: video-mux: Add missing media_entity_cleanup upon async
 register fail
Git-commit: ad5929547b545f6335f7a65cd5dd978967a02be3
References: jsc#PED-8643
Patch-mainline: v6.5-rc1

Although media_entity_pads_init has been called, a call to
media_entity_cleanup in the cleanup code was missing.

Signed-off-by: Alexander Stein <alexander.stein@ew.tq-group.com>
Signed-off-by: Sakari Ailus <sakari.ailus@linux.intel.com>
Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
Signed-off-by: Oliver Neukum <oneukum@suse.com>

---
 drivers/media/platform/video-mux.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/media/platform/video-mux.c b/drivers/media/platform/video-mux.c
index 1d9f32e5a917..b244873d593a 100644
--- a/drivers/media/platform/video-mux.c
+++ b/drivers/media/platform/video-mux.c
@@ -474,6 +474,7 @@ static int video_mux_probe(struct platform_device *pdev)
 
 	ret = video_mux_async_register(vmux, num_pads - 1);
 	if (ret) {
+		media_entity_cleanup(&vmux->subdev.entity);
 		v4l2_async_nf_unregister(&vmux->notifier);
 		v4l2_async_nf_cleanup(&vmux->notifier);
 	}
-- 
2.45.2

