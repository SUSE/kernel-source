From: Jiri Pirko <jiri@nvidia.com>
Date: Tue, 8 Aug 2023 10:20:20 +0200
Subject: devlink: clear flag on port register error path
Patch-mainline: v6.6-rc1
Git-commit: 832140804e3b3ad19d73adebd25f69ed98778c58
References: jsc#PED-3311

When xarray insertion fails, clear the flag.

Signed-off-by: Jiri Pirko <jiri@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: https://lore.kernel.org/r/20230808082020.1363497-1-jiri@resnulli.us
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 net/devlink/leftover.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/net/devlink/leftover.c
+++ b/net/devlink/leftover.c
@@ -6832,8 +6832,10 @@ int devl_port_register_with_ops(struct d
 	spin_lock_init(&devlink_port->type_lock);
 	INIT_LIST_HEAD(&devlink_port->reporter_list);
 	err = xa_insert(&devlink->ports, port_index, devlink_port, GFP_KERNEL);
-	if (err)
+	if (err) {
+		devlink_port->registered = false;
 		return err;
+	}
 
 	INIT_DELAYED_WORK(&devlink_port->type_warn_dw, &devlink_port_type_warn);
 	devlink_port_type_warn_schedule(devlink_port);
