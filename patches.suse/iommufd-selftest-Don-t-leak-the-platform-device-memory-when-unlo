From: Yang Yingliang <yangyingliang@huawei.com>
Date: Wed, 16 Aug 2023 16:13:18 +0800
Subject: iommufd/selftest: Don't leak the platform device memory when
 unloading the module
Git-commit: eb501c2d96cfce6b42528e8321ea085ec605e790
Patch-mainline: v6.6-rc1
References: jsc#PED-7779 jsc#PED-7780

It should call platform_device_unregister() instead of
platform_device_del() to unregister and free the device.

Fixes: 23a1b46f15d5 ("iommufd/selftest: Make the mock iommu driver into a real driver")
Link: https://lore.kernel.org/r/20230816081318.1232865-1-yangyingliang@huawei.com
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Reviewed-by: Kevin Tian <kevin.tian@intel.com>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Acked-by: Joerg Roedel <jroedel@suse.de>
---
 drivers/iommu/iommufd/selftest.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/iommu/iommufd/selftest.c b/drivers/iommu/iommufd/selftest.c
index 90e7c5400282..56506d5753f1 100644
--- a/drivers/iommu/iommufd/selftest.c
+++ b/drivers/iommu/iommufd/selftest.c
@@ -1089,7 +1089,7 @@ int __init iommufd_test_init(void)
 err_bus:
 	bus_unregister(&iommufd_mock_bus_type.bus);
 err_platform:
-	platform_device_del(selftest_iommu_dev);
+	platform_device_unregister(selftest_iommu_dev);
 err_dbgfs:
 	debugfs_remove_recursive(dbgfs_root);
 	return rc;
@@ -1102,6 +1102,6 @@ void iommufd_test_exit(void)
 				    &iommufd_mock_bus_type.bus,
 				    &iommufd_mock_bus_type.nb);
 	bus_unregister(&iommufd_mock_bus_type.bus);
-	platform_device_del(selftest_iommu_dev);
+	platform_device_unregister(selftest_iommu_dev);
 	debugfs_remove_recursive(dbgfs_root);
 }

