From: Giovanni Gherdovich <ggherdovich@suse.cz>
Date: Fri, 29 Nov 2024 01:32:27 +0100
Subject: cpufreq/amd-pstate: Default to "powersave" governor when in "active mode" on servers
Patch-mainline: never, upstream prefers keeping Intel and AMD CPUs operate with different defaults
References: jsc#PED-11639

On intel_pstate with HWP, the default governor is "powersave". Adopt the same
default on amd-pstate active, for consistency across the x86_64 architecture.

amd-pstate in active mode, just like intel_pstate with HWP, is controlled by
the value of the Energy Performance Preference parameter (EPP).
Yet the concept of "frequency governor", familiar to users and system
administrators, is maintained: the available governors are "performance" and
"powersave". In the context of autonomous (hardware-driven) frequency scaling,
on both Intel HWP and amd-pstate active, the "performance" governor always
maps to EPP=0, while the "powersave" governor maps to the EPP value found at
power-on, set by the firmware, which generally is 128.

In Linux upstream, AMD engineers decided to differentiate between server and
mobile CPUs: the server ones default to the "performance" governor (EPP=0),
the rest defaults to the "powersave" governor (generally EPP=128).
On the contrary, all Intel CPUs with HWP default to the "powersave" governor
(again, EPP=128). In my estimation this inconsistency between vendors is
undesirable and will disorient SLES users. More over, this is a matter of
policy and as such falls within the scope of the SLES distribution to resolve.

In the email exchange linked below, amd-pstate maintainer Mario Limonciello
proposed to AMD performance engineer Gautham Shenoy to remove the difference
in default policy between AMD servers and AMD laptops/mobile parts, defaulting
both to "powersave". Gautham Shenoy replied that he prefers to keep the
difference as it is, indicating that upstream is uninterested in this patch,
that remains out of tree for the time being.
https://lore.kernel.org/linux-pm/Zxcz7RiUxhETNYNM@BLRRASHENOY1.amd.com/

Signed-off-by: Giovanni Gherdovich <ggherdovich@suse.cz>
---
 drivers/cpufreq/amd-pstate.c | 8 ++------
 1 file changed, 2 insertions(+), 6 deletions(-)

diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
index b63863f77c67..fbbf2362bf70 100644
--- a/drivers/cpufreq/amd-pstate.c
+++ b/drivers/cpufreq/amd-pstate.c
@@ -1464,14 +1464,10 @@ static int amd_pstate_epp_cpu_init(struct cpufreq_policy *policy)
 	policy->boost_enabled = READ_ONCE(cpudata->boost_supported);
 
 	/*
-	 * Set the policy to provide a valid fallback value in case
+	 * Set the policy to powersave to provide a valid fallback value in case
 	 * the default cpufreq governor is neither powersave nor performance.
 	 */
-	if (amd_pstate_acpi_pm_profile_server() ||
-	    amd_pstate_acpi_pm_profile_undefined())
-		policy->policy = CPUFREQ_POLICY_PERFORMANCE;
-	else
-		policy->policy = CPUFREQ_POLICY_POWERSAVE;
+	policy->policy = CPUFREQ_POLICY_POWERSAVE;
 
 	if (cpu_feature_enabled(X86_FEATURE_CPPC)) {
 		ret = rdmsrl_on_cpu(cpudata->cpu, MSR_AMD_CPPC_REQ, &value);
-- 
2.43.0

