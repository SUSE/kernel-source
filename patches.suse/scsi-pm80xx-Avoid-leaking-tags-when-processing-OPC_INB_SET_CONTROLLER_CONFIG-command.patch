From: Michal Grzedzicki <mge@meta.com>
Date: Mon, 11 Sep 2023 10:03:40 -0700
Subject: scsi: pm80xx: Avoid leaking tags when processing
 OPC_INB_SET_CONTROLLER_CONFIG command
Git-commit: c13e7331745852d0dd7c35eabbe181cbd5b01172
Patch-mainline: v6.6-rc2
References: bsc#1220883 cve-2023-52500

Tags allocated for OPC_INB_SET_CONTROLLER_CONFIG command need to be freed
when we receive the response.

Signed-off-by: Michal Grzedzicki <mge@meta.com>
Link: https://lore.kernel.org/r/20230911170340.699533-2-mge@meta.com
Acked-by: Jack Wang <jinpu.wang@ionos.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Acked-by: Lee Duncan <lduncan@suse.com>
---
 drivers/scsi/pm8001/pm80xx_hwi.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/drivers/scsi/pm8001/pm80xx_hwi.c
+++ b/drivers/scsi/pm8001/pm80xx_hwi.c
@@ -3418,10 +3418,12 @@ static int mpi_set_controller_config_res
 			(struct set_ctrl_cfg_resp *)(piomb + 4);
 	u32 status = le32_to_cpu(pPayload->status);
 	u32 err_qlfr_pgcd = le32_to_cpu(pPayload->err_qlfr_pgcd);
+	u32 tag = le32_to_cpu(pPayload->tag);
 
 	PM8001_MSG_DBG(pm8001_ha, pm8001_printk(
 			"SET CONTROLLER RESP: status 0x%x qlfr_pgcd 0x%x\n",
 			status, err_qlfr_pgcd));
+	pm8001_tag_free(pm8001_ha, tag);
 
 	return 0;
 }
