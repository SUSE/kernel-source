From 67484e0de9c93b4a9187bb49f45dfdaa8dc03c0b Mon Sep 17 00:00:00 2001
From: Christophe Leroy <christophe.leroy@csgroup.eu>
Date: Fri, 21 Jan 2022 08:06:27 +0000
Subject: [PATCH] powerpc/lib/sstep: Use l1_dcache_bytes() instead of
 opencoding

References: bsc#1194869
Patch-mainline: v5.18-rc1
Git-commit: 67484e0de9c93b4a9187bb49f45dfdaa8dc03c0b

Don't opencode dcache size retrieval based on whether that's ppc32 or ppc64.

Use l1_dcache_bytes()

Signed-off-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/6c608fd4795e2d8ea1a0a449405a0087f76d8bb3.1642752375.git.christophe.leroy@csgroup.eu
Acked-by: Michal Suchanek <msuchanek@suse.de>
---
 arch/powerpc/lib/sstep.c | 5 +----
 1 file changed, 1 insertion(+), 4 deletions(-)

diff --git a/arch/powerpc/lib/sstep.c b/arch/powerpc/lib/sstep.c
index a94b0cd0bdc5..b7316d697d80 100644
--- a/arch/powerpc/lib/sstep.c
+++ b/arch/powerpc/lib/sstep.c
@@ -1065,14 +1065,11 @@ static int __emulate_dcbz(unsigned long ea)
 int emulate_dcbz(unsigned long ea, struct pt_regs *regs)
 {
 	int err;
-	unsigned long size;
+	unsigned long size = l1_dcache_bytes();
 
 #ifdef __powerpc64__
-	size = ppc64_caches.l1d.block_size;
 	if (!(regs->msr & MSR_64BIT))
 		ea &= 0xffffffffUL;
-#else
-	size = L1_CACHE_BYTES;
 #endif
 	ea &= ~(size - 1);
 	if (!address_ok(regs, ea, size))
-- 
2.44.0

