From 9f6d4b8d149af8dc3f9a1e3000168b99ca576390 Mon Sep 17 00:00:00 2001
From: Xin Deng <quic_deng@quicinc.com>
Date: Fri, 26 Apr 2024 02:25:01 -0700
Subject: [PATCH] wifi: cfg80211: Clear mlo_links info when STA disconnects
Git-commit: 9f6d4b8d149af8dc3f9a1e3000168b99ca576390
Patch-mainline: v6.10-rc1
References: jsc#PED-10412

wdev->valid_links is not cleared when upper layer disconnect from a
wdev->AP MLD. It has been observed that this would prevent offchannel
operations like remain-on-channel which would be needed for user space
operations with Public Action frame.
Clear the wdev->valid_links when STA disconnects.

Signed-off-by: Xin Deng <quic_deng@quicinc.com>
Link: https://msgid.link/20240426092501.8592-1-quic_deng@quicinc.com
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 net/wireless/sme.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/net/wireless/sme.c b/net/wireless/sme.c
index 82e3ce42206c..a8ad55f11133 100644
--- a/net/wireless/sme.c
+++ b/net/wireless/sme.c
@@ -1353,6 +1353,7 @@ void __cfg80211_disconnected(struct net_device *dev, const u8 *ie,
 		return;
 
 	cfg80211_wdev_release_bsses(wdev);
+	wdev->valid_links = 0;
 	wdev->connected = false;
 	wdev->u.client.ssid_len = 0;
 	wdev->conn_owner_nlportid = 0;
-- 
2.43.0

