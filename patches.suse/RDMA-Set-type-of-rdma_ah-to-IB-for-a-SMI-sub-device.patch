From: Mark Zhang <markzhang@nvidia.com>
Date: Sun, 16 Jun 2024 19:08:37 +0300
Subject: RDMA: Set type of rdma_ah to IB for a SMI sub device
Patch-mainline: v6.11-rc1
Git-commit: 36e97bbc2dca61751c5b4b7f248cd850a7654a19
References: jsc#PED-9900 jsc#PED-11429

An address handle created on a SMI port has type IB, as a SMI
port it's used for SMI management through umad.

Signed-off-by: Mark Zhang <markzhang@nvidia.com>
Link: https://lore.kernel.org/r/195be77aae0cce93522269f22f1303d2ccbef605.1718553901.git.leon@kernel.org
Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 include/rdma/ib_verbs.h |    2 ++
 1 file changed, 2 insertions(+)

--- a/include/rdma/ib_verbs.h
+++ b/include/rdma/ib_verbs.h
@@ -4662,6 +4662,8 @@ static inline enum rdma_ah_attr_type rdm
 			return RDMA_AH_ATTR_TYPE_OPA;
 		return RDMA_AH_ATTR_TYPE_IB;
 	}
+	if (dev->type == RDMA_DEVICE_TYPE_SMI)
+		return RDMA_AH_ATTR_TYPE_IB;
 
 	return RDMA_AH_ATTR_TYPE_UNDEFINED;
 }
