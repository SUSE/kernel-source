From: Yuan Chen <chenyuan@kylinos.cn>
Date: Tue, 17 Jun 2025 09:24:42 -0400
Subject: bpftool: Fix JSON writer resource leak in version command
Patch-mainline: v6.17-rc1
Git-commit: 85cd83fed8267cde0dd1cea719808aad95ae4de7
References: git-fixes

When using `bpftool --version -j/-p`, the JSON writer object
created in do_version() was not properly destroyed after use.
This caused a memory leak each time the version command was
executed with JSON output.

Fix: 004b45c0e51a (tools: bpftool: provide JSON output for all possible commands)

Suggested-by: Quentin Monnet <qmo@kernel.org>
Signed-off-by: Yuan Chen <chenyuan@kylinos.cn>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Reviewed-by: Quentin Monnet <qmo@kernel.org>
Link: https://lore.kernel.org/bpf/20250617132442.9998-1-chenyuan_fl@163.com
Acked-by: Hoyeon Lee <hoyeon.lee@suse.com>
---
 tools/bpf/bpftool/main.c |    6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

--- a/tools/bpf/bpftool/main.c
+++ b/tools/bpf/bpftool/main.c
@@ -534,9 +534,9 @@ int main(int argc, char **argv)
 		usage();
 
 	if (version_requested)
-		return do_version(argc, argv);
-
-	ret = cmd_select(commands, argc, argv, do_help);
+		ret = do_version(argc, argv);
+	else
+		ret = cmd_select(commands, argc, argv, do_help);
 
 	if (json_output)
 		jsonw_destroy(&json_wtr);
