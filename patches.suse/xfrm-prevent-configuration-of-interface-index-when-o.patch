From: Leon Romanovsky <leonro@nvidia.com>
Date: Tue, 13 May 2025 13:59:19 +0300
Subject: xfrm: prevent configuration of interface index when offload is used
Patch-mainline: v6.16-rc1
Git-commit: c82b48b63a939e9b0f40bd00f95bcea4502fcada
References: jsc#PED-14197

Both packet and crypto offloads perform decryption while packet is
arriving to the HW from the wire. It means that there is no possible
way to perform lookup on XFRM if_id as it can't be set to be "before' HW.

So instead of silently ignore this configuration, let's warn users about
misconfiguration.

Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 net/xfrm/xfrm_device.c |    5 +++++
 1 file changed, 5 insertions(+)

--- a/net/xfrm/xfrm_device.c
+++ b/net/xfrm/xfrm_device.c
@@ -249,6 +249,11 @@ int xfrm_dev_state_add(struct net *net,
 		return -EINVAL;
 	}
 
+	if (xuo->flags & XFRM_OFFLOAD_INBOUND && x->if_id) {
+		NL_SET_ERR_MSG(extack, "XFRM if_id is not supported in RX path");
+		return -EINVAL;
+	}
+
 	is_packet_offload = xuo->flags & XFRM_OFFLOAD_PACKET;
 
 	/* We don't yet support TFC padding. */
