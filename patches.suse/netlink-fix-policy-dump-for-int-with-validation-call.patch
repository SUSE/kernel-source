From: Jakub Kicinski <kuba@kernel.org>
Date: Fri, 9 May 2025 14:27:51 -0700
Subject: netlink: fix policy dump for int with validation callback
Patch-mainline: v6.16-rc1
Git-commit: a96876057b9e44f60d936f8e4887543555b0593c
References: jsc#PED-12745

Recent devlink change added validation of an integer value
via NLA_POLICY_VALIDATE_FN, for sparse enums. Handle this
in policy dump. We can't extract any info out of the callback,
so report only the type.

Fixes: 429ac6211494 ("devlink: define enum for attr types of dynamic attributes")
Reported-by: syzbot+01eb26848144516e7f0a@syzkaller.appspotmail.com
Link: https://patch.msgid.link/20250509212751.1905149-1-kuba@kernel.org
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 include/net/netlink.h |    6 ++++++
 net/netlink/policy.c  |    5 +++++
 2 files changed, 11 insertions(+)

--- a/include/net/netlink.h
+++ b/include/net/netlink.h
@@ -318,7 +318,13 @@ enum nla_policy_validation {
  *    All other            Unused - but note that it's a union
  *
  * Meaning of `validate' field, use via NLA_POLICY_VALIDATE_FN:
+ *    NLA_U8, NLA_U16,
+ *    NLA_U32, NLA_U64,
+ *    NLA_S8, NLA_S16,
+ *    NLA_S32, NLA_S64,
+ *    NLA_MSECS,
  *    NLA_BINARY           Validation function called for the attribute.
+ *
  *    All other            Unused - but note that it's a union
  *
  * Example:
--- a/net/netlink/policy.c
+++ b/net/netlink/policy.c
@@ -310,6 +310,8 @@ __netlink_policy_dump_write_attr(struct
 					      NL_POLICY_TYPE_ATTR_PAD))
 				goto nla_put_failure;
 			break;
+		} else if (pt->validation_type == NLA_VALIDATE_FUNCTION) {
+			break;
 		}
 
 		nla_get_range_unsigned(pt, &range);
@@ -339,6 +341,9 @@ __netlink_policy_dump_write_attr(struct
 		else
 			type = NL_ATTR_TYPE_SINT;
 
+		if (pt->validation_type == NLA_VALIDATE_FUNCTION)
+			break;
+
 		nla_get_range_signed(pt, &range);
 
 		if (nla_put_s64(skb, NL_POLICY_TYPE_ATTR_MIN_VALUE_S,
