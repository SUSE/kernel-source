From caea35c54d06d9ef617ab41297e95749b7778197 Mon Sep 17 00:00:00 2001
From: Michal Wajdeczko <michal.wajdeczko@intel.com>
Date: Wed, 19 Jun 2024 23:45:53 +0200
Subject: drm/xe/vf: Don't initialize OA if VF
Git-commit: 5aa326f52872b25906d7dca8e0c4f7e6c597f40f
Patch-mainline: v6.11-rc1
References: jsc#PED-9898 jsc#PED-10191 jsc#PED-10197 jsc#PED-10226 jsc#PED-10237 jsc#PED-10340 jsc#PED-10852 jsc#PED-11022

We don't support Observation Architecture on the VF device.

Signed-off-by: Michal Wajdeczko <michal.wajdeczko@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Cc: Ashutosh Dixit <ashutosh.dixit@intel.com>
Reviewed-by: Ashutosh Dixit <ashutosh.dixit@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20240619214557.905-6-michal.wajdeczko@intel.com
Acked-by: Patrik Jakobsson <pjakobsson@suse.de>
---
 drivers/gpu/drm/xe/xe_oa.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/drivers/gpu/drm/xe/xe_oa.c b/drivers/gpu/drm/xe/xe_oa.c
index eaa5fe5fd75b..4168b51cf7b5 100644
--- a/drivers/gpu/drm/xe/xe_oa.c
+++ b/drivers/gpu/drm/xe/xe_oa.c
@@ -35,6 +35,7 @@
 #include "xe_perf.h"
 #include "xe_pm.h"
 #include "xe_sched_job.h"
+#include "xe_sriov.h"
 
 #define DEFAULT_POLL_FREQUENCY_HZ 200
 #define DEFAULT_POLL_PERIOD_NS (NSEC_PER_SEC / DEFAULT_POLL_FREQUENCY_HZ)
@@ -2388,6 +2389,9 @@ int xe_oa_init(struct xe_device *xe)
 	if (!xe_device_uc_enabled(xe) || GRAPHICS_VER(xe) < 12)
 		return 0;
 
+	if (IS_SRIOV_VF(xe))
+		return 0;
+
 	oa->xe = xe;
 	oa->oa_formats = oa_formats;
 
-- 
2.46.1

