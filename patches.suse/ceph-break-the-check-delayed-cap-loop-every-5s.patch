From: Xiubo Li <xiubli@redhat.com>
Date: Wed, 17 Jan 2024 12:42:11 +0800
Subject: ceph: break the check delayed cap loop every 5s
Git-commit: 09927e7ef11fe65a9cc38b6f74a9d6dba31c8c25
Patch-mainline: v6.9-rc1
References: bsc#1226022

In some cases this may take a long time and will block renewing
the caps to MDS.

[ idryomov: massage comment ]

Link: https://tracker.ceph.com/issues/50223#note-21
Signed-off-by: Xiubo Li <xiubli@redhat.com>
Reviewed-by: Ilya Dryomov <idryomov@gmail.com>
Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
Acked-by: Luis Henriques <lhenriques@suse.de>
---
 fs/ceph/caps.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- a/fs/ceph/caps.c
+++ b/fs/ceph/caps.c
@@ -4507,6 +4507,14 @@ unsigned long ceph_check_delayed_caps(st
 			iput(inode);
 			spin_lock(&mdsc->cap_delay_lock);
 		}
+
+		/*
+		 * Make sure too many dirty caps or general
+		 * slowness doesn't block mdsc delayed work,
+		 * preventing send_renew_caps() from running.
+		 */
+		if (jiffies - loop_start >= 5 * HZ)
+			break;
 	}
 	spin_unlock(&mdsc->cap_delay_lock);
 
