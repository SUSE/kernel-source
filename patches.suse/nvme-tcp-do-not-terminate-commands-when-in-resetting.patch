From: Hannes Reinecke <hare@suse.de>
Date: Wed, 23 Aug 2023 13:44:18 +0200
Subject: nvme-tcp: Do not terminate commands when in RESETTING
Patch-mainline: Not yet, TP is not yet released
References: bsc#1201284

When the error recovery started it will terminate all commands
anyway, so we should just return BLK_EH_RESET_TIMER for a
command timeout.

Signed-off-by: Hannes Reinecke <hare@suse.de>
Acked-by: Daniel Wagner <dwagner@suse.de>
---
 drivers/nvme/host/tcp.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- a/drivers/nvme/host/tcp.c
+++ b/drivers/nvme/host/tcp.c
@@ -2521,6 +2521,14 @@ static enum blk_eh_timer_return nvme_tcp
 		 rq->tag, nvme_cid(rq), pdu->hdr.type, cmd->common.opcode,
 		 nvme_fabrics_opcode_str(qid, cmd), qid);
 
+	/*
+	 * If the error recovery is started all commands will be
+	 * aborted anyway, and nothing is to be done here.
+	 */
+	if (nvme_ctrl_state(ctrl) == NVME_CTRL_RESETTING &&
+	          work_pending(&to_tcp_ctrl(ctrl)->err_work))
+	              return BLK_EH_RESET_TIMER;
+
 	if (nvme_ctrl_state(ctrl) != NVME_CTRL_LIVE) {
 		/*
 		 * If we are resetting, connecting or deleting we should
