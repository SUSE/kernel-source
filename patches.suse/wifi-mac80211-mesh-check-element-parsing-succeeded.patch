From 1fc4a3eec50d726f4663ad3c0bb0158354d6647a Mon Sep 17 00:00:00 2001
From: Johannes Berg <johannes.berg@intel.com>
Date: Mon, 11 Dec 2023 09:05:32 +0200
Subject: [PATCH] wifi: mac80211: mesh: check element parsing succeeded
Git-commit: 1fc4a3eec50d726f4663ad3c0bb0158354d6647a
Patch-mainline: v6.7-rc7
References: git-fixes

ieee802_11_parse_elems() can return NULL, so we must
check for the return value.

Fixes: 5d24828d05f3 ("mac80211: always allocate struct ieee802_11_elems")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Miri Korenblit <miriam.rachel.korenblit@intel.com>
Link: https://msgid.link/20231211085121.93dea364f3d3.Ie87781c6c48979fb25a744b90af4a33dc2d83a28@changeid
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 net/mac80211/mesh_plink.c |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

--- a/net/mac80211/mesh_plink.c
+++ b/net/mac80211/mesh_plink.c
@@ -1230,6 +1230,8 @@ void mesh_rx_plink_frame(struct ieee8021
 	}
 	elems = ieee802_11_parse_elems(baseaddr, len - baselen, true,
 				       mgmt->bssid, NULL);
-	mesh_process_plink_frame(sdata, mgmt, elems, rx_status);
-	kfree(elems);
+	if (elems) {
+		mesh_process_plink_frame(sdata, mgmt, elems, rx_status);
+		kfree(elems);
+	}
 }
