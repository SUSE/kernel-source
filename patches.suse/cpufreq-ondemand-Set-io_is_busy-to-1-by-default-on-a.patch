From: Giovanni Gherdovich <ggherdovich@suse.cz>
Date: Tue, 3 Jun 2025 14:59:28 +0200
Subject: cpufreq/ondemand: Set io_is_busy to 1 by default on all platforms
Patch-mainline: never, upstream favors power efficiency over performance
References: bsc#1233975

io_is_busy is a cpufreq sysfs tunable specifying if iowait time should
be counted as active CPU time for frequency scaling calculations.
Setting it to 1 doesn't regress the dbench benchmark (see below) and is
expected to be beneficial for I/O workloads with considerable iowait time.

  dbench, latency vs number of clients, lower is better:

			   SLE-16-Beta4            SLE-16-Beta4+patch
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
  SubAmean          1      30.28  ( 0.00%)         29.89   ( 1.31%)
  SubAmean          4      38.55  ( 0.00%)         39.08  ( -1.38%)
  SubAmean          7      46.02  ( 0.00%)         46.92  ( -1.94%)
  SubAmean         12      58.79  ( 0.00%)         58.71   ( 0.13%)
  SubAmean         21      85.37  ( 0.00%)         83.73   ( 1.91%)
  SubAmean         30     123.05  ( 0.00%)        124.46  ( -1.14%)
  SubAmean         48     203.99  ( 0.00%)        204.36  ( -0.18%)
  SubAmean         79     369.19  ( 0.00%)        369.54  ( -0.10%)
  SubAmean        110     581.46  ( 0.00%)        582.94  ( -0.26%)
  SubAmean        141     759.40  ( 0.00%)        756.56   ( 0.37%)
  SubAmean        160     868.24  ( 0.00%)        861.86   ( 0.73%)

Upstream sets io_is_busy to 1 on Intel, and 0 elsewhere (notably AMD).
The rationale in 2010 was that older AMD platforms would consume
more power when idling after running at high clock:
https://lore.kernel.org/lkml/20100423083828.GA1573@ucw.cz/

---
 drivers/cpufreq/cpufreq_ondemand.c | 25 +------------------------
 1 file changed, 1 insertion(+), 24 deletions(-)

diff --git a/drivers/cpufreq/cpufreq_ondemand.c b/drivers/cpufreq/cpufreq_ondemand.c
index 2b128454de330..2e645b5f1f54c 100644
--- a/drivers/cpufreq/cpufreq_ondemand.c
+++ b/drivers/cpufreq/cpufreq_ondemand.c
@@ -29,29 +29,6 @@ static struct od_ops od_ops;
 
 static unsigned int default_powersave_bias;
 
-/*
- * Not all CPUs want IO time to be accounted as busy; this depends on how
- * efficient idling at a higher frequency/voltage is.
- * Pavel Machek says this is not so for various generations of AMD and old
- * Intel systems.
- * Mike Chan (android.com) claims this is also not true for ARM.
- * Because of this, whitelist specific known (series) of CPUs by default, and
- * leave all others up to the user.
- */
-static int should_io_be_busy(void)
-{
-#if defined(CONFIG_X86)
-	/*
-	 * For Intel, Core 2 (model 15) and later have an efficient idle.
-	 */
-	if (boot_cpu_data.x86_vendor == X86_VENDOR_INTEL &&
-			boot_cpu_data.x86 == 6 &&
-			boot_cpu_data.x86_model >= 15)
-		return 1;
-#endif
-	return 0;
-}
-
 /*
  * Find right freq to be set now with powersave_bias on.
  * Returns the freq_hi to be used right now and will set freq_hi_delay_us,
@@ -376,7 +353,7 @@ static int od_init(struct dbs_data *dbs_data)
 	dbs_data->sampling_down_factor = DEF_SAMPLING_DOWN_FACTOR;
 	dbs_data->ignore_nice_load = 0;
 	tuners->powersave_bias = default_powersave_bias;
-	dbs_data->io_is_busy = should_io_be_busy();
+	dbs_data->io_is_busy = 1;
 
 	dbs_data->tuners = tuners;
 	return 0;
-- 
2.43.0

