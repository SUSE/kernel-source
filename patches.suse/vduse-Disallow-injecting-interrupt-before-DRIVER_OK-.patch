From: Xie Yongji <xieyongji@bytedance.com>
Date: Thu, 23 Sep 2021 15:57:22 +0800
Subject: vduse: Disallow injecting interrupt before DRIVER_OK is set
Patch-mainline: v5.15
Git-commit: 1394103fd72ce9c67d20f882a93d59403c8da057
References: jsc#PED-1549

The interrupt callback should not be triggered before DRIVER_OK
is set. Otherwise, it might break the virtio device driver.
So let's add a check to avoid the unexpected behavior.

Fixes: c8a6153b6c59 ("vduse: Introduce VDUSE - vDPA Device in Userspace")
Signed-off-by: Xie Yongji <xieyongji@bytedance.com>
Link: https://lore.kernel.org/r/20210923075722.98-1-xieyongji@bytedance.com
Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 drivers/vdpa/vdpa_user/vduse_dev.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- a/drivers/vdpa/vdpa_user/vduse_dev.c
+++ b/drivers/vdpa/vdpa_user/vduse_dev.c
@@ -966,6 +966,10 @@ static long vduse_dev_ioctl(struct file
 		break;
 	}
 	case VDUSE_DEV_INJECT_CONFIG_IRQ:
+		ret = -EINVAL;
+		if (!(dev->status & VIRTIO_CONFIG_S_DRIVER_OK))
+			break;
+
 		ret = 0;
 		queue_work(vduse_irq_wq, &dev->inject);
 		break;
@@ -1045,6 +1049,10 @@ static long vduse_dev_ioctl(struct file
 	case VDUSE_VQ_INJECT_IRQ: {
 		u32 index;
 
+		ret = -EINVAL;
+		if (!(dev->status & VIRTIO_CONFIG_S_DRIVER_OK))
+			break;
+
 		ret = -EFAULT;
 		if (get_user(index, (u32 __user *)argp))
 			break;
