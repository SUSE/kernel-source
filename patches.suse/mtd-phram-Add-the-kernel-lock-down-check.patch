From: Takashi Iwai <tiwai@suse.de>
Date: Thu, 14 Nov 2024 16:44:41 +0100
Subject: mtd: phram: Add the kernel lock down check
Patch-mainline: v6.14-rc1
Git-commit: b3c782868ecebd0c1661a6aa2bdc84cd3cbb1ef3
References: bsc#1232649

The phram MTD driver may map any memory pages no matter whether it's
reserved or whatever used for systems, which basically allows user
bypassing the lock down.

Add the check and abort the probe if the kernel is locked down for
LOCKDOWN_DEV_MEM.

Reported-by: Fabian Vogt <fvogt@suse.com>
Suggested-by: Fabian Vogt <fvogt@suse.com>
Signed-off-by: Takashi Iwai <tiwai@suse.de>
Acked-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Miquel Raynal <miquel.raynal@bootlin.com>
Acked-by: Chun-Yi Lee <jlee@suse.com>
---
 drivers/mtd/devices/phram.c |    5 +++++
 1 file changed, 5 insertions(+)

--- a/drivers/mtd/devices/phram.c
+++ b/drivers/mtd/devices/phram.c
@@ -26,6 +26,7 @@
 #include <linux/moduleparam.h>
 #include <linux/slab.h>
 #include <linux/mtd/mtd.h>
+#include <linux/security.h>
 
 struct phram_mtd_list {
 	struct mtd_info mtd;
@@ -305,6 +306,10 @@ static int __init init_phram(void)
 {
 	int ret = 0;
 
+	ret = security_locked_down(LOCKDOWN_DEV_MEM);
+	if (ret)
+		return ret;
+
 #ifndef MODULE
 	if (phram_paramline[0])
 		ret = phram_setup(phram_paramline);
