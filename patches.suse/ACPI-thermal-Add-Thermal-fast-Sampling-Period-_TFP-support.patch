From: Jeff Brasen <jbrasen@nvidia.com>
Date: Fri, 10 Nov 2023 00:03:21 +0530
Subject: ACPI: thermal: Add Thermal fast Sampling Period (_TFP) support
Git-commit: a2ee7581afd59015b8f9ae01fad131aed9f26f01
Patch-mainline: v6.7 or v6.7-rc9 (next release)
References: bsc#1214377

Add support of "Thermal fast Sampling Period (_TFP)" for passive
cooling.

As per the ACPI specification (ACPI 6.5, Section 11.4.17 "_TFP (Thermal
fast Sampling Period)", _TFP overrides _TSP ("Thermal Sampling Period"
if both are present in a Thermal zone.

Signed-off-by: Jeff Brasen <jbrasen@nvidia.com>
Co-developed-by: Sumit Gupta <sumitg@nvidia.com>
Signed-off-by: Sumit Gupta <sumitg@nvidia.com>
[ rjw: Changelog edits ]
Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Acked-by: Ivan T. Ivanov <iivanov@suse.de>
---
 drivers/acpi/thermal.c |   22 +++++++++++++++-------
 1 file changed, 15 insertions(+), 7 deletions(-)

--- a/drivers/acpi/thermal.c
+++ b/drivers/acpi/thermal.c
@@ -134,7 +134,7 @@ struct acpi_thermal_passive {
 	unsigned long temperature;
 	unsigned long tc1;
 	unsigned long tc2;
-	unsigned long tsp;
+	unsigned long delay;
 	struct acpi_handle_list devices;
 };
 
@@ -361,13 +361,21 @@ static int acpi_thermal_trips_update(str
 					tz->trips.passive.flags.valid = 0;
 				else
 					tz->trips.passive.tc2 = tmp;
+
 				status = acpi_evaluate_integer(
-						tz->device->handle, "_TSP",
+						tz->device->handle, "_TFP",
 						NULL, &tmp);
-				if (ACPI_FAILURE(status))
-					tz->trips.passive.flags.valid = 0;
-				else
-					tz->trips.passive.tsp = tmp;
+				if (ACPI_SUCCESS(status)) {
+					tz->trips.passive.delay = tmp;
+				} else {
+					status = acpi_evaluate_integer(
+							tz->device->handle, "_TSP",
+							NULL, &tmp);
+					if (ACPI_FAILURE(status))
+						tz->trips.passive.flags.valid = 0;
+					else
+						tz->trips.passive.delay = tmp * 100;
+				}
 			}
 		}
 	}
@@ -809,7 +817,7 @@ static int acpi_thermal_register_thermal
 		tz->thermal_zone =
 			thermal_zone_device_register("acpitz", trips, 0, tz,
 						&acpi_thermal_zone_ops, NULL,
-						     tz->trips.passive.tsp*100,
+						     tz->trips.passive.delay,
 						     tz->polling_frequency*100);
 	else
 		tz->thermal_zone =
