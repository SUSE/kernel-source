From: Ming Lei <ming.lei@redhat.com>
Date: Tue, 8 Mar 2022 06:51:48 +0100
Subject: [PATCH] blk-mq: handle already freed tags gracefully in
 blk_mq_free_rqs
Git-commit: e02657ea7b86d1c41e095f49e4f7c7bb24bbee64
Patch-mainline: v5.18-rc1
References: jsc#PED-1183

To simplify further changes allow for double calling blk_mq_free_rqs on
a queue.

Signed-off-by: Ming Lei <ming.lei@redhat.com>
[hch: split out from a larger patch]
Signed-off-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Bart Van Assche <bvanassche@acm.org>
Reviewed-by: Martin K. Petersen <martin.petersen@oracle.com>
Link: https://lore.kernel.org/r/20220308055200.735835-3-hch@lst.de
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Hannes Reinecke <hare@suse.com>
---
 block/blk-mq.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/block/blk-mq.c b/block/blk-mq.c
index 40f634ab7026..f7ef8e2ab935 100644
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@ -3071,6 +3071,9 @@ void blk_mq_free_rqs(struct blk_mq_tag_set *set, struct blk_mq_tags *tags,
 	struct blk_mq_tags *drv_tags;
 	struct page *page;
 
+	if (list_empty(&tags->page_list))
+		return;
+
 	if (blk_mq_is_shared_tags(set->flags))
 		drv_tags = set->shared_tags;
 	else
-- 
2.35.3

