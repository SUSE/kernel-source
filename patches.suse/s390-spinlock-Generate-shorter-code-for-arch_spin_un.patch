From 1200f216a3043ad78e89ce1f573fe6d62ed5e5d0 Mon Sep 17 00:00:00 2001
From: Heiko Carstens <hca@linux.ibm.com>
Date: Tue, 26 Nov 2024 14:28:25 +0100
Subject: [PATCH] s390/spinlock: Generate shorter code for arch_spin_unlock()
Git-commit: 1200f216a3043ad78e89ce1f573fe6d62ed5e5d0
Patch-mainline: v6.13-rc1
References: bsc#1257818

Use mvhhi instead of sth to write a zero to spinlocks. Compared to the
sth variant this avoids the load of zero to a register, and reduces
register pressure.

Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Jiri Wiesner <jwiesner@suse.de>
---
 arch/s390/include/asm/spinlock.h | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/s390/include/asm/spinlock.h b/arch/s390/include/asm/spinlock.h
index 9601e27d3291..f87dd0a84855 100644
--- a/arch/s390/include/asm/spinlock.h
+++ b/arch/s390/include/asm/spinlock.h
@@ -82,9 +82,9 @@ static inline void arch_spin_unlock(arch_spinlock_t *lp)
 	kcsan_release();
 	asm_inline volatile(
 		ALTERNATIVE("nop", ".insn rre,0xb2fa0000,7,0", ALT_FACILITY(49)) /* NIAI 7 */
-		"	sth	%[zero],%[lock]\n"
-		: [lock] "=R" (((unsigned short *)&lp->lock)[1])
-		: [zero] "d" (0)
+		"	mvhhi	%[lock],0\n"
+		: [lock] "=Q" (((unsigned short *)&lp->lock)[1])
+		:
 		: "memory");
 }
 
-- 
2.51.0

