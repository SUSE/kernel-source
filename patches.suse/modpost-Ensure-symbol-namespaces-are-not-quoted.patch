From a63cb9b1661f039513975a35163d70817b08180a Mon Sep 17 00:00:00 2001
From: Petr Pavlu <petr.pavlu@suse.com>
Date: Thu, 19 Feb 2026 13:37:17 +0100
Subject: [PATCH] modpost: Ensure exported symbol namespaces are not quoted
Patch-mainline: Never, SUSE-specific
References: bsc#1258489

The upstream commit cdd30ebb1b9f ("module: Convert symbol namespace to
string literal") modified the namespace parameters used by
MODULE_IMPORT_NS() and EXPORT_SYMBOL_NS*() to be directly string literals.

This commit has not been backported SL-16.0/1 to avoid API/ABI changes.
Consequently, when backporting newer patches that use these macros and
employ the new format, each such patch must be manually adjusted to remove
the quotes. If this adjustment is not made, the code may compile without
errors but the recorded namespace will be incorrectly quoted, resulting in
runtime errors.

To catch this issue during build time, add a check in modpost to ensure
that the import_ns and export_symbol data contain only unquoted namespaces.

Signed-off-by: Petr Pavlu <petr.pavlu@suse.com>
---
 scripts/mod/modpost.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/scripts/mod/modpost.c b/scripts/mod/modpost.c
index e970323bc08f6..54f06afd9ed68 100644
--- a/scripts/mod/modpost.c
+++ b/scripts/mod/modpost.c
@@ -1100,6 +1100,10 @@ static void check_export_symbol(struct module *mod, struct elf_info *elf,
 	}
 
 	data += strlen(data) + 1;	/* namespace */
+	if (data[0] == '"')
+		error("%s: %s: EXPORT_SYMBOL_NS used with a quoted namespace '%s'. Remove the quotes.\n",
+		      mod->name, name, data);
+
 	s = sym_add_exported(name, mod, is_gpl, data);
 
 	/*
@@ -1716,6 +1720,10 @@ static void read_symbols(const char *modname)
 
 		namespace = get_modinfo(&info, "import_ns");
 		while (namespace) {
+			if (namespace[0] == '"')
+				error("%s: MODULE_IMPORT_NS used with a quoted namespace '%s'. Remove the quotes.\n",
+				      mod->name, namespace);
+
 			add_namespace(&mod->imported_namespaces, namespace);
 			namespace = get_next_modinfo(&info, "import_ns",
 						     namespace);
-- 
2.53.0

