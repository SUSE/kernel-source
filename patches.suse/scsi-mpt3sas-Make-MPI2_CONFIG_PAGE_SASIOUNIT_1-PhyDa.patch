From: James Seo <james@equiv.tech>
Date: Sun, 6 Aug 2023 10:05:57 -0700
Subject: scsi: mpt3sas: Make MPI2_CONFIG_PAGE_SASIOUNIT_1::PhyData[] a
 flexible array
Patch-mainline: v6.8-rc1
Git-commit: e249a957ce43b7da365ea0bddbeaec04e4cc3ad0
References: bsc#1219551

This terminal 1-length variable array can be directly converted into a C99
flexible array member.

As all users of MPI2_CONFIG_PAGE_SASIOUNIT_1 (Mpi2SasIOUnitPage1_t) either
calculate its size without depending on its sizeof() or do not use
PhyData[], no further source changes are required:

 - mpt3sas_config.c:mpt3sas_config_get_sas_iounit_pg1() fetches a
   Mpi2SasIOUnitPage1_t into a caller-provided buffer, and may fetch and
   write PhyData[] into that buffer depending on its sz argument.  Its
   callers:

   - mpt3sas_base.c:_base_assign_fw_reported_qd() passes
     sizeof(Mpi2SasIOUnitPage1_t) as sz, but does not use PhyData[].

   - mpt3sas_base.c:mpt3sas_base_update_missing_delay(),
     mpt3sas_scsih.c:_scsih_sas_host_add(),
     mpt3sas_transport.c:_transport_phy_enable(), and
     mpt3sas_transport.c:_transport_phy_speed() all calculate sz
     independently of sizeof(Mpi2SasIOUnitPage1_t) and allocate a
     suitable buffer before calling mpt3sas_config_get_sas_iounit_pg1()
     and using PhyData[].

 - mpt3sas_config.c:mpt3sas_config_set_sas_iounit_pg1() writes the contents
   of a caller-provided buffer to the adapter, with the size of the write
   depending on its sz argument. Its callers:

   - mpt3sas_base.c:mpt3sas_base_update_missing_delay(),
     mpt3sas_transport.c:_transport_phy_enable(), and
     mpt3sas_transport.c:_transport_phy_speed() have all previously
     called mpt3sas_config_get_sas_iounit_pg1() to obtain a
     Mpi2SasIOUnitPage1_t, and are merely writing back this same
     struct with the same previously calculated sz.

Signed-off-by: James Seo <james@equiv.tech>
Link: https://lore.kernel.org/r/20230806170604.16143-6-james@equiv.tech
Tested-by: Borislav Petkov (AMD) <bp@alien8.de>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Acked-by: Martin Wilck <mwilck@suse.com>
---
 drivers/scsi/mpt3sas/mpi/mpi2_cnfg.h |    9 +++------
 1 file changed, 3 insertions(+), 6 deletions(-)

--- a/drivers/scsi/mpt3sas/mpi/mpi2_cnfg.h
+++ b/drivers/scsi/mpt3sas/mpi/mpi2_cnfg.h
@@ -2249,12 +2249,9 @@ typedef struct _MPI2_SAS_IO_UNIT1_PHY_DA
 	*pMpi2SasIOUnit1PhyData_t;
 
 /*
- *Host code (drivers, BIOS, utilities, etc.) should leave this define set to
- *one and check the value returned for NumPhys at runtime.
+ *Host code (drivers, BIOS, utilities, etc.) should check the value returned
+ *for NumPhys at runtime before using PhyData[].
  */
-#ifndef MPI2_SAS_IOUNIT1_PHY_MAX
-#define MPI2_SAS_IOUNIT1_PHY_MAX        (1)
-#endif
 
 typedef struct _MPI2_CONFIG_PAGE_SASIOUNIT_1 {
 	MPI2_CONFIG_EXTENDED_PAGE_HEADER    Header; /*0x00 */
@@ -2275,7 +2272,7 @@ typedef struct _MPI2_CONFIG_PAGE_SASIOUN
 	U8
 		IODeviceMissingDelay;               /*0x13 */
 	MPI2_SAS_IO_UNIT1_PHY_DATA
-		PhyData[MPI2_SAS_IOUNIT1_PHY_MAX];  /*0x14 */
+		PhyData[];                          /*0x14 */
 } MPI2_CONFIG_PAGE_SASIOUNIT_1,
 	*PTR_MPI2_CONFIG_PAGE_SASIOUNIT_1,
 	Mpi2SasIOUnitPage1_t, *pMpi2SasIOUnitPage1_t;
