From: Christoph Hellwig <hch@lst.de>
Date: Tue, 4 Jun 2024 19:25:28 +0200
Subject: md/raid0: don't free conf on raid0_run failure
Git-commit: 35f20acaa3585f25f8356da0ee6bc143e0256522
Alt-commit: d11854ed05635e4a73fa61a988ffdd0978c9e202
Patch-mainline: v6.11-rc1
References: git-fixes

The core md code calls the ->free method which already frees conf.

[lduncan: hunk1 fuzz=1, hunk 2 not needed, hunk 3 applied by hand]

Fixes: 0c031fd37f69 ("md: Move alloc/free acct bioset in to personality")
Signed-off-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: https://lore.kernel.org/r/20240604172607.3185916-2-hch@lst.de

Acked-by: Lee Duncan <lduncan@suse.com>
---
 drivers/md/raid0.c |   17 ++++-------------
 1 file changed, 4 insertions(+), 13 deletions(-)

--- a/drivers/md/raid0.c
+++ b/drivers/md/raid0.c
@@ -365,18 +365,13 @@ static sector_t raid0_size(struct mddev
 	return array_sectors;
 }
 
-static void free_conf(struct mddev *mddev, struct r0conf *conf)
-{
-	kfree(conf->strip_zone);
-	kfree(conf->devlist);
-	kfree(conf);
-}
-
 static void raid0_free(struct mddev *mddev, void *priv)
 {
 	struct r0conf *conf = priv;
 
-	free_conf(mddev, conf);
+	kfree(conf->strip_zone);
+	kfree(conf->devlist);
+	kfree(conf);
 }
 
 static int raid0_run(struct mddev *mddev)
@@ -424,11 +419,7 @@ static int raid0_run(struct mddev *mddev
 
 	dump_zones(mddev);
 
-	ret = md_integrity_register(mddev);
-	if (ret)
-		free_conf(mddev, conf);
-
-	return ret;
+	return md_integrity_register(mddev);
 }
 
 /*
