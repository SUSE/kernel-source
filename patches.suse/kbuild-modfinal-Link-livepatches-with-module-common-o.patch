From: Petr Mladek <pmladek@suse.com>
Date: Tue, 21 Oct 2025 14:04:30 +0200
Subject: kbuild/modfinal: Link livepatches with module-common.o
Patch-mainline: Not yet, on review <20231106162513.17556-1-lhruska@suse.cz>
References: bsc#1218644, bsc#1252270

The patch ("kbuild/modpost: integrate klp-convert") added extra rules
for building livepatch modules. They need an update after the upstream
commit fdf94e4403ece60b29e ("kbuild: compile constant module information
only once") added in 6.12-rc1.

In particular, also the livepatch modules need to get linked with the new
module_common.o which provides some static information, e.g. "retpoline"
and "vermagic" modinfo. The change is the same as the above mentioned
commit did for the "%.ko:" target.

The missing modinfo causes the following warnings:

[    2.529721] [    T614] livepatch_1_1: bad vermagic: kernel tainted.
[    2.529920] [    T614] Disabling lock debugging due to kernel taint
[    2.531488] [    T614] Spectre V2 : System may be vulnerable to spectre v2
[    2.531673] [    T614] livepatch_1_1: loading module not compiled with retpoline compiler.

Signed-off-by: Petr Mladek <pmladek@suse.com>
---
 scripts/Makefile.modfinal |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/scripts/Makefile.modfinal
+++ b/scripts/Makefile.modfinal
@@ -69,7 +69,7 @@ targets += $(modules:%.o=%.ko) $(modules
 # Livepatch
 # ---------------------------------------------------------------------------
 
-%.tmp.ko: %.o %.mod.o FORCE
+%.tmp.ko: %.o %.mod.o $(extmod_prefix).module-common.o FORCE
 	+$(call if_changed,ld_ko_o)
 
 quiet_cmd_klp_convert = KLP     $@
