From: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
Date: Tue, 13 Feb 2024 18:22:08 -0800
Subject: x86/entry_32: Add VERW just before userspace transition
Git-commit: a0e2dab44d22b913b4c228c8b52b2a104434b0b3
Patch-mainline: v6.8-rc6
References: git-fixes

As done for entry_64, add support for executing VERW late in exit to
user path for 32-bit mode.

Cc:  <stable@kernel.org>
Signed-off-by: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
Acked-by: Nikolay Borisov <nik.borisov@suse.com>
---
 arch/x86/entry/entry_32.S | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/arch/x86/entry/entry_32.S b/arch/x86/entry/entry_32.S
index 1b0fe4b49ea0..d3a814efbff6 100644
--- a/arch/x86/entry/entry_32.S
+++ b/arch/x86/entry/entry_32.S
@@ -881,6 +881,7 @@ SYM_FUNC_START(entry_SYSENTER_32)
 	BUG_IF_WRONG_CR3 no_user_check=1
 	popfl
 	popl	%eax
+	CLEAR_CPU_BUFFERS

 	/*
 	 * Return back to the vDSO, which will pop ecx and edx.
@@ -950,6 +951,7 @@ SYM_FUNC_START(entry_INT80_32)

 	/* Restore user state */
 	RESTORE_REGS pop=4			# skip orig_eax/error_code
+	CLEAR_CPU_BUFFERS
 .Lirq_return:
 	/*
 	 * ARCH_HAS_MEMBARRIER_SYNC_CORE rely on IRET core serialization
@@ -1142,6 +1144,7 @@ SYM_CODE_START(asm_exc_nmi)

 	/* Not on SYSENTER stack. */
 	call	exc_nmi
+	CLEAR_CPU_BUFFERS
 	jmp	.Lnmi_return

 .Lnmi_from_sysenter_stack:

