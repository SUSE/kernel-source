From: NeilBrown <neilb@suse.de>
Date: Fri, 20 Dec 2024 15:23:13 +1100
Subject: [PATCH] nfsd: restore callback functionality for NFSv4.0
References: git-fixes
Git-commit: 7917f01a286ce01e9c085e24468421f596ee1a0c
Patch-mainline: v6.13-rc5

A recent patch inadvertently broke callbacks for NFSv4.0.

In the 4.0 case we do not export a session to be found still need to
call setup_callback_client() which will not try to dereference it.

This patch moves the check for failure to find a session into the 4.1+
branch of setup_callback_client()

Fixes: 1e02c641c3a4 ("NFSD: Prevent NULL dereference in nfsd4_process_cb_update()")
Signed-off-by: NeilBrown <neilb@suse.de>
---
 fs/nfsd/nfs4callback.c |    4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

--- a/fs/nfsd/nfs4callback.c
+++ b/fs/nfsd/nfs4callback.c
@@ -915,7 +915,7 @@ static int setup_callback_client(struct
 		args.authflavor = clp->cl_cred.cr_flavor;
 		clp->cl_cb_ident = conn->cb_ident;
 	} else {
-		if (!conn->cb_xprt)
+		if (!conn->cb_xprt || !ses)
 			return -EINVAL;
 		clp->cl_cb_session = ses;
 		args.bc_xprt = conn->cb_xprt;
@@ -1318,8 +1318,6 @@ static void nfsd4_process_cb_update(stru
 		ses = c->cn_session;
 	}
 	spin_unlock(&clp->cl_lock);
-	if (!c)
-		return;
 
 	err = setup_callback_client(clp, &conn, ses);
 	if (err) {
