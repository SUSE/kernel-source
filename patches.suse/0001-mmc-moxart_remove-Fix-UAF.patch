From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date: Wed, 12 Jan 2022 19:27:11 +0100
Subject: [PATCH] moxart: fix potential use-after-free on remove path
Patch-mainline: Not yet, will be fixed on the mainline soon
References: bsc#1194516 

It was reported that the mmc host structure could be accessed after it
was freed in moxart_remove(), so fix this by saving the base register of
the device and using it instead of the pointer dereference.

Cc: Ulf Hansson <ulf.hansson@linaro.org>
Cc: Xiyu Yang <xiyuyang19@fudan.edu.cn>
Cc: Xin Xiong <xiongx18@fudan.edu.cn>
Cc: Xin Tan <tanxin.ctf@gmail.com>
Cc: Tony Lindgren <tony@atomide.com>
Cc: Yang Li <yang.lee@linux.alibaba.com>
Cc: linux-mmc@vger.kernel.org
Cc: stable <stable@vger.kernel.org>
Reported-by: whitehat002 <hackyzh002@gmail.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Vasant Karasulli <vkarasulli@suse.de>
---
 drivers/mmc/host/moxart-mmc.c |    9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

--- a/drivers/mmc/host/moxart-mmc.c
+++ b/drivers/mmc/host/moxart-mmc.c
@@ -687,6 +687,7 @@ static int moxart_remove(struct platform
 {
 	struct mmc_host *mmc = dev_get_drvdata(&pdev->dev);
 	struct moxart_host *host = mmc_priv(mmc);
+	void __iomem *base = host->base;
 
 	dev_set_drvdata(&pdev->dev, NULL);
 
@@ -698,10 +699,10 @@ static int moxart_remove(struct platform
 		mmc_remove_host(mmc);
 		mmc_free_host(mmc);
 
-		writel(0, host->base + REG_INTERRUPT_MASK);
-		writel(0, host->base + REG_POWER_CONTROL);
-		writel(readl(host->base + REG_CLOCK_CONTROL) | CLK_OFF,
-		       host->base + REG_CLOCK_CONTROL);
+		writel(0, base + REG_INTERRUPT_MASK);
+		writel(0, base + REG_POWER_CONTROL);
+		writel(readl(base + REG_CLOCK_CONTROL) | CLK_OFF,
+		       base + REG_CLOCK_CONTROL);
 	}
 	return 0;
 }
