From: Alexander Gordeev <agordeev@linux.ibm.com>
Date: Wed, 20 Jul 2022 07:24:03 +0200
Subject: s390/smp: enforce lowcore protection on CPU restart
Git-commit: 8d96bba75a43ba564bf8732e955d9f519d2bbaec
Patch-mainline: v6.0-rc5
References: git-fixes
Alt-commit: 6f5c672d17f583b081e283927f5040f726c54598

As result of commit 915fea04f932 ("s390/smp: enable DAT before
CPU restart callback is called") the low-address protection bit
gets mistakenly unset in control register 0 save area of the
absolute zero memory. That area is used when manual PSW restart
happened to hit an offline CPU. In this case the low-address
protection for that CPU will be dropped.

Reviewed-by: Heiko Carstens <hca@linux.ibm.com>
Fixes: 915fea04f932 ("s390/smp: enable DAT before CPU restart callback is called")
Signed-off-by: Alexander Gordeev <agordeev@linux.ibm.com>
Signed-off-by: Vasily Gorbik <gor@linux.ibm.com>
Acked-by: Petr Tesarik <ptesarik@suse.com>
---
 arch/s390/kernel/setup.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/arch/s390/kernel/setup.c
+++ b/arch/s390/kernel/setup.c
@@ -462,8 +462,8 @@ static void __init setup_lowcore_dat_on(
 	S390_lowcore.svc_new_psw.mask |= PSW_MASK_DAT;
 	S390_lowcore.program_new_psw.mask |= PSW_MASK_DAT;
 	S390_lowcore.io_new_psw.mask |= PSW_MASK_DAT;
-	__ctl_store(S390_lowcore.cregs_save_area, 0, 15);
 	__ctl_set_bit(0, 28);
+	__ctl_store(S390_lowcore.cregs_save_area, 0, 15);
 	mem_assign_absolute(S390_lowcore.restart_flags, RESTART_FLAG_CTLREGS);
 	mem_assign_absolute(S390_lowcore.program_new_psw, lc->program_new_psw);
 	memcpy_absolute(&S390_lowcore.cregs_save_area, lc->cregs_save_area,
