From 32e8c6169af7ef7c938b1bd996d27ab171e27d80 Mon Sep 17 00:00:00 2001
From: Zhang Rui <rui.zhang@intel.com>
Date: Thu, 31 Aug 2023 14:44:06 +0800
Subject: [PATCH] tools/power/turbostat: Improve probe_platform_features() logic
Git-commit: 32e8c6169af7ef7c938b1bd996d27ab171e27d80
Patch-mainline: v6.7-rc2
References: bsc#1218556

AMD/Hygon platforms that don't have RAPL use 'amd_features' to describe
the platform features. Unknown Intel platforms use 'default_features' to
describe the platform features.

As none of the platform feature is set for 'amd_features' or
'default_features', there is no need to maintain both of them.

Remove 'amd_features' structure and improve the logic in
probe_platform_features().

Signed-off-by: Zhang Rui <rui.zhang@intel.com>
Reviewed-by: Len Brown <len.brown@intel.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 tools/power/x86/turbostat/turbostat.c | 9 ++-------
 1 file changed, 2 insertions(+), 7 deletions(-)

diff --git a/tools/power/x86/turbostat/turbostat.c b/tools/power/x86/turbostat/turbostat.c
index 89f53e1ac63a..102ba515cf4b 100644
--- a/tools/power/x86/turbostat/turbostat.c
+++ b/tools/power/x86/turbostat/turbostat.c
@@ -767,9 +767,6 @@ static const struct platform_features knl_features = {
 static const struct platform_features default_features = {
 };
 
-static const struct platform_features amd_features = {
-};
-
 static const struct platform_features amd_features_with_rapl = {
 	.rapl_msrs = RAPL_AMD_F17H,
 	.has_per_core_rapl = 1,
@@ -849,9 +846,9 @@ void probe_platform_features(unsigned int family, unsigned int model)
 {
 	int i;
 
-	if (authentic_amd || hygon_genuine) {
-		platform = &amd_features;
+	platform = &default_features;
 
+	if (authentic_amd || hygon_genuine) {
 		if (max_extended_level >= 0x80000007) {
 			unsigned int eax, ebx, ecx, edx;
 
@@ -863,8 +860,6 @@ void probe_platform_features(unsigned int family, unsigned int model)
 		return;
 	}
 
-	platform = &default_features;
-
 	if (!genuine_intel || family != 6)
 		return;
 
-- 
2.35.3

