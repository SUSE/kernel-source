From: Christoph Hellwig <hch@lst.de>
Date: Wed, 20 Oct 2021 16:41:16 +0200
Subject: [PATCH] blk-mq: only flush requests from the plug in
 blk_mq_submit_bio
Git-commit: a214b949d8e365583dd67441f6f608f0b20f7f52
Patch-mainline: v5.16-rc1
References: jsc#PED-1183

Replace the call to blk_flush_plug_list in blk_mq_submit_bio with a
direct call to blk_mq_flush_plug_list.  This means we do not flush
plug callback from stackable devices, which doesn't really help with
the accumulated requests anyway, and it also means the cached requests
aren't freed here as they can still be used later on.

Signed-off-by: Christoph Hellwig <hch@lst.de>
Link: https://lore.kernel.org/r/20211020144119.142582-2-hch@lst.de
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Hannes Reinecke <hare@suse.com>
---
 block/blk-mq.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/block/blk-mq.c b/block/blk-mq.c
index a71aeed7b987..101466ece4c4 100644
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@ -2568,7 +2568,7 @@ void blk_mq_submit_bio(struct bio *bio)
 		}
 
 		if (request_count >= blk_plug_max_rq_count(plug) || last) {
-			blk_flush_plug_list(plug, false);
+			blk_mq_flush_plug_list(plug, false);
 			trace_block_plug(q);
 		}
 
-- 
2.35.3

