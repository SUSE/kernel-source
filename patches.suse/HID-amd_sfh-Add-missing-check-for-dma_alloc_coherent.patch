From: Jiasheng Jiang <jiasheng@iscas.ac.cn>
Date: Tue, 20 Dec 2022 10:49:21 +0800
Subject: HID: amd_sfh: Add missing check for dma_alloc_coherent
Patch-mainline: v6.2-rc1
Git-commit: 53ffa6a9f83b2170c60591da1ead8791d5a42e81
References: bsc#1212605 CVE-2023-3357

Add check for the return value of the dma_alloc_coherent since
it may return NULL pointer if allocation fails.

Joey Lee:
Modified against 5.14 kernel.

Fixes: 4b2c53d93a4b ("SFH:Transport Driver to add support of AMD Sensor Fusion Hub (SFH)")
Signed-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>
Acked-by: Basavaraj Natikar <Basavaraj.Natikar@amd.com>
Signed-off-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
Link: https://lore.kernel.org/r/20221220024921.21992-1-jiasheng@iscas.ac.cn
Acked-by: Lee, Chun-Yi <jlee@suse.com>
---
 drivers/hid/amd-sfh-hid/amd_sfh_client.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/drivers/hid/amd-sfh-hid/amd_sfh_client.c
+++ b/drivers/hid/amd-sfh-hid/amd_sfh_client.c
@@ -157,6 +157,10 @@ int amd_sfh_hid_client_init(struct amd_m
 		in_data->sensor_virt_addr[i] = dma_alloc_coherent(dev, sizeof(int) * 8,
 								  &cl_data->sensor_dma_addr[i],
 								  GFP_KERNEL);
+		if (!in_data->sensor_virt_addr[i]) {
+			rc = -ENOMEM;
+			goto cleanup;
+		}
 		cl_data->sensor_sts[i] = 0;
 		cl_data->sensor_requested_cnt[i] = 0;
 		cl_data->cur_hid_dev = i;
