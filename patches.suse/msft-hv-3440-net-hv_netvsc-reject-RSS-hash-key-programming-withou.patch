From: Aditya Garg <gargaditya@linux.microsoft.com>
Date: Mon, 12 Jan 2026 02:01:33 -0800
Patch-mainline: v6.19-rc6
Subject: net: hv_netvsc: reject RSS hash key programming without RX indirection table
Git-commit: d23564955811da493f34412d7de60fa268c8cb50
References: bsc#1257473

RSS configuration requires a valid RX indirection table. When the device
reports a single receive queue, rndis_filter_device_add() does not
allocate an indirection table, accepting RSS hash key updates in this
state leads to a hang.

Fix this by providing netvsc_set_rxfh() a hint and return
-EOPNOTSUPP when the table is absent. This aligns set_rxfh with the device
capabilities and prevents incorrect behavior.

Fixes: 962f3fee83a4 ("netvsc: add ethtool ops to get/set RSS key")
Signed-off-by: Aditya Garg <gargaditya@linux.microsoft.com>
Reviewed-by: Dipayaan Roy <dipayanroy@linux.microsoft.com>
Reviewed-by: Haiyang Zhang <haiyangz@microsoft.com>
Link: https://patch.msgid.link/1768212093-1594-1-git-send-email-gargaditya@linux.microsoft.com
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Olaf Hering <ohering@suse.de>
---
 drivers/net/hyperv/hyperv_net.h   |    1 +
 drivers/net/hyperv/netvsc_drv.c   |    2 ++
 drivers/net/hyperv/rndis_filter.c |    1 +
 3 files changed, 4 insertions(+)

--- a/drivers/net/hyperv/hyperv_net.h
+++ b/drivers/net/hyperv/hyperv_net.h
@@ -1046,6 +1046,7 @@
 	u32 tx_table[VRSS_SEND_TAB_SIZE];
 
 	u16 rx_table[ITAB_NUM];
+	bool got_enough_num_recv_que;
 
 	/* Ethtool settings */
 	u8 duplex;
--- a/drivers/net/hyperv/netvsc_drv.c
+++ b/drivers/net/hyperv/netvsc_drv.c
@@ -1760,6 +1760,8 @@
 
 	if (hfunc != ETH_RSS_HASH_NO_CHANGE && hfunc != ETH_RSS_HASH_TOP)
 		return -EOPNOTSUPP;
+	if (!ndc->got_enough_num_recv_que)
+		return -EOPNOTSUPP;
 
 	rndis_dev = ndev->extension;
 	if (indir) {
--- a/drivers/net/hyperv/rndis_filter.c
+++ b/drivers/net/hyperv/rndis_filter.c
@@ -1537,6 +1537,7 @@
 					&rsscap, &rsscap_size);
 	if (ret || rsscap.num_recv_que < 2)
 		goto out;
+	ndc->got_enough_num_recv_que = true;
 
 	/* This guarantees that num_possible_rss_qs <= num_online_cpus */
 	num_possible_rss_qs = min_t(u32, num_online_cpus(),
