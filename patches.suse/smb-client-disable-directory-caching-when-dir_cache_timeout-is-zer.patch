From: Henrique Carvalho <henrique.carvalho@suse.com>
Date: Fri, 22 Nov 2024 22:14:35 -0300
Subject: [PATCH] smb: client: disable directory caching when dir_cache_timeout
 is zero
Git-commit: ceaf1451990e3ea7fb50aebb5a149f57945f6e9f
References: git-fixes
Patch-mainline: v6.13-rc1

Setting dir_cache_timeout to zero should disable the caching of
directory contents. Currently, even when dir_cache_timeout is zero,
some caching related functions are still invoked, which is unintended
behavior.

Fix the issue by setting tcon->nohandlecache to true when
dir_cache_timeout is zero, ensuring that directory handle caching
is properly disabled.

Fixes: 238b351d0935 ("smb3: allow controlling length of time directory entries are cached with dir leases")
Reviewed-by: Paulo Alcantara (Red Hat) <pc@manguebit.com>
Reviewed-by: Enzo Matsumiya <ematsumiya@suse.de>
Signed-off-by: Henrique Carvalho <henrique.carvalho@suse.com>
Signed-off-by: Steve French <stfrench@microsoft.com>
Acked-by: Enzo Matsumiya <ematsumiya@suse.de>
---
 fs/smb/client/connect.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/fs/smb/client/connect.c
+++ b/fs/smb/client/connect.c
@@ -2645,7 +2645,7 @@
 	tcon->nocase = ctx->nocase;
 	tcon->broken_sparse_sup = ctx->no_sparse;
 	if (ses->server->capabilities & SMB2_GLOBAL_CAP_DIRECTORY_LEASING)
-		tcon->nohandlecache = ctx->nohandlecache;
+		tcon->nohandlecache = ctx->nohandlecache || !dir_cache_timeout;
 	else
 		tcon->nohandlecache = true;
 	tcon->nodelete = ctx->nodelete;
