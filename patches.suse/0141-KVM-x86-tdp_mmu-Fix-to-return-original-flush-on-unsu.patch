Patch-mainline: Queued in subsystem maintainer repository
Git-repo: https://gitlab.suse.de/coco/tdx/kernel-downstream-suse.git
Git-commit: fe53ef6dd4777a14df476baaf6b914f376ed0aec
References: jsc#PED-6143
From: Hang Yuan <hang.yuan@intel.com>
Date: Wed, 8 May 2024 11:05:16 +0800
Subject: [PATCH 141/155] KVM: x86/tdp_mmu: Fix to return original flush on
 unsupported cases

Picked the fix catched in KVM TDX patch's community review:
https://lore.kernel.org/kvm/Zh8yHEiOKyvZO+QR@chao-email/

Fixes: 9a91cfd1d241 (KVM: x86/tdp_mmu: Don't zap private pages for unsupported cases)
Signed-off-by: Hang Yuan <hang.yuan@intel.com>
Signed-off-by: Juergen Gross <jgross@suse.com>
---
 arch/x86/kvm/mmu/tdp_mmu.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/arch/x86/kvm/mmu/tdp_mmu.c b/arch/x86/kvm/mmu/tdp_mmu.c
index 32d315780091..c85865653f82 100644
--- a/arch/x86/kvm/mmu/tdp_mmu.c
+++ b/arch/x86/kvm/mmu/tdp_mmu.c
@@ -1066,7 +1066,7 @@ static bool tdp_mmu_zap_leafs(struct kvm *kvm, struct kvm_mmu_page *root,
 
 	WARN_ON_ONCE(zap_private && !is_private_sp(root));
 	if (!zap_private && is_private_sp(root))
-		return false;
+		return flush;
 
 	/*
 	 * start and end doesn't have GFN shared bit.  This function zaps
-- 
2.43.0

