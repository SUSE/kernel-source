From aa2a4b897132169fbc6d32932644b95875cf9c7f Mon Sep 17 00:00:00 2001
From: Mark Brown <broonie@kernel.org>
Date: Sat, 4 Jun 2022 11:54:07 +0100
Subject: [PATCH] ASoC: ops: Fix boolean/integer detection for simple controls
Git-commit: aa2a4b897132169fbc6d32932644b95875cf9c7f
Patch-mainline: v6.0-rc1
References: jsc#PED-850

The standard snd_soc_info_volsw() detects if a control is a volume control
and needs to be reported as an integer even if it only has two values by
looking for the string " Volume" in the control name. This results in false
positives if the control has a name like "HP Volume Ramp Switch" since any
" Volume" is matched, not just a trailing one. Fix this by making sure that
we only match at the end of the control name.

Signed-off-by: Mark Brown <broonie@kernel.org>
Link: https://lore.kernel.org/r/20220604105407.4055294-1-broonie@kernel.org
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 sound/soc/soc-ops.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/sound/soc/soc-ops.c b/sound/soc/soc-ops.c
index b624ed79ade3..c22d87581f6f 100644
--- a/sound/soc/soc-ops.c
+++ b/sound/soc/soc-ops.c
@@ -176,13 +176,21 @@ int snd_soc_info_volsw(struct snd_kcontrol *kcontrol,
 {
 	struct soc_mixer_control *mc =
 		(struct soc_mixer_control *)kcontrol->private_value;
+	const char *vol_string = NULL;
 	int max;
 
 	max = uinfo->value.integer.max = mc->max - mc->min;
 	if (mc->platform_max && mc->platform_max < max)
 		max = mc->platform_max;
 
-	if (max == 1 && !strstr(kcontrol->id.name, " Volume"))
+	/* Even two value controls ending in Volume should always be integer */
+	if (max == 1) {
+		vol_string = strstr(kcontrol->id.name, " Volume");
+		if (vol_string && strcmp(vol_string, " Volume"))
+			vol_string = NULL;
+	}
+
+	if (!vol_string)
 		uinfo->type = SNDRV_CTL_ELEM_TYPE_BOOLEAN;
 	else
 		uinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;
-- 
2.35.3

