From: Wenkai Lin <linwenkai6@hisilicon.com>
Date: Fri, 15 Sep 2023 17:13:29 +0800
Subject: crypto: hisilicon/sec - fix for sgl unmmap problem
Git-commit: ce2cb2e1b8a27d929a0eaa042049912b0756efe0
Patch-mainline: v6.7-rc1
References: jsc#PED-11279

When sec_aead_mac_init returns an error code, sec_cipher_map
will exit abnormally, the hardware sgl should be unmmaped.

Signed-off-by: Wenkai Lin <linwenkai6@hisilicon.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Acked-by: Stanimir Varbanov <svarbanov@suse.de>
---
 drivers/crypto/hisilicon/sec2/sec_crypto.c |    1 +
 1 file changed, 1 insertion(+)

--- a/drivers/crypto/hisilicon/sec2/sec_crypto.c
+++ b/drivers/crypto/hisilicon/sec2/sec_crypto.c
@@ -1011,6 +1011,7 @@ static int sec_cipher_map(struct sec_ctx
 		ret = sec_aead_mac_init(a_req);
 		if (unlikely(ret)) {
 			dev_err(dev, "fail to init mac data for ICV!\n");
+			hisi_acc_sg_buf_unmap(dev, src, req->in);
 			return ret;
 		}
 	}
