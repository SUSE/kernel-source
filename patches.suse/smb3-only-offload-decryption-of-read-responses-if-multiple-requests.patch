From: Steve French <stfrench@microsoft.com>
Date: Mon, 9 Sep 2019 13:30:15 -0500
Subject: [PATCH] smb3: only offload decryption of read responses if multiple
 requests
Git-commit: 10328c44cc1506dd82fd835efcaafd519866c464
References: bsc#1164565
Patch-mainline: v5.4-rc1

No point in offloading read decryption if no other requests on the
wire

Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Ronnie Sahlberg <lsahlber@redhat.com>
Acked-by: Paulo Alcantara <palcantara@suse.de>
---
 fs/cifs/cifsfs.c  | 9 ++++++---
 fs/cifs/smb2ops.c | 2 +-
 2 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/fs/cifs/cifsfs.c b/fs/cifs/cifsfs.c
index ebf85a5d95e4..c1b685072063 100644
--- a/fs/cifs/cifsfs.c
+++ b/fs/cifs/cifsfs.c
@@ -1503,11 +1503,14 @@ init_cifs(void)
 	}
 
 	/*
-	 * BB Consider setting limit!=0 maybe to min(num_of_cores - 1, 3) so we
-	 * don't launch too many worker threads
+	 * Consider in future setting limit!=0 maybe to min(num_of_cores - 1, 3)
+	 * so that we don't launch too many worker threads but
+	 * Documentation/workqueue.txt recommends setting it to 0
 	 */
+
+	/* WQ_UNBOUND allows decrypt tasks to run on any CPU */
 	decrypt_wq = alloc_workqueue("smb3decryptd",
-				     WQ_FREEZABLE|WQ_MEM_RECLAIM, 0);
+				     WQ_UNBOUND|WQ_FREEZABLE|WQ_MEM_RECLAIM, 0);
 	if (!decrypt_wq) {
 		rc = -ENOMEM;
 		goto out_destroy_cifsiod_wq;
diff --git a/fs/cifs/smb2ops.c b/fs/cifs/smb2ops.c
index 1cfb8d518132..72b3e39d7f4f 100644
--- a/fs/cifs/smb2ops.c
+++ b/fs/cifs/smb2ops.c
@@ -4121,7 +4121,7 @@ receive_encrypted_read(struct TCP_Server_Info *server, struct mid_q_entry **mid,
 	 * use more cores decrypting which can be expensive
 	 */
 
-	if ((server->min_offload) &&
+	if ((server->min_offload) && (server->in_flight > 1) &&
 	    (server->pdu_size >= server->min_offload)) {
 		dw = kmalloc(sizeof(struct smb2_decrypt_work), GFP_KERNEL);
 		if (dw == NULL)
-- 
2.33.1

