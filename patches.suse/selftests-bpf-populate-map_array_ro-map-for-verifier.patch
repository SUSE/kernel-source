From: Eduard Zingerman <eddyz87@gmail.com>
Date: Fri, 21 Apr 2023 02:23:17 +0300
Subject: selftests/bpf: populate map_array_ro map for verifier_array_access
 test
Patch-mainline: v6.4-rc1
Git-commit: cbb110bc6672f785cab2cb308e9cfefee07af861
References: bsc#1225903

Two test cases:
- "valid read map access into a read-only array 1" and
- "valid read map access into a read-only array 2"

Expect that map_array_ro map is filled with mock data. This logic was
not taken into acount during initial test conversion.

This commit modifies prog_tests/verifier.c entry point for this test
to fill the map.

Fixes: a3c830ae0209 ("selftests/bpf: verifier/array_access.c converted to inline assembly")
Signed-off-by: Eduard Zingerman <eddyz87@gmail.com>
Link: https://lore.kernel.org/r/20230420232317.2181776-5-eddyz87@gmail.com
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[shung-hsi.yu: context difference in
tools/testing/selftests/bpf/prog_tests/verifier.c due to most of
tools/testing/selftests/bpf/verifier/*.c tests have not been migrated to inline
assembly]
Signed-off-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>

---
 tools/testing/selftests/bpf/prog_tests/verifier.c |   15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

--- a/tools/testing/selftests/bpf/prog_tests/verifier.c
+++ b/tools/testing/selftests/bpf/prog_tests/verifier.c
@@ -5,8 +5,17 @@
 #include "cap_helpers.h"
 #include "verifier_reg_equal.skel.h"
 
+#define MAX_ENTRIES 11
+
+struct test_val {
+	unsigned int index;
+	int foo[MAX_ENTRIES];
+};
+
 __maybe_unused
-static void run_tests_aux(const char *skel_name, skel_elf_bytes_fn elf_bytes_factory)
+static void run_tests_aux(const char *skel_name,
+			  skel_elf_bytes_fn elf_bytes_factory,
+			  pre_execution_cb pre_execution_cb)
 {
 	struct test_loader tester = {};
 	__u64 old_caps;
@@ -19,6 +28,7 @@ static void run_tests_aux(const char *sk
 		return;
 	}
 
+	test_loader__set_pre_execution_cb(&tester, pre_execution_cb);
 	test_loader__run_subtests(&tester, skel_name, elf_bytes_factory);
 	test_loader_fini(&tester);
 
@@ -27,5 +37,6 @@ static void run_tests_aux(const char *sk
 		PRINT_FAIL("failed to restore CAP_SYS_ADMIN: %i, %s\n", err, strerror(err));
 }
 
-#define RUN(skel) run_tests_aux(#skel, skel##__elf_bytes)
+#define RUN(skel) run_tests_aux(#skel, skel##__elf_bytes, NULL)
+
 void test_verifier_reg_equal(void)            { RUN(verifier_reg_equal); }
