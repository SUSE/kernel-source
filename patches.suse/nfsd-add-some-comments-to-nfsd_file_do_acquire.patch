From: Jeff Layton <jlayton@kernel.org>
Date: Thu, 5 Jan 2023 07:15:12 -0500
Subject: [PATCH] nfsd: add some comments to nfsd_file_do_acquire
Git-commit: b680cb9b737331aad271feebbedafb865504e234
Patch-mainline: v6.4
References: git-fixes

David Howells mentioned that he found this bit of code confusing, so
sprinkle in some comments to clarify.

Reported-by: David Howells <dhowells@redhat.com>
Signed-off-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Acked-by: NeilBrown <neilb@suse.com>

---
 fs/nfsd/filecache.c |    5 +++++
 1 file changed, 5 insertions(+)

--- a/fs/nfsd/filecache.c
+++ b/fs/nfsd/filecache.c
@@ -1077,6 +1077,11 @@ retry:
 	rcu_read_unlock();
 
 	if (nf) {
+		/*
+		 * If the nf is on the LRU then it holds an extra reference
+		 * that must be put if it's removed. It had better not be
+		 * the last one however, since we should hold another.
+		 */
 		if (nfsd_file_lru_remove(nf))
 			WARN_ON_ONCE(refcount_dec_and_test(&nf->nf_ref));
 		goto wait_for_construction;
