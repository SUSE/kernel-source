From: Paul Aurich <paul@darkrain42.org>
Date: Tue, 26 Nov 2024 18:50:31 -0600
Subject: [PATCH] smb: Initialize cfid->tcon before performing network ops
Git-commit: c353ee4fb119a2582d0e011f66a76a38f5cf984d
Patch-mainline: v6.13-rc1
References: CVE-2024-56729 bsc#1235503

Avoid leaking a tcon ref when a lease break races with opening the
cached directory. Processing the leak break might take a reference to
the tcon in cached_dir_lease_break() and then fail to release the ref in
cached_dir_offload_close, since cfid->tcon is still NULL.

Fixes: ebe98f1447bb ("cifs: enable caching of directories for which a lease is held")
Signed-off-by: Paul Aurich <paul@darkrain42.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: David Sterba <dsterba@suse.com>
---
 fs/smb/client/cached_dir.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/fs/smb/client/cached_dir.c
+++ b/fs/smb/client/cached_dir.c
@@ -206,6 +206,7 @@ int open_cached_dir(unsigned int xid, st
 		}
 	}
 	cfid->dentry = dentry;
+	cfid->tcon = tcon;
 
 	/*
 	 * We do not hold the lock for the open because in case
@@ -279,7 +280,6 @@ int open_cached_dir(unsigned int xid, st
 		}
 		goto oshr_free;
 	}
-	cfid->tcon = tcon;
 	cfid->is_open = true;
 
 	spin_lock(&cfids->cfid_list_lock);
