From ed6b3681222c9f4d796ca423125a1ed6b6183d86 Mon Sep 17 00:00:00 2001
From: Lin Ma <lma@suse.com>
Date: Wed, 7 Jul 2021 21:20:02 +0800
Subject: [PATCH] intel_idle: Customize IceLake server support
Git-commit: a472ad2bcea479ba068880125d7273fc95c14b70
Patch-mainline: v5.9-rc1
References: bsc#1175543

Refresh patches.suse/intel_idle-Customize-IceLake-server-support.patch

Signed-off-by: Lin Ma <lma@suse.com>
---
 drivers/idle/intel_idle.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/idle/intel_idle.c b/drivers/idle/intel_idle.c
index 592a6cacd9b1..7c91aa240d08 100644
--- a/drivers/idle/intel_idle.c
+++ b/drivers/idle/intel_idle.c
@@ -682,7 +682,7 @@ static struct cpuidle_state skx_cstates[] __initdata = {
 		.enter = NULL }
 };
 
-static struct cpuidle_state icx_cstates[] = {
+static struct cpuidle_state icx_cstates[] __initdata = {
 	{
 		.name = "C1",
 		.desc = "MWAIT 0x00",
@@ -694,7 +694,7 @@ static struct cpuidle_state icx_cstates[] = {
 	{
 		.name = "C1E",
 		.desc = "MWAIT 0x01",
-		.flags = MWAIT2flg(0x01),
+		.flags = MWAIT2flg(0x01) | CPUIDLE_FLAG_ALWAYS_ENABLE,
 		.exit_latency = 4,
 		.target_residency = 4,
 		.enter = &intel_idle,
@@ -1114,9 +1114,10 @@ static const struct idle_cpu idle_cpu_skx __initconst = {
 	.use_acpi = true,
 };
 
-static const struct idle_cpu idle_cpu_icx = {
+static const struct idle_cpu idle_cpu_icx __initconst = {
 	.state_table = icx_cstates,
 	.disable_promotion_to_c1e = true,
+	.use_acpi = true,
 };
 
 static const struct idle_cpu idle_cpu_avn __initconst = {
-- 
2.26.2

