From: Yury Norov <yury.norov@gmail.com>
Date: Sun, 24 Sep 2023 19:38:15 -0700
Subject: bitmap: replace _reg_op(REG_OP_ISFREE) with find_next_bit()
Patch-mainline: v6.7-rc1
Git-commit: 9276819a68b52cf2577f77985041faf527cf477c
References: jsc#PED-9947

_reg_op(REG_OP_ISFREE) can be trivially replaced with find_next_bit().
Doing that opens room for potential small_const_nbits() optimization.

CC: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
CC: Rasmus Villemoes <linux@rasmusvillemoes.dk>
Signed-off-by: Yury Norov <yury.norov@gmail.com>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 lib/bitmap.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/lib/bitmap.c
+++ b/lib/bitmap.c
@@ -840,7 +840,7 @@ int bitmap_allocate_region(unsigned long
 {
 	unsigned int len = BIT(order);
 
-	if (!__reg_op(bitmap, pos, order, REG_OP_ISFREE))
+	if (find_next_bit(bitmap, pos + len, pos) < pos + len)
 		return -EBUSY;
 	bitmap_set(bitmap, pos, len);
 	return 0;
