From: Mel Gorman <mgorman@suse.de>
Date: Mon, 21 Aug 2023 12:58:07 +0100
Subject: [PATCH] timers: Split [try_to_]del_timer[_sync]() to prepare for
 shutdown mode -rt

Patch-mainline: Never, RT-specific
References: SLE Realtime Extension
Patch-name: patches.suse/timers-Split-try_to_-del_timer-_sync-to-prepare-for-shutdown-mode-rt.patch

Patch patches.suse/timers-Split-try_to_-del_timer-_sync-to-prepare-for-.patch split
[try_to_]del_timer[_sync]() but the end result failes to convert a cpu_relax() site
to a del_timer_wait_running. While this could be properly integrated with the patches
that introduced the problem, it would have a high risk of future conflicts and the
git commit reference would be misleading. Apply a minimal fix on top.

Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 kernel/time/timer.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/kernel/time/timer.c b/kernel/time/timer.c
index 3a6f476f8d32..e525d42bc01d 100644
--- a/kernel/time/timer.c
+++ b/kernel/time/timer.c
@@ -1410,6 +1410,10 @@ int try_to_del_timer_sync(struct timer_list *timer)
 }
 EXPORT_SYMBOL(try_to_del_timer_sync);
 
+#ifdef CONFIG_PREEMPT_RT
+static void del_timer_wait_running(struct timer_list *timer);
+#endif
+
 /*
  * __timer_delete_sync - Internal function: Deactivate a timer and wait
  *			 for the handler to finish.
@@ -1455,7 +1459,11 @@ static int __timer_delete_sync(struct timer_list *timer, bool shutdown)
 		int ret = __try_to_del_timer_sync(timer, shutdown);
 		if (ret >= 0)
 			return ret;
+#ifdef CONFIG_PREEMPT_RT
+		del_timer_wait_running(timer);
+#else
 		cpu_relax();
+#endif
 	}
 }
 
