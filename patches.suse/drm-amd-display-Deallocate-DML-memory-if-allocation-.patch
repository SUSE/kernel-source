From: Chris Park <chris.park@amd.com>
Date: Fri, 28 Jun 2024 15:09:06 -0400
Subject: [PATCH] drm/amd/display: Deallocate DML memory if allocation fails
Git-commit: 892abca6877a96c9123bb1c010cafccdf8ca1b75
Patch-mainline: v6.12-rc1
References: CVE-2024-49972 bsc#1232315

[ Simplified backport, dml2_create() called only once in dc_create_state(),
  related: e779f4587f6178 ("drm/amd/display: Add handling for DC power mode")
]

[Why]
When DC state create DML memory allocation fails, memory is not
deallocated subsequently, resulting in uninitialized structure
that is not NULL.

[How]
Deallocate memory if DML memory allocation fails.

Reviewed-by: Joshua Aberback <joshua.aberback@amd.com>
Signed-off-by: Jerry Zuo <jerry.zuo@amd.com>
Signed-off-by: Chris Park <chris.park@amd.com>
Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: David Sterba <dsterba@suse.com>
---
 drivers/gpu/drm/amd/display/dc/core/dc.c |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

--- a/drivers/gpu/drm/amd/display/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/display/dc/core/dc.c
@@ -2250,7 +2250,10 @@ struct dc_state *dc_create_state(struct
 
 #ifdef CONFIG_DRM_AMD_DC_FP
 	if (dc->debug.using_dml2) {
-		dml2_create(dc, &dc->dml2_options, &context->bw_ctx.dml2);
+		if (!dml2_create(dc, &dc->dml2_options, &context->bw_ctx.dml2)) {
+			dc_release_state(context);
+			return NULL;
+		}
 	}
 #endif
 	kref_init(&context->refcount);
