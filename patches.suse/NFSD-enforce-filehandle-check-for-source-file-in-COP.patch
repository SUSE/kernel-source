From: Olga Kornievskaia <kolga@netapp.com>
Date: Fri, 19 Aug 2022 15:16:36 -0400
Subject: [PATCH] NFSD enforce filehandle check for source file in COPY
Git-commit: 754035ff79a14886e68c0c9f6fa80adb21f12b53
Patch-mainline: v6.1
References: git-fixes

If the passed in filehandle for the source file in the COPY operation
is not a regular file, the server MUST return NFS4ERR_WRONG_TYPE.

Signed-off-by: Olga Kornievskaia <kolga@netapp.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Acked-by: NeilBrown <neilb@suse.com>

---
 fs/nfsd/nfs4proc.c |    8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

--- a/fs/nfsd/nfs4proc.c
+++ b/fs/nfsd/nfs4proc.c
@@ -1803,7 +1803,13 @@ static int nfsd4_do_async_copy(void *dat
 		copy->nf_src->nf_file = nfs42_ssc_open(copy->ss_mnt, &copy->c_fh,
 					      &copy->stateid);
 		if (IS_ERR(copy->nf_src->nf_file)) {
-			copy->nfserr = nfserr_offload_denied;
+			switch (PTR_ERR(copy->nf_src->nf_file)) {
+			case -EBADF:
+				copy->nfserr = nfserr_wrong_type;
+				break;
+			default:
+				copy->nfserr = nfserr_offload_denied;
+			}
 			nfsd4_interssc_disconnect(copy->ss_mnt);
 			goto do_callback;
 		}
