From: Weili Qian <qianweili@huawei.com>
Date: Fri, 14 Jul 2023 19:41:35 +0800
Subject: [PATCH] crypto: hisilicon/qm - flush all work before driver removed
Git-commit: 5cd4ed98cfb743cd8f363ccc674313c14c17acd5
Patch-mainline: v6.6-rc1
References: bsc#1232075

Before removing the driver, flush inter-function communication
work, and subsequent communication work is not processed.
This prevents communication threads from accessing released memory.

Fixes: ("crypto: hisilicon/qm - enable PF and VFs communication")
Signed-off-by: Weili Qian <qianweili@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: David Sterba <dsterba@suse.com>
---
 drivers/crypto/hisilicon/qm.c |    8 ++++++++
 1 file changed, 8 insertions(+)

--- a/drivers/crypto/hisilicon/qm.c
+++ b/drivers/crypto/hisilicon/qm.c
@@ -949,6 +949,11 @@ static irqreturn_t qm_mb_cmd_irq(int irq
 	if (!val)
 		return IRQ_NONE;
 
+	if (test_bit(QM_DRIVER_REMOVING, &qm->misc_ctl)) {
+		dev_warn(&qm->pdev->dev, "Driver is down, message cannot be processed!\n");
+		return IRQ_HANDLED;
+	}
+
 	schedule_work(&qm->cmd_process);
 
 	return IRQ_HANDLED;
@@ -2738,6 +2743,9 @@ void hisi_qm_wait_task_finish(struct his
 	       test_bit(QM_RESETTING, &qm->misc_ctl))
 		msleep(WAIT_PERIOD);
 
+	if (test_bit(QM_SUPPORT_MB_COMMAND, &qm->caps))
+		flush_work(&qm->cmd_process);
+
 	udelay(REMOVE_WAIT_DELAY);
 }
 EXPORT_SYMBOL_GPL(hisi_qm_wait_task_finish);
