From: Jan Kara <jack@suse.cz>
Subject: nbd: fix uaf in nbd_open
Patch-mainline: Never, fixed differently by commit 327462725b0f7
References: bsc#1224935 CVE-2023-52837

Commit 4af5f2e03013 ("nbd: use blk_mq_alloc_disk and
blk_cleanup_disk") cleans up disk by blk_cleanup_disk() and it won't set
disk->private_data as NULL as before. UAF may be triggered in nbd_open()
if someone tries to open nbd device right after nbd_put() since nbd has
been free in nbd_dev_remove().

Fix this by zeroing disk->private_data when destroying nbd device.

Fixes: 4af5f2e03013 ("nbd: use blk_mq_alloc_disk and blk_cleanup_disk")
Signed-off-by: Jan Kara <jack@suse.cz>

---
 drivers/block/nbd.c |    1 +
 1 file changed, 1 insertion(+)

--- a/drivers/block/nbd.c
+++ b/drivers/block/nbd.c
@@ -246,6 +246,7 @@ static void nbd_del_disk(struct nbd_devi
 
 	if (disk) {
 		del_gendisk(disk);
+		nbd->disk->private_data = NULL;
 		blk_cleanup_disk(disk);
 		blk_mq_free_tag_set(&nbd->tag_set);
 	}
