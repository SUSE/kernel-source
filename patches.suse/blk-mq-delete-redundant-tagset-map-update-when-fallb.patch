From: Chengming Zhou <zhouchengming@bytedance.com>
Date: Mon, 21 Aug 2023 17:56:01 +0800
Subject: [PATCH] blk-mq: delete redundant tagset map update when fallback
Git-commit: 2bc4d7a355a4d617452eaf1b21d6d261194b3667
Patch-mainline: v6.6-rc1
References: bsc#1216436

When we increase nr_hw_queues fail, the fallback path will use
blk_mq_update_queue_map() to clear and update all maps.
Obviously, this line of update of HCTX_TYPE_DEFAULT only is not
needed, so delete it.

Signed-off-by: Chengming Zhou <zhouchengming@bytedance.com>
Reviewed-by: Ming Lei <ming.lei@redhat.com>
Link: https://lore.kernel.org/r/20230821095602.70742-2-chengming.zhou@linux.dev
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Hannes Reinecke <hare@suse.com>
---
 block/blk-mq.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/block/blk-mq.c b/block/blk-mq.c
index afad6d06eaf7..22397ba815ca 100644
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@ -4730,7 +4730,6 @@ static void __blk_mq_update_nr_hw_queues(struct blk_mq_tag_set *set,
 				__blk_mq_free_map_and_rqs(set, i);
 
 			set->nr_hw_queues = prev_nr_hw_queues;
-			blk_mq_map_queues(&set->map[HCTX_TYPE_DEFAULT]);
 			goto fallback;
 		}
 		blk_mq_map_swqueue(q);
-- 
2.35.3

