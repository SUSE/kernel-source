From: Pedro Tammela <pctammela@mojatatu.com>
Date: Sat, 22 Apr 2023 12:56:11 -0300
Subject: net/sched: sch_qfq: refactor parsing of netlink parameters
Patch-mainline: v6.4-rc1
Git-commit: 25369891fcef373540f8b4e0b3bccf77a04490d5
References: bsc#1213585

Two parameters can be transformed into netlink policies and
validated while parsing the netlink message.

SLE15-SP3-LTSS: we do not have the advanced netlink policy infrastructure
yet so omit the part replacing existing checks by policies and only
introduce QFQ_MAX_LMAX (needed by further backports) and use it. But set
also extack error message as standardized policy checks would.

Reviewed-by: Simon Horman <simon.horman@corigine.com>
Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
Signed-off-by: Pedro Tammela <pctammela@mojatatu.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Michal Kubecek <mkubecek@suse.cz>

---
 net/sched/sch_qfq.c | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

--- a/net/sched/sch_qfq.c
+++ b/net/sched/sch_qfq.c
@@ -113,6 +113,7 @@
 
 #define QFQ_MTU_SHIFT		16	/* to support TSO/GSO */
 #define QFQ_MIN_LMAX		512	/* see qfq_slot_insert */
+#define QFQ_MAX_LMAX		(1UL << QFQ_MTU_SHIFT)
 
 #define QFQ_MAX_AGG_CLASSES	8 /* max num classes per aggregate allowed */
 
@@ -408,13 +409,15 @@ static int qfq_change_class(struct Qdisc *sch, u32 classid, u32 parentid,
 	}
 
 	err = nla_parse_nested_deprecated(tb, TCA_QFQ_MAX, tca[TCA_OPTIONS],
-					  qfq_policy, NULL);
+					  qfq_policy, extack);
 	if (err < 0)
 		return err;
 
 	if (tb[TCA_QFQ_WEIGHT]) {
 		weight = nla_get_u32(tb[TCA_QFQ_WEIGHT]);
-		if (!weight || weight > (1UL << QFQ_MAX_WSHIFT)) {
+		if (!weight || weight > QFQ_MAX_LMAX) {
+			NL_SET_ERR_MSG_MOD(extack,
+					   "weight out of bounds for qfq");
 			pr_notice("qfq: invalid weight %u\n", weight);
 			return -EINVAL;
 		}
@@ -426,7 +429,8 @@ static int qfq_change_class(struct Qdisc *sch, u32 classid, u32 parentid,
 	else
 		lmax = psched_mtu(qdisc_dev(sch));
 
-	if (lmax < QFQ_MIN_LMAX || lmax > (1UL << QFQ_MTU_SHIFT)) {
+	if (lmax < QFQ_MIN_LMAX || lmax > QFQ_MAX_LMAX) {
+		NL_SET_ERR_MSG_MOD(extack, "MTU size out of bounds for qfq");
 		pr_notice("qfq: invalid max length %u\n", lmax);
 		return -EINVAL;
 	}
