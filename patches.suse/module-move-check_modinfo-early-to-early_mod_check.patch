From: Luis Chamberlain <mcgrof@kernel.org>
Date: Sun, 19 Mar 2023 14:27:39 -0700
Subject: module: move check_modinfo() early to early_mod_check()
Git-commit: 02da2cbab452a236fa67abc9fc9e47430934e652
Patch-mainline: v6.4-rc1
References: bsc#1213921

This moves check_modinfo() to early_mod_check(). This
doesn't make any functional changes either, as check_modinfo()
was the first call on layout_and_allocate(), so we're just
moving it back one routine and at the end.

This let's us keep separate the checkers from the allocator.

Signed-off-by: Luis Chamberlain <mcgrof@kernel.org>
Acked-by: Petr Pavlu <petr.pavlu@suse.com>
---
 kernel/module.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/kernel/module.c b/kernel/module.c
index 22596cb46dc8..95fd705328ac 100644
--- a/kernel/module.c
+++ b/kernel/module.c
@@ -2273,10 +2273,6 @@ static struct module *layout_and_allocate(struct load_info *info, int flags)
 	unsigned int ndx;
 	int err;
 
-	err = check_modinfo(info->mod, info, flags);
-	if (err)
-		return ERR_PTR(err);
-
 	/* Allow arches to frob section contents and sizes.  */
 	err = module_frob_arch_sections(info->hdr, info->sechdrs,
 					info->secstrings, info->mod);
@@ -2690,6 +2686,10 @@ static int early_mod_check(struct load_info *info, int flags)
 	if (!check_modstruct_version(info, info->mod))
 		return -ENOEXEC;
 
+	err = check_modinfo(info->mod, info, flags);
+	if (err)
+		return err;
+
 	return 0;
 }
 

