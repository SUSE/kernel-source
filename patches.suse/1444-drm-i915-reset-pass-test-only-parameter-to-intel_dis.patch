From d1b97b121e3c2bbb3c74fe91e42d13e59fd9d96e Mon Sep 17 00:00:00 2001
From: Jani Nikula <jani.nikula@intel.com>
Date: Mon, 3 Mar 2025 13:27:09 +0200
Subject: drm/i915/reset: pass test only parameter to
 intel_display_reset_finish()
Git-commit: d1b97b121e3c2bbb3c74fe91e42d13e59fd9d96e
Patch-mainline: v6.15-rc1
References: jsc#PED-13979 jsc#PED-14039 jsc#PED-14046 jsc#PED-14211 jsc#PED-14333 jsc#PED-14487 jsc#PED-14488 jsc#PED-14497 jsc#PED-14499

Deduplicate the gpu_reset_clobbers_display() part by passing the
information in from gt side.

Cc: Matt Roper <matthew.d.roper@intel.com>
Reviewed-by: Matt Roper <matthew.d.roper@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/a36481db334fedcde50ae0e66c4d57825cae8cb7.1741001054.git.jani.nikula@intel.com
Signed-off-by: Jani Nikula <jani.nikula@intel.com>
Acked-by: Patrik Jakobsson <pjakobsson@suse.de>

---
 drivers/gpu/drm/i915/display/intel_display_reset.c | 12 ++----------
 drivers/gpu/drm/i915/display/intel_display_reset.h |  2 +-
 drivers/gpu/drm/i915/gt/intel_reset.c              |  2 +-
 3 files changed, 4 insertions(+), 12 deletions(-)

diff --git a/drivers/gpu/drm/i915/display/intel_display_reset.c b/drivers/gpu/drm/i915/display/intel_display_reset.c
index c48d822db58e..d5ce0ac43377 100644
--- a/drivers/gpu/drm/i915/display/intel_display_reset.c
+++ b/drivers/gpu/drm/i915/display/intel_display_reset.c
@@ -14,14 +14,6 @@
 #include "intel_hotplug.h"
 #include "intel_pps.h"
 
-static bool gpu_reset_clobbers_display(struct intel_display *display)
-{
-	struct drm_i915_private *i915 = to_i915(display->drm);
-
-	return (INTEL_INFO(i915)->gpu_reset_clobbers_display &&
-		intel_has_gpu_reset(to_gt(i915)));
-}
-
 bool intel_display_reset_test(struct intel_display *display)
 {
 	return display->params.force_reset_modeset_test;
@@ -83,7 +75,7 @@ bool intel_display_reset_prepare(struct intel_display *display)
 	return true;
 }
 
-void intel_display_reset_finish(struct intel_display *display)
+void intel_display_reset_finish(struct intel_display *display, bool test_only)
 {
 	struct drm_i915_private *i915 = to_i915(display->drm);
 	struct drm_modeset_acquire_ctx *ctx = &display->restore.reset_ctx;
@@ -98,7 +90,7 @@ void intel_display_reset_finish(struct intel_display *display)
 		goto unlock;
 
 	/* reset doesn't touch the display */
-	if (!gpu_reset_clobbers_display(display)) {
+	if (test_only) {
 		/* for testing only restore the display */
 		ret = drm_atomic_helper_commit_duplicated_state(state, ctx);
 		if (ret) {
diff --git a/drivers/gpu/drm/i915/display/intel_display_reset.h b/drivers/gpu/drm/i915/display/intel_display_reset.h
index 311b5af8ca0c..f518147199a1 100644
--- a/drivers/gpu/drm/i915/display/intel_display_reset.h
+++ b/drivers/gpu/drm/i915/display/intel_display_reset.h
@@ -12,6 +12,6 @@ struct intel_display;
 
 bool intel_display_reset_test(struct intel_display *display);
 bool intel_display_reset_prepare(struct intel_display *display);
-void intel_display_reset_finish(struct intel_display *display);
+void intel_display_reset_finish(struct intel_display *display, bool test_only);
 
 #endif /* __INTEL_RESET_H__ */
diff --git a/drivers/gpu/drm/i915/gt/intel_reset.c b/drivers/gpu/drm/i915/gt/intel_reset.c
index 23f3fdaadb33..9a92afcd9b0b 100644
--- a/drivers/gpu/drm/i915/gt/intel_reset.c
+++ b/drivers/gpu/drm/i915/gt/intel_reset.c
@@ -1437,7 +1437,7 @@ static void intel_gt_reset_global(struct intel_gt *gt,
 		intel_gt_reset(gt, engine_mask, reason);
 
 		if (reset_display)
-			intel_display_reset_finish(display);
+			intel_display_reset_finish(display, !need_display_reset);
 	}
 
 	if (!test_bit(I915_WEDGED, &gt->reset.flags))
-- 
2.52.0

