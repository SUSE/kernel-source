From: Heiko Carstens <hca@linux.ibm.com>
Date: Mon, 11 Sep 2023 21:39:59 +0200
Subject: s390/ctlreg: add local_ctl_load() and local_ctl_store()
Git-commit: dfa33ce1245a4b88402947fa0a847e179044d2fc
Patch-mainline: v6.7-rc1
References: jsc#PED-10248

Add local_ctl_load() and local_ctl_store() which load and store contents
for only a single control register.

This allows for easier to read code, but also better type checking,
since __local_ctl_load() and __local_ctl_store() do not come with any
type checking at all (which will be changed with subsequent patches).

Reviewed-by: Alexander Gordeev <agordeev@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Vasily Gorbik <gor@linux.ibm.com>
Acked-by: Miroslav Franc <mfranc@suse.cz>
---
 arch/s390/include/asm/ctl_reg.h | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/arch/s390/include/asm/ctl_reg.h b/arch/s390/include/asm/ctl_reg.h
index 09d35ab3d1ce..e8e5aef08bfd 100644
--- a/arch/s390/include/asm/ctl_reg.h
+++ b/arch/s390/include/asm/ctl_reg.h
@@ -69,6 +69,23 @@
 		: "i" (low), "i" (high));				\
 } while (0)
 
+static __always_inline void local_ctl_load(unsigned int cr, unsigned long *reg)
+{
+	asm volatile(
+		"	lctlg	%[cr],%[cr],%[reg]\n"
+		:
+		: [reg] "Q" (*reg), [cr] "i" (cr)
+		: "memory");
+}
+
+static __always_inline void local_ctl_store(unsigned int cr, unsigned long *reg)
+{
+	asm volatile(
+		"	stctg	%[cr],%[cr],%[reg]\n"
+		: [reg] "=Q" (*reg)
+		: [cr] "i" (cr));
+}
+
 static __always_inline void __ctl_set_bit(unsigned int cr, unsigned int bit)
 {
 	unsigned long reg;

