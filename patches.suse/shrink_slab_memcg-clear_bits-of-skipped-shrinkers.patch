From: Michal Koutný <mkoutny@suse.com>
Date: Thu, 29 Jan 2026 16:48:15 +0100
Subject: shrink_slab_memcg: clear_bits of skipped shrinkers
Patch-mainline: Never, inadvertedly fixed more intrusively by commit 307bececcd12
References: bsc#1256564

When shrinker bitmap is grown expand_one_shrinker_info() will set all bits in
all cgroups in their shrinker bitmaps. When nokmem is enabled, these bits will
never get cleared which results in excessive time spent in memcg slab reclaim
calling idr_find() and looking at shrinker->flags.

Modify shrink_slab_memcg() to clear the bit if we decided there's nothing to
shrink due to nokmem.  This way we reduce useless work in shrink_slab(). This
should not affect whether all shrinkers are properly scanned and shrunk.

Suggested-by: Jan Kára <jack@suse.cz>
Signed-off-by: Michal Koutný <mkoutny@suse.com>
---
 mm/vmscan.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/mm/vmscan.c b/mm/vmscan.c
index 2f8b3715d5f15..5588e9c21776c 100644
--- a/mm/vmscan.c
+++ b/mm/vmscan.c
@@ -965,8 +965,10 @@ static unsigned long shrink_slab_memcg(gfp_t gfp_mask, int nid,
 
 		/* Call non-slab shrinkers even though kmem is disabled */
 		if (!memcg_kmem_online() &&
-		    !(shrinker->flags & SHRINKER_NONSLAB))
+		    !(shrinker->flags & SHRINKER_NONSLAB)) {
+			clear_bit(i, info->map);
 			continue;
+		}
 
 		ret = do_shrink_slab(&sc, shrinker, priority);
 		if (ret == SHRINK_EMPTY) {

