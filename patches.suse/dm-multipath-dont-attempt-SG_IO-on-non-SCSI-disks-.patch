From aba352149b4d38d6f01dd4aaa9829f3a28b13d51 Mon Sep 17 00:00:00 2001
From: Martin Wilck <mwilck@suse.com>
Date: Fri, 17 May 2024 17:47:48 +0200
Subject: [PATCH] dm-multipath: dont't attempt SG_IO on non-SCSI-disks
Patch-mainline: Never, fix for patches.suse/dm_blk_ioctl-implement-path-failover-for-SG_IO.patch
References: bsc#1223575

Signed-off-by: Martin Wilck <mwilck@suse.com>
---
 drivers/md/dm-mpath.c |   16 ++++++++++++++++
 1 file changed, 16 insertions(+)

--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@ -29,6 +29,7 @@
 #include <scsi/sg.h>
 #include <linux/atomic.h>
 #include <linux/blk-mq.h>
+#include <uapi/linux/major.h>
 
 #define DM_MSG_PREFIX "multipath"
 #define DM_PG_INIT_DELAY_MSECS 2000
@@ -2289,6 +2290,15 @@ enum {
 	SG_IO_SWITCH_PATH,
 };
 
+static bool is_scsi_disk(const struct block_device *path_dev)
+{
+	int major = path_dev->bd_disk->major;
+
+	return major == SCSI_DISK0_MAJOR ||
+		(major >= SCSI_DISK1_MAJOR && major <= SCSI_DISK7_MAJOR) ||
+		(major >= SCSI_DISK8_MAJOR && major <= SCSI_DISK15_MAJOR);
+}
+
 static int path_sg_io(const struct block_device *path_dev,
 		      struct sg_io_hdr *hdr, fmode_t mode)
 {
@@ -2296,6 +2306,12 @@ static int path_sg_io(const struct block
 	blk_status_t blkstat;
 	int rc;
 
+	if (!is_scsi_disk(path_dev)) {
+		dev_warn_ratelimited(&path_dev->bd_disk->part0->bd_device,
+				     "attempt to do SG_IO on non-SCSI device\n");
+		return -EINVAL;
+	}
+
 	sdev = path_dev->bd_disk->queue->queuedata;
 	rc = sg_io(sdev, hdr, mode);
 
