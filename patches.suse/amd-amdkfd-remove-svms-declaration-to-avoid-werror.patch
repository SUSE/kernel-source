From: Alex Sierra <alex.sierra@amd.com>
Date: Thu, 30 Sep 2021 10:38:08 -0500
Subject: amd/amdkfd: remove svms declaration to avoid werror
Git-commit: 7e3fb209d518112628f3f5abd6e66053ac4b0767
Patch-mainline: v5.16-rc1
References: jsc#PED-1294, bsc#1204363, CVE-2022-3523

svm_range_list svms declaration removed to avoid werror when
CONFIG_HSA_AMD_SVM is not enabled.

Signed-off-by: Alex Sierra <alex.sierra@amd.com>
Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Vlastimil Babka <vbabka@suse.cz>
---
 drivers/gpu/drm/amd/amdkfd/kfd_chardev.c |   11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

--- a/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c
+++ b/drivers/gpu/drm/amd/amdkfd/kfd_chardev.c
@@ -1251,7 +1251,6 @@ static int kfd_ioctl_alloc_memory_of_gpu
 	struct kfd_process_device *pdd;
 	void *mem;
 	struct kfd_dev *dev;
-	struct svm_range_list *svms = &p->svms;
 	int idr_handle;
 	long err;
 	uint64_t offset = args->mmap_offset;
@@ -1264,18 +1263,18 @@ static int kfd_ioctl_alloc_memory_of_gpu
 	/* Flush pending deferred work to avoid racing with deferred actions
 	 * from previous memory map changes (e.g. munmap).
 	 */
-	svm_range_list_lock_and_flush_work(svms, current->mm);
-	mutex_lock(&svms->lock);
+	svm_range_list_lock_and_flush_work(&p->svms, current->mm);
+	mutex_lock(&p->svms.lock);
 	mmap_write_unlock(current->mm);
-	if (interval_tree_iter_first(&svms->objects,
+	if (interval_tree_iter_first(&p->svms.objects,
 				     args->va_addr >> PAGE_SHIFT,
 				     (args->va_addr + args->size - 1) >> PAGE_SHIFT)) {
 		pr_err("Address: 0x%llx already allocated by SVM\n",
 			args->va_addr);
-		mutex_unlock(&svms->lock);
+		mutex_unlock(&p->svms.lock);
 		return -EADDRINUSE;
 	}
-	mutex_unlock(&svms->lock);
+	mutex_unlock(&p->svms.lock);
 #endif
 	dev = kfd_device_by_id(args->gpu_id);
 	if (!dev)
