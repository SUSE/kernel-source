From: Ming Lei <ming.lei@redhat.com>
Date: Fri, 11 Jul 2025 16:30:09 +0800
Subject: block: fix kobject leak in blk_unregister_queue
Git-commit: 3051247e4faa32a3d90c762a243c2c62dde310db
Patch-mainline: v6.16-rc7
References: git-fixes

The kobject for the queue, `disk->queue_kobj`, is initialized with a
reference count of 1 via `kobject_init()` in `blk_register_queue()`.
While `kobject_del()` is called during the unregister path to remove
the kobject from sysfs, the initial reference is never released.

Add a call to `kobject_put()` in `blk_unregister_queue()` to properly
decrement the reference count and fix the leak.

[lduncan: applied with fuzz=1]
Fixes: 2bd85221a625 ("block: untangle request_queue refcounting from sysfs")
Cc: Christoph Hellwig <hch@lst.de>
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Link: https://lore.kernel.org/r/20250711083009.2574432-1-ming.lei@redhat.com
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Lee Duncan <lduncan@suse.com>
---
 block/blk-sysfs.c |    1 +
 1 file changed, 1 insertion(+)

--- a/block/blk-sysfs.c
+++ b/block/blk-sysfs.c
@@ -876,4 +876,5 @@ void blk_unregister_queue(struct gendisk
 	kobject_del(&disk->queue_kobj);
 
 	blk_debugfs_remove(disk);
+	kobject_put(&disk->queue_kobj);
 }
