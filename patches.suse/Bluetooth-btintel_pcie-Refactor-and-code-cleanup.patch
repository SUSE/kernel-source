From 6a486c1361ea588938898ae812b32dcfbd4022f2 Mon Sep 17 00:00:00 2001
From: Kiran K <kiran.k@intel.com>
Date: Sat, 11 May 2024 11:10:59 +0530
Subject: [PATCH] Bluetooth: btintel_pcie: Refactor and code cleanup
Git-commit: 6a486c1361ea588938898ae812b32dcfbd4022f2
Patch-mainline: v6.10-rc1
References: jsc#PED-10412

Minor refactor and s/TX_WAIT_TIMEOUT_MS/BTINTEL_PCIE_TX_WAIT_TIMEOUT_MS/g.

Fixes: 6e65a09f9275 ("Bluetooth: btintel_pcie: Add *setup* function to download firmware")
Signed-off-by: Kiran K <kiran.k@intel.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/bluetooth/btintel_pcie.c | 7 +++----
 drivers/bluetooth/btintel_pcie.h | 2 +-
 2 files changed, 4 insertions(+), 5 deletions(-)

diff --git a/drivers/bluetooth/btintel_pcie.c b/drivers/bluetooth/btintel_pcie.c
index 030a75e5d2a3..5b6805d87fcf 100644
--- a/drivers/bluetooth/btintel_pcie.c
+++ b/drivers/bluetooth/btintel_pcie.c
@@ -151,7 +151,7 @@ static int btintel_pcie_send_sync(struct btintel_pcie_data *data,
 
 	/* Wait for the complete interrupt - URBD0 */
 	ret = wait_event_timeout(data->tx_wait_q, data->tx_wait_done,
-				 msecs_to_jiffies(TX_WAIT_TIMEOUT_MS));
+				 msecs_to_jiffies(BTINTEL_PCIE_TX_WAIT_TIMEOUT_MS));
 	if (!ret)
 		return -ETIME;
 
@@ -1096,10 +1096,9 @@ static int btintel_pcie_send_frame(struct hci_dev *hdev,
 		hdev->stat.err_tx++;
 		bt_dev_err(hdev, "Failed to send frame (%d)", ret);
 		goto exit_error;
-	} else {
-		hdev->stat.byte_tx += skb->len;
-		kfree_skb(skb);
 	}
+	hdev->stat.byte_tx += skb->len;
+	kfree_skb(skb);
 
 exit_error:
 	return ret;
diff --git a/drivers/bluetooth/btintel_pcie.h b/drivers/bluetooth/btintel_pcie.h
index 0e596e094f80..baaff70420f5 100644
--- a/drivers/bluetooth/btintel_pcie.h
+++ b/drivers/bluetooth/btintel_pcie.h
@@ -87,7 +87,7 @@ enum {
 /* DMA allocation alignment */
 #define BTINTEL_PCIE_DMA_POOL_ALIGNMENT	256
 
-#define TX_WAIT_TIMEOUT_MS	500
+#define BTINTEL_PCIE_TX_WAIT_TIMEOUT_MS		500
 
 /* Doorbell vector for TFD */
 #define BTINTEL_PCIE_TX_DB_VEC	0
-- 
2.43.0

