From 657687539415b1521e45e8d3c6c0b2c1e5305298 Mon Sep 17 00:00:00 2001
From: Yang Yingliang <yangyingliang@huawei.com>
Date: Fri, 28 Jul 2023 16:57:23 +0800
Subject: [PATCH] 8250_men_mcb: fix error handling in
 read_uarts_available_from_reg()

References: bsc#1214683 (PREEMPT_RT prerequisite backports)
Patch-mainline: v6.6-rc1
Git-commit: 5f45b336fc57cb31c81d2eb4a63008ab65840a2b

If ioremap() fails, it returns NULL pointer, not ERR_PTR(), fix the
return value check and call release_mem_region() to release resource.

Fixes: c563831ba879 ("8250_men_mcb: Make UART config auto configurable")
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Link: https://lore.kernel.org/r/20230728085723.3195044-1-yangyingliang@huawei.com
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 drivers/tty/serial/8250/8250_men_mcb.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/drivers/tty/serial/8250/8250_men_mcb.c b/drivers/tty/serial/8250/8250_men_mcb.c
index c3143ffddea0..5f301195575d 100644
--- a/drivers/tty/serial/8250/8250_men_mcb.c
+++ b/drivers/tty/serial/8250/8250_men_mcb.c
@@ -94,8 +94,11 @@ static int read_uarts_available_from_register(struct resource *mem_res,
 
 	mem = ioremap(mem_res->start + MEN_Z025_REGISTER_OFFSET,
 		      MEM_UART_REGISTER_SIZE);
-	if (IS_ERR(mem))
+	if (!mem) {
+		release_mem_region(mem_res->start + MEN_Z025_REGISTER_OFFSET,
+				   MEM_UART_REGISTER_SIZE);
 		return -ENOMEM;
+	}
 
 	reg_value = MEN_READ_REGISTER(mem);
 
