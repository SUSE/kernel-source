From: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Subject: tools/power/x86/intel-speed-select: Set TRL MSR in 100 MHz units
References: jsc#PED-10347
Patch-Mainline: v6.11-rc1
Git-commit: fd77d7fde0818bcc70b63f99c306e5a0f0d3f1a2

When SST-TF is disabled in auto mode, the performance is getting
limited.

This is caused by wrong programming of Turbo Ratio Limit (TRL) MSR.

This MSR always accepts the frequency ratio in 100 MHz unit. When the
TPMI is sending TRL in 1 MHz unit, change to 100 MHz, before updating
TRL MSR.

Signed-off-by: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>


Signed-off-by:  <trenn@suse.com>
---
 tools/power/x86/intel-speed-select/isst-core.c |    6 ++++++
 1 file changed, 6 insertions(+)

--- a/tools/power/x86/intel-speed-select/isst-core.c
+++ b/tools/power/x86/intel-speed-select/isst-core.c
@@ -283,6 +283,8 @@ int isst_set_trl(struct isst_id *id, uns
 	return 0;
 }
 
+#define MSR_TRL_FREQ_MULTIPLIER		100
+
 int isst_set_trl_from_current_tdp(struct isst_id *id, unsigned long long trl)
 {
 	unsigned long long msr_trl;
@@ -310,6 +312,10 @@ int isst_set_trl_from_current_tdp(struct
 		for (i = 0; i < 8; ++i) {
 			unsigned long long _trl = trl[i];
 
+			/* MSR is always in 100 MHz unit */
+			if (isst_get_disp_freq_multiplier() == 1)
+				_trl /= MSR_TRL_FREQ_MULTIPLIER;
+
 			msr_trl |= (_trl << (i * 8));
 		}
 	}
