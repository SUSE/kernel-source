From: Nirmal Patel <nirmal.patel@linux.intel.com>
Date: Mon, 2 May 2022 01:48:59 -0700
Subject: [PATCH] PCI: vmd: Assign VMD IRQ domain before enumeration
Message-Id: <20220502084900.7903-2-nirmal.patel@linux.intel.com>
Patch-mainline: Submitted, linux-pci ML
References: bsc#1199405

VMD creates and assigns a separate IRQ domain when MSI-X remapping is
enabled. For example VMD-MSI. But VMD doesn't assign IRQ domain when
MSI-X remapping is disabled resulting child devices getting default
PCI-MSI IRQ domain. Now when interrupt remapping is enabled by
intel-iommu all the PCI devices are assigned INTEL-IR-MSI domain
including VMD endpoints. But devices behind VMD get PCI-MSI IRQ domain
when VMD create a root bus and configures child devices.

As a result DMAR errors were observed when interrupt remapping was
enabled on Intel Icelake CPUs. For instance:

  DMAR: DRHD: handling fault status reg 2
  DMAR: [INTR-REMAP] Request device [0xe2:0x00.0] fault index 0xa00 [fault reason 0x25] Blocked a compatibility format interrupt request

Signed-off-by: Nirmal Patel <nirmal.patel@linux.intel.com>
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/pci/controller/vmd.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/drivers/pci/controller/vmd.c
+++ b/drivers/pci/controller/vmd.c
@@ -748,6 +748,9 @@ static int vmd_enable_domain(struct vmd_
 	vmd_attach_resources(vmd);
 	if (vmd->irq_domain)
 		dev_set_msi_domain(&vmd->bus->dev, vmd->irq_domain);
+	else
+		dev_set_msi_domain(&vmd->bus->dev,
+				   dev_get_msi_domain(&vmd->dev->dev));
 
 	pci_scan_child_bus(vmd->bus);
 	pci_assign_unassigned_bus_resources(vmd->bus);
