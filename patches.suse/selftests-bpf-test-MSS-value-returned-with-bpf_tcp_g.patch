From: =?UTF-8?q?Alexis=20Lothor=C3=A9=20=28eBPF=20Foundation=29?=
Date: Sun, 20 Oct 2024 21:22:57 +0200
 <alexis.lothore@bootlin.com>
Subject: selftests/bpf: test MSS value returned with bpf_tcp_gen_syncookie
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Patch-mainline: v6.13-rc1
Git-commit: 3845ce74777eeb94892cdeedaf4b76e2341f3f42
References: jsc#PED-14653

One remaining difference between test_tcp_check_syncookie.sh and
btf_skc_cls_ingress is a small test on the mss value embedded in the
cookie generated with the eBPF helper.

Bring the corresponding test in btf_skc_cls_ingress.

Signed-off-by: Alexis Lothor√© (eBPF Foundation) <alexis.lothore@bootlin.com>
Link: https://lore.kernel.org/r/20241020-syncookie-v2-5-2db240225fed@bootlin.com
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Acked-by: Hoyeon Lee <hoyeon.lee@suse.com>
---
 tools/testing/selftests/bpf/prog_tests/btf_skc_cls_ingress.c |    7 +++++++
 tools/testing/selftests/bpf/progs/test_btf_skc_cls_ingress.c |    2 ++
 2 files changed, 9 insertions(+)

--- a/tools/testing/selftests/bpf/prog_tests/btf_skc_cls_ingress.c
+++ b/tools/testing/selftests/bpf/prog_tests/btf_skc_cls_ingress.c
@@ -27,6 +27,8 @@
 #define SERVER_ADDR_IPV4	"127.0.0.1"
 #define SERVER_ADDR_IPV6	"::1"
 #define SERVER_ADDR_DUAL	"::0"
+/* RFC791, 576 for minimal IPv4 datagram, minus 40 bytes of TCP header */
+#define MIN_IPV4_MSS		536
 
 static struct netns_obj *prepare_netns(struct test_btf_skc_cls_ingress *skel)
 {
@@ -71,6 +73,7 @@ static void reset_test(struct test_btf_s
 	skel->bss->recv_cookie = 0;
 	skel->bss->gen_cookie = 0;
 	skel->bss->linum = 0;
+	skel->bss->mss = 0;
 }
 
 static void print_err_line(struct test_btf_skc_cls_ingress *skel)
@@ -183,6 +186,10 @@ static void run_test(struct test_btf_skc
 			   "syncookie properly generated");
 		ASSERT_EQ(skel->bss->gen_cookie, skel->bss->recv_cookie,
 			  "matching syncookies on client and server");
+		ASSERT_GT(skel->bss->mss, MIN_IPV4_MSS,
+			  "MSS in cookie min value");
+		ASSERT_LT(skel->bss->mss, USHRT_MAX,
+			  "MSS in cookie max value");
 	}
 
 done:
--- a/tools/testing/selftests/bpf/progs/test_btf_skc_cls_ingress.c
+++ b/tools/testing/selftests/bpf/progs/test_btf_skc_cls_ingress.c
@@ -15,6 +15,7 @@ __u16 listen_tp_sport = 0;
 __u16 req_sk_sport = 0;
 __u32 recv_cookie = 0;
 __u32 gen_cookie = 0;
+__u32 mss = 0;
 __u32 linum = 0;
 
 #define LOG() ({ if (!linum) linum = __LINE__; })
@@ -46,6 +47,7 @@ static void test_syncookie_helper(void *
 				LOG();
 		} else {
 			gen_cookie = (__u32)mss_cookie;
+			mss = mss_cookie >> 32;
 		}
 	} else if (gen_cookie) {
 		/* It was in cookie mode */
