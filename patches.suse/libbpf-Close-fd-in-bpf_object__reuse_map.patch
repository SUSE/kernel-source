From: Hengqi Chen <hengqi.chen@gmail.com>
Date: Sat, 19 Mar 2022 11:05:33 +0800
Subject: libbpf: Close fd in bpf_object__reuse_map
Patch-mainline: v5.18-rc1
Git-commit: d0f325c34c2fbe15f6774f2b628224280b571ae9
References: jsc#PED-1368

pin_fd is dup-ed and assigned in bpf_map__reuse_fd. Close it
in bpf_object__reuse_map after reuse.

Signed-off-by: Hengqi Chen <hengqi.chen@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Link: https://lore.kernel.org/bpf/20220319030533.3132250-1-hengqi.chen@gmail.com
Acked-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
---
 tools/lib/bpf/libbpf.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/tools/lib/bpf/libbpf.c
+++ b/tools/lib/bpf/libbpf.c
@@ -4823,8 +4823,8 @@ bpf_object__reuse_map(struct bpf_map *ma
 	}
 
 	err = bpf_map__reuse_fd(map, pin_fd);
+	close(pin_fd);
 	if (err) {
-		close(pin_fd);
 		return err;
 	}
 	map->pinned = true;
