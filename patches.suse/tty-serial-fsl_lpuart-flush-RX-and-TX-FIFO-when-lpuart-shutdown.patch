From: Sherry Sun <sherry.sun@nxp.com>
Date: Tue, 7 Jan 2025 15:48:34 +0800
Subject: tty: serial: fsl_lpuart: flush RX and TX FIFO when lpuart shutdown
Git-commit: d78a89990986a4d7d34313d3f58f8596b8ae1222
Patch-mainline: v6.14-rc1
References: jsc#PED-12016

Need to flush UART RX and TX FIFO when lpuart is shutting down to make
sure restore a clean data transfer environment.

Signed-off-by: Sherry Sun <sherry.sun@nxp.com>
Link: https://lore.kernel.org/r/20250107074834.3115230-1-sherry.sun@nxp.com
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Acked-by: Ivan T. Ivanov <iivanov@suse.de>
---
 drivers/tty/serial/fsl_lpuart.c |    5 +++++
 1 file changed, 5 insertions(+)

--- a/drivers/tty/serial/fsl_lpuart.c
+++ b/drivers/tty/serial/fsl_lpuart.c
@@ -1965,6 +1965,11 @@ static void lpuart32_shutdown(struct uar
 			UARTCTRL_TIE | UARTCTRL_TCIE | UARTCTRL_RIE | UARTCTRL_SBK);
 	lpuart32_write(port, temp, UARTCTRL);
 
+	/* flush Rx/Tx FIFO */
+	temp = lpuart32_read(port, UARTFIFO);
+	temp |= UARTFIFO_TXFLUSH | UARTFIFO_RXFLUSH;
+	lpuart32_write(port, temp, UARTFIFO);
+
 	uart_port_unlock_irqrestore(port, flags);
 
 	lpuart_dma_shutdown(sport);
