From: Jens Axboe <axboe@kernel.dk>
Date: Wed, 11 Aug 2021 10:19:06 -0600
Subject: [PATCH] block: clear BIO_PERCPU_CACHE flag if polling isn't supported
Git-commit: be863b9e4348a791e360d25611a1bdde2c9595ed
Patch-mainline: v5.15-rc1
References: jsc#PED-1183

The bio alloc cache relies on the fact that a polled bio will complete
in process context, clear the cacheable flag if we disable polling
for a given bio.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Hannes Reinecke <hare@suse.com>
---
 block/blk-core.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/block/blk-core.c b/block/blk-core.c
index 4f8449b29b21..0d4d6b1e5d25 100644
--- a/block/blk-core.c
+++ b/block/blk-core.c
@@ -832,8 +832,11 @@ static noinline_for_stack bool submit_bio_checks(struct bio *bio)
 		}
 	}
 
-	if (!test_bit(QUEUE_FLAG_POLL, &q->queue_flags))
+	if (!test_bit(QUEUE_FLAG_POLL, &q->queue_flags)) {
+		/* can't support alloc cache if we turn off polling */
+		bio_clear_flag(bio, BIO_PERCPU_CACHE);
 		bio->bi_opf &= ~REQ_HIPRI;
+	}
 
 	switch (bio_op(bio)) {
 	case REQ_OP_DISCARD:
-- 
2.35.3

