From: Peter Gonda <pgonda@google.com>
Date: Thu, 17 Mar 2022 14:19:13 -0700
Subject: x86/sev-es: Replace open-coded hlt-loop with sev_es_terminate()
Git-commit: e720ea52e85c9d00cf8c5769795d0a3e585524f6
Patch-mainline: v5.19-rc1
References: jsc#PED-7167

Replace the halt loop in handle_vc_boot_ghcb() with an
sev_es_terminate(). The HLT gives the system no indication the guest is
unhappy. The termination request will signal there was an error during
VC handling during boot.

  [ bp: Update it to pass the reason set too. ]

Signed-off-by: Peter Gonda <pgonda@google.com>
Signed-off-by: Borislav Petkov <bp@suse.de>
Reviewed-by: Joerg Roedel <jroedel@suse.de>
Link: https://lore.kernel.org/r/20220317211913.1397427-1-pgonda@google.com

Signed-off-by: Vlastimil Babka <vbabka@suse.cz>
---
 arch/x86/kernel/sev.c |    3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

--- a/arch/x86/kernel/sev.c
+++ b/arch/x86/kernel/sev.c
@@ -1982,8 +1982,7 @@ bool __init handle_vc_boot_ghcb(struct p
 fail:
 	show_regs(regs);
 
-	while (true)
-		halt();
+	sev_es_terminate(SEV_TERM_SET_GEN, GHCB_SEV_ES_GEN_REQ);
 }
 
 /*
