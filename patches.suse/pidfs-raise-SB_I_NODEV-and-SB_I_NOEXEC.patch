From: Christian Brauner <brauner@kernel.org>
Date: Wed, 18 Jun 2025 22:53:35 +0200
Subject: pidfs: raise SB_I_NODEV and SB_I_NOEXEC
Git-commit: 1a1ad73aa1a66787f05f7f10f686b74bab77be72
Patch-mainline: v6.17-rc1
References: bsc#1249562

Similar to commit 1ed95281c0c7 ("anon_inode: raise SB_I_NODEV and SB_I_NOEXEC"):
it shouldn't be possible to execute pidfds via
execveat(fd_anon_inode, "", NULL, NULL, AT_EMPTY_PATH)
so raise SB_I_NOEXEC so that no one gets any creative ideas.

Also raise SB_I_NODEV as we don't expect or support any devices on pidfs.

Link: https://lore.kernel.org/20250618-work-pidfs-persistent-v2-1-98f3456fd552@kernel.org
Reviewed-by: Alexander Mikhalitsyn <aleksandr.mikhalitsyn@canonical.com>
Signed-off-by: Christian Brauner <brauner@kernel.org>
Acked-by: Michal Koutn√Ω <mkoutny@suse.com>
---
 fs/pidfs.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/fs/pidfs.c
+++ b/fs/pidfs.c
@@ -629,6 +629,8 @@ static int pidfs_init_fs_context(struct
 	if (!ctx)
 		return -ENOMEM;
 
+	fc->s_iflags |= SB_I_NOEXEC;
+	fc->s_iflags |= SB_I_NODEV;
 	ctx->ops = &pidfs_sops;
 	ctx->dops = &pidfs_dentry_operations;
 	fc->s_fs_info = (void *)&pidfs_stashed_ops;
