From 9adc92c20d4932e1d4359d238198712876aa8db1 Mon Sep 17 00:00:00 2001
From: Thomas Zimmermann <tzimmermann@suse.de>
Date: Mon, 10 Jan 2022 15:49:45 +0100
Subject: firmware/sysfb: Add parameter to enable sysfb support
Patch-mainline: Never, only for SLE
References: jsc#SLE-18823

Add kernel parameter enable_sysfb that enables sysfb support via
simple-framebuffer devices. Strictly for testing in SLE15-SP4.
DO NOT UPSTREAM!!!

Signed-off-by: Thomas Zimmermann <tzimmermann@suse.de>
Acked-by: Thomas Zimmermann <tzimmermann@suse.de>
---
 drivers/firmware/sysfb_simplefb.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/drivers/firmware/sysfb_simplefb.c b/drivers/firmware/sysfb_simplefb.c
index b86761904949..cf249f216b3d 100644
--- a/drivers/firmware/sysfb_simplefb.c
+++ b/drivers/firmware/sysfb_simplefb.c
@@ -22,6 +22,15 @@
 
 static const char simplefb_resname[] = "BOOTFB";
 static const struct simplefb_format formats[] = SIMPLEFB_FORMATS;
+static bool enable_sysfb;
+
+static int __init do_enable_sysfb(char *str)
+{
+	enable_sysfb = true;
+
+	return 1;
+}
+__setup("enable_sysfb", do_enable_sysfb);
 
 /* try parsing screen_info into a simple-framebuffer mode struct */
 __init bool sysfb_parse_mode(const struct screen_info *si,
@@ -31,6 +40,9 @@ __init bool sysfb_parse_mode(const struct screen_info *si,
 	__u8 type;
 	unsigned int i;
 
+	if (!enable_sysfb)
+		return false;
+
 	type = si->orig_video_isVGA;
 	if (type != VIDEO_TYPE_VLFB && type != VIDEO_TYPE_EFI)
 		return false;
-- 
2.34.1

