From: Niklas Schnelle <schnelle@linux.ibm.com>
Date: Thu, 8 Jul 2021 15:43:13 +0200
Subject: s390: add HWCAP_S390_PCI_MIO to ELF hwcaps
Git-commit: 7e8403ecaf884f307b627f3c371475913dd29292
Patch-mainline: v5.15-rc1
References: jsc#SLE-23099

In order to support the use of enhanced PCI instructions in both kernel-
and userspace we need both hardware support and proper setup in the
kernel. The latter can be toggled off with the pci=nomio command line
option.

Thus availability of this feature in userspace depends on all of kernel
configuration (CONFIG_PCI), hardware support and the current kernel
command line and can thus not rely solely on a facility bit. Instead
let's introduce a new ELF hardware capability bit HWCAP_S390_PCI_MIO to
tell userspace whether these PCI instructions can be used.

Reviewed-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Niklas Schnelle <schnelle@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
Acked-by: Petr Tesarik <ptesarik@suse.com>
---
 arch/s390/include/asm/elf.h  |    1 +
 arch/s390/kernel/processor.c |    2 +-
 arch/s390/kernel/setup.c     |    2 ++
 3 files changed, 4 insertions(+), 1 deletion(-)

--- a/arch/s390/include/asm/elf.h
+++ b/arch/s390/include/asm/elf.h
@@ -113,6 +113,7 @@
 #define HWCAP_S390_DFLT		262144
 #define HWCAP_S390_VXRS_PDE2	524288
 #define HWCAP_S390_NNPA		1048576
+#define HWCAP_S390_PCI_MIO	2097152
 
 /* Internal bits, not exposed via elf */
 #define HWCAP_INT_SIE		1UL
--- a/arch/s390/kernel/processor.c
+++ b/arch/s390/kernel/processor.c
@@ -115,7 +115,7 @@ static void show_cpu_summary(struct seq_
 	static const char *hwcap_str[] = {
 		"esan3", "zarch", "stfle", "msa", "ldisp", "eimm", "dfp",
 		"edat", "etf3eh", "highgprs", "te", "vx", "vxd", "vxe", "gs",
-		"vxe2", "vxp", "sort", "dflt", "vxp2", "nnpa"
+		"vxe2", "vxp", "sort", "dflt", "vxp2", "nnpa", "pcimio"
 	};
 	static const char * const int_hwcap_str[] = {
 		"sie"
--- a/arch/s390/kernel/setup.c
+++ b/arch/s390/kernel/setup.c
@@ -869,6 +869,8 @@ static int __init setup_hwcaps(void)
 	 */
 	if (MACHINE_HAS_GS)
 		elf_hwcap |= HWCAP_S390_GS;
+	if (MACHINE_HAS_PCI_MIO)
+		elf_hwcap |= HWCAP_S390_PCI_MIO;
 
 	get_cpu_id(&cpu_id);
 	add_device_randomness(&cpu_id, sizeof(cpu_id));
