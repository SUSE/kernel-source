From: Vadim Fedorenko <vadfed@meta.com>
Date: Tue, 4 Jun 2024 02:19:39 -0700
Subject: bnxt_en: fix atomic counter for ptp packets
Patch-mainline: v6.11-rc1
Git-commit: c790275b5edf5d8280ae520bda7c1f37da460c00
References: jsc#PED-11221

atomic_dec_if_positive returns new value regardless if it is updated or
not. The commit in fixes changed the behavior of the condition to one
that differs from original code. Restore original condition to properly
maintain atomic counter.

Fixes: 165f87691a89 ("bnxt_en: add timestamping statistics support")
Reviewed-by: Michael Chan <michael.chan@broadcom.com>
Signed-off-by: Vadim Fedorenko <vadfed@meta.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: https://lore.kernel.org/r/20240604091939.785535-1-vadfed@meta.com
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 drivers/net/ethernet/broadcom/bnxt/bnxt.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/drivers/net/ethernet/broadcom/bnxt/bnxt.c
+++ b/drivers/net/ethernet/broadcom/bnxt/bnxt.c
@@ -513,7 +513,7 @@ static netdev_tx_t bnxt_start_xmit(struc
 		struct bnxt_ptp_cfg *ptp = bp->ptp_cfg;
 
 		if (ptp && ptp->tx_tstamp_en && !skb_is_gso(skb)) {
-			if (!atomic_dec_if_positive(&ptp->tx_avail)) {
+			if (atomic_dec_if_positive(&ptp->tx_avail) < 0) {
 				atomic64_inc(&ptp->stats.ts_err);
 				goto tx_no_ts;
 			}
