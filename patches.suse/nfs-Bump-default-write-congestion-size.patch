From c674621b0c8e7681f5d9fbdfb80f16696f3cc06c Mon Sep 17 00:00:00 2001
From: Jan Kara <jack@suse.cz>
Date: Wed, 5 Jun 2024 18:51:43 +0200
Subject: [PATCH] nfs: Bump default write congestion size
References: bsc#1218442
Patch-mainline: Never, looking for more universal solution upstream

Limiting amount of pages under writeback from NFS client to 256 MB is
too low. The server then often ends up with its disk idle because it
takes too long for the client to receive a message about completion,
start writeback, and submit more pages. Bump the congestion size to 2GB
to keep more pages in the pipeline. This restores the performance
regression introduced by commit 6df25e58532b ("nfs: remove reliance on
bdi congestion") which essentially made NFS write throttling work
correctly.

Signed-off-by: Jan Kara <jack@suse.cz>
---
 fs/nfs/write.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/fs/nfs/write.c b/fs/nfs/write.c
index 2329cbb0e446..5fc12a721ec3 100644
--- a/fs/nfs/write.c
+++ b/fs/nfs/write.c
@@ -2173,8 +2173,8 @@ int __init nfs_init_writepagecache(void)
 	 * Limit the default to 256M
 	 */
 	nfs_congestion_kb = (16*int_sqrt(totalram_pages())) << (PAGE_SHIFT-10);
-	if (nfs_congestion_kb > 256*1024)
-		nfs_congestion_kb = 256*1024;
+	if (nfs_congestion_kb > 2048*1024)
+		nfs_congestion_kb = 2048*1024;
 
 	return 0;
 
-- 
2.35.3

