From: Daniel Wagner <dwagner@suse.de>
Date: Fri, 26 Jan 2024 08:53:17 +0100
Subject: [PATCH] scsi: lpfc: Limit IRQ vectors to online cpus if kdump kernel
Patch-mainline: Never, workaround until ppc arch gets feature
References: bsc#1218180

The PowerPC architecture does not implement nr_cpus at this point, thus
the number of vectors can exceed the number of available online CPUs.
The driver could then assign IRQ affinities to offline CPUs. IRQs
vectors assigned to offline CPUs will result in stuck queues.

To limit any side effects (e.g. performance), enable this workaround
only for kdump kernels.

Signed-off-by: Daniel Wagner <dwagner@suse.de>
---
 drivers/scsi/lpfc/lpfc_init.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/drivers/scsi/lpfc/lpfc_init.c b/drivers/scsi/lpfc/lpfc_init.c
index 2ce1ec4b4e6b..4b6f44ac9fab 100644
--- a/drivers/scsi/lpfc/lpfc_init.c
+++ b/drivers/scsi/lpfc/lpfc_init.c
@@ -13042,6 +13042,11 @@ lpfc_sli4_enable_msix(struct lpfc_hba *phba)
 		flags |= PCI_IRQ_AFFINITY;
 	}
 
+	if (is_kdump_kernel()) {
+		vectors = min_t(unsigned int,
+				vectors, cpumask_weight(cpu_online_mask));
+	}
+
 	rc = pci_alloc_irq_vectors(phba->pcidev, 1, vectors, flags);
 	if (rc < 0) {
 		lpfc_printf_log(phba, KERN_INFO, LOG_INIT,
-- 
2.35.3

