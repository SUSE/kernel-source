From e2f251f0f05ee61861c19cfff92f56d56ed3c902 Mon Sep 17 00:00:00 2001
From: Mel Gorman <mgorman@techsingularity.net>
Date: Fri, 18 Jul 2025 15:45:55 +0100
Subject: [PATCH]  sched/psi: Optimize psi_group_change() cpu_clock() usage
 KABI

References: bsc#1234634 (Scheduler functional and performance backports)
Patch-mainline: Never, kABI

The KABI conflict is due to a slight change in layout but the structure
is internal to the scheduler and PSI handling. Revert the structure
change for a small potential loss of performance and size.

Signed-off-by: Mel Gorman <mgorman@suse.de>
---
 include/linux/psi_types.h | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/include/linux/psi_types.h b/include/linux/psi_types.h
index dd10c22299ab..f1fd3a8044e0 100644
--- a/include/linux/psi_types.h
+++ b/include/linux/psi_types.h
@@ -84,9 +84,11 @@ enum psi_aggregators {
 struct psi_group_cpu {
 	/* 1st cacheline updated by the scheduler */
 
+	/* Aggregator needs to know of concurrent changes */
+	seqcount_t seq ____cacheline_aligned_in_smp;
+
 	/* States of the tasks belonging to this group */
-	unsigned int tasks[NR_PSI_TASK_COUNTS]
-			____cacheline_aligned_in_smp;
+	unsigned int tasks[NR_PSI_TASK_COUNTS];
 
 	/* Aggregate pressure state derived from the tasks */
 	u32 state_mask;
