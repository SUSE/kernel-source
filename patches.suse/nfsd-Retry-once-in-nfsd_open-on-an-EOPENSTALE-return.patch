From: Jeff Layton <jeff.layton@primarydata.com>
Date: Sat, 18 Dec 2021 20:37:56 -0500
Subject: [PATCH] nfsd: Retry once in nfsd_open on an -EOPENSTALE return
Git-commit: 12bcbd40fd931472c7fc9cf3bfe66799ece93ed8
Patch-mainline: v5.17
References: git-fixes

If we get back -EOPENSTALE from an NFSv4 open, then we either got some
unhandled error or the inode we got back was not the same as the one
associated with the dentry.

We really have no recourse in that situation other than to retry the
open, and if it fails to just return nfserr_stale back to the client.

Signed-off-by: Jeff Layton <jeff.layton@primarydata.com>
Signed-off-by: Lance Shelton <lance.shelton@hammerspace.com>
Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Acked-by: NeilBrown <neilb@suse.com>

---
 fs/nfsd/nfsproc.c |    1 +
 fs/nfsd/vfs.c     |   10 +++++++++-
 2 files changed, 10 insertions(+), 1 deletion(-)

--- a/fs/nfsd/nfsproc.c
+++ b/fs/nfsd/nfsproc.c
@@ -875,6 +875,7 @@ nfserrno (int errno)
 		{ nfserr_serverfault, -ESERVERFAULT },
 		{ nfserr_serverfault, -ENFILE },
 		{ nfserr_io, -EREMOTEIO },
+		{ nfserr_stale, -EOPENSTALE },
 		{ nfserr_io, -EUCLEAN },
 		{ nfserr_perm, -ENOKEY },
 	};
--- a/fs/nfsd/vfs.c
+++ b/fs/nfsd/vfs.c
@@ -809,6 +809,7 @@ nfsd_open(struct svc_rqst *rqstp, struct
 		int may_flags, struct file **filp)
 {
 	__be32 err;
+	bool retried = false;
 
 	validate_process_creds();
 	/*
@@ -824,9 +825,16 @@ nfsd_open(struct svc_rqst *rqstp, struct
 	 */
 	if (type == S_IFREG)
 		may_flags |= NFSD_MAY_OWNER_OVERRIDE;
+retry:
 	err = fh_verify(rqstp, fhp, type, may_flags);
-	if (!err)
+	if (!err) {
 		err = __nfsd_open(rqstp, fhp, type, may_flags, filp);
+		if (err == nfserr_stale && !retried) {
+			retried = true;
+			fh_put(fhp);
+			goto retry;
+		}
+	}
 	validate_process_creds();
 	return err;
 }
