From: Daniel Borkmann <daniel@iogearbox.net>
Date: Fri, 13 Sep 2024 21:17:51 +0200
Subject: selftests/bpf: Fix ARG_PTR_TO_LONG {half-,}uninitialized test
Patch-mainline: v6.12-rc1
Git-commit: b8e188f023e07a733b47d5865311ade51878fe40
References: git-fixes
X-Info: patches tools/testing/selftests/bpf/verifier/int_ptr.c instead of tools/testing/selftests/bpf/progs/verifier_int_ptr.c because the later does not exists without commit 01481e67dd4d "selftests/bpf: verifier/int_ptr.c converted to inline assembly"

The assumption of 'in privileged mode reads from uninitialized stack locations
are permitted' is not quite correct since the verifier was probing for read
access rather than write access. Both tests need to be annotated as __success
for privileged and unprivileged.

Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Link: https://lore.kernel.org/r/20240913191754.13290-6-daniel@iogearbox.net
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Acked-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
---
 tools/testing/selftests/bpf/verifier/int_ptr.c |    7 ++-----
 1 file changed, 2 insertions(+), 5 deletions(-)

--- a/tools/testing/selftests/bpf/verifier/int_ptr.c
+++ b/tools/testing/selftests/bpf/verifier/int_ptr.c
@@ -27,8 +27,6 @@
 	},
 	.result = ACCEPT,
 	.prog_type = BPF_PROG_TYPE_SOCKET_FILTER,
-	.result_unpriv = REJECT,
-	.errstr_unpriv = "invalid indirect read from stack R4 off -16+0 size 8",
 },
 {
 	"ARG_PTR_TO_LONG half-uninitialized",
@@ -58,9 +56,8 @@
 		BPF_MOV64_IMM(BPF_REG_0, 1),
 		BPF_EXIT_INSN(),
 	},
-	.result = REJECT,
-	.prog_type = BPF_PROG_TYPE_CGROUP_SYSCTL,
-	.errstr = "invalid indirect read from stack R4 off -16+4 size 8",
+	.result = ACCEPT,
+	.prog_type = BPF_PROG_TYPE_SOCKET_FILTER,
 },
 {
 	"ARG_PTR_TO_LONG misaligned",
