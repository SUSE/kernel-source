From 029e42ee04857ef1940a69a8c8a638fb93737e63 Mon Sep 17 00:00:00 2001
From: Hannes Reinecke <hare@suse.de>
Date: Fri, 27 Oct 2023 07:43:15 +0200
Subject: [PATCH] net/dcb: check for detached device before executing callbacks
References: bsc#1215587
Patch-mainline: Submitted, netdev ML

When a netdevice is detached there is no point in trying to execute
the dcb callbacks; at best they will return stale information, and
at worst crash the machine.

Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 net/dcb/dcbnl.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/net/dcb/dcbnl.c b/net/dcb/dcbnl.c
index 2e6b8c8fd2de..80b3b6ba5d3c 100644
--- a/net/dcb/dcbnl.c
+++ b/net/dcb/dcbnl.c
@@ -1943,7 +1943,7 @@ static int dcb_doit(struct sk_buff *skb, struct nlmsghdr *nlh,
 		return -EINVAL;
 
 	netdev = __dev_get_by_name(net, nla_data(tb[DCB_ATTR_IFNAME]));
-	if (!netdev)
+	if (!netdev || !netif_device_present(netdev))
 		return -ENODEV;
 
 	if (!netdev->dcbnl_ops)
-- 
2.35.3

