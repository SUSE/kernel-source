Patch-mainline: v6.15-rc1
Git-commit: 4944be2f5ad8c74b93e4e272f3a0f1a136bbc438
References: git-fixes
From: Akihiko Odaki <akihiko.odaki@daynix.com>
Date: Fri, 21 Mar 2025 15:48:35 +0900
Subject: [PATCH] virtio_net: Allocate rss_hdr with devres

virtnet_probe() lacks the code to free rss_hdr in its error path.
Allocate rss_hdr with devres so that it will be automatically freed.

[jgross: take a completely different approach by just adding the
 missing rss_indirection_table_free() in virtnet_probe().
 This avoids breaking kabi.]

Fixes: 86a48a00efdf ("virtio_net: Support dynamic rss indirection table size")
Signed-off-by: Juergen Gross <jgross@suse.com>
---
 drivers/net/virtio_net.c | 10 ++++------
 1 file changed, 4 insertions(+), 6 deletions(-)

diff --git a/drivers/net/virtio_net.c b/drivers/net/virtio_net.c
index e46241c6fdab..aac5a5184ba9 100644
--- a/drivers/net/virtio_net.c
+++ b/drivers/net/virtio_net.c
@@ -6694,6 +6694,7 @@ static int virtnet_probe(struct virtio_device *vdev)
 	free_receive_page_frags(vi);
 	virtnet_del_vqs(vi);
 free:
+	rss_indirection_table_free(&vi->rss);
 	free_netdev(dev);
 	return err;
 }
-- 
2.43.0

