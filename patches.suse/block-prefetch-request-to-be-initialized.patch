From: Jens Axboe <axboe@kernel.dk>
Date: Tue, 19 Oct 2021 09:32:59 -0600
Subject: [PATCH] block: prefetch request to be initialized
Git-commit: 92aff191cc5b15a56d10a7a1a0b4bc5f6e17fcf3
Patch-mainline: v5.16-rc1
References: jsc#PED-1183

Now we have the tags available in __blk_mq_alloc_requests_batch(), we
can start fetching the first request cacheline before calling into the
request initialization.

Signed-off-by: Jens Axboe <axboe@kernel.dk>
Link: https://lore.kernel.org/r/20211019153300.623322-4-axboe@kernel.dk
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Hannes Reinecke <hare@suse.com>
---
 block/blk-mq.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/block/blk-mq.c b/block/blk-mq.c
index e881e12a2691..7cdb10f96aa6 100644
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@ -405,6 +405,7 @@ __blk_mq_alloc_requests_batch(struct blk_mq_alloc_data *data,
 	for (i = 0; tag_mask; i++) {
 		if (!(tag_mask & (1UL << i)))
 			continue;
+		prefetch(tags->static_rqs[tag]);
 		tag = tag_offset + i;
 		tag_mask &= ~(1UL << i);
 		rq = blk_mq_rq_ctx_init(data, tags, tag, alloc_time_ns);
-- 
2.35.3

