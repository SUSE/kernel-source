From: Andreas Gruenbacher <agruenba@redhat.com>
Date: Thu, 17 Mar 2022 14:47:24 +0100
Subject: [PATCH] gfs2: Fix gfs2_file_buffered_write endless loop workaround
References: bsc#1012628
Patch-mainline: 5.17.2
Git-commit: 46f3e0421ccb5474b5c006b0089b9dfd42534bb6

commit 46f3e0421ccb5474b5c006b0089b9dfd42534bb6 upstream.

Since commit 554c577cee95b, gfs2_file_buffered_write() can accidentally
return a truncated iov_iter, which might confuse callers.  Fix that.

Fixes: 554c577cee95b ("gfs2: Prevent endless loops in gfs2_file_buffered_write")
Signed-off-by: Andreas Gruenbacher <agruenba@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Jiri Slaby <jslaby@suse.cz>
---
 fs/gfs2/file.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/fs/gfs2/file.c b/fs/gfs2/file.c
index 5bac4f6e8e05..b53ad18e5ccb 100644
--- a/fs/gfs2/file.c
+++ b/fs/gfs2/file.c
@@ -1083,6 +1083,7 @@ static ssize_t gfs2_file_buffered_write(struct kiocb *iocb,
 	gfs2_holder_uninit(gh);
 	if (statfs_gh)
 		kfree(statfs_gh);
+	from->count = orig_count - read;
 	return read ? read : ret;
 }
 
-- 
2.35.1

