From: Lee Duncan <lduncan@suse.com>
Date: Fri 21 Mar 2025 01:27:49 PM PDT
Subject: kABI: ufshcd: add ufshcd_dealloc_host back
Patch-mainline: never, kabi workaround
References: CVE-2025-21739 bsc#1238506

The patch:

> scsi-ufs-core-Fix-use-after-free-in-init-error-and-remove-paths

removed the kABI ufshcd_dealloc_host(), but add it back, for
kABI compatability, even though all known users have
stopped using it.
---
 drivers/ufs/core/ufshcd.c |   14 ++++++++++++++
 include/ufs/ufshcd.h      |    4 ++++
 2 files changed, 18 insertions(+)

--- a/drivers/ufs/core/ufshcd.c
+++ b/drivers/ufs/core/ufshcd.c
@@ -10077,6 +10077,20 @@ int ufshcd_system_thaw(struct device *de
 EXPORT_SYMBOL_GPL(ufshcd_system_thaw);
 #endif /* CONFIG_PM_SLEEP  */
 
+ /**
+ * ufshcd_dealloc_host - deallocate Host Bus Adapter (HBA)
+ * @hba: pointer to Host Bus Adapter (HBA)
+ *
+ * XXX: this was removed upstream, but added back, here,
+ * for kABI compatability, even though nobody should be
+ * calling this any longer
+ */
+void ufshcd_dealloc_host(struct ufs_hba *hba)
+{
+	scsi_host_put(hba->host);
+}
+EXPORT_SYMBOL_GPL(ufshcd_dealloc_host);
+
 /**
  * ufshcd_set_dma_mask - Set dma mask based on the controller
  *			 addressing capability
--- a/include/ufs/ufshcd.h
+++ b/include/ufs/ufshcd.h
@@ -1225,6 +1225,10 @@ static inline void ufshcd_rmwl(struct uf
 }
 
 int ufshcd_alloc_host(struct device *, struct ufs_hba **);
+
+/* XXX: added back for kABI compability */
+void ufshcd_dealloc_host(struct ufs_hba *);
+
 int ufshcd_hba_enable(struct ufs_hba *hba);
 int ufshcd_init(struct ufs_hba *, void __iomem *, unsigned int);
 int ufshcd_link_recovery(struct ufs_hba *hba);
