From: Vlastimil Babka <vbabka@suse.cz>
Subject: mm: memory-tiering: fix PGPROMOTE_CANDIDATE counting - kabi
Patch-mainline: Never, kabi workaround
References: bsc#1245630

This adds a field to enum node_stat_item so use one of the paddings we have
there. As a result the field will appear on a different line of vmstat than
upstream but that should not be an issue.

We could also assume CONFIG_NUMA_BALANCING is on since all our configs have
it, but it's not that hard (yet, until we add more such fields depending
on something else) to handle both cases.

Signed-off-by: Vlastimil Babka <vbabka@suse.cz>
Reviewed-by: Jan Kara <jack@suse.cz>
---
 include/linux/mmzone.h |   25 ++++++++++++++++++-------
 mm/vmstat.c            |    6 +++++-
 2 files changed, 23 insertions(+), 8 deletions(-)

--- a/include/linux/mmzone.h
+++ b/include/linux/mmzone.h
@@ -232,6 +232,15 @@ enum node_stat_item {
 	 * threshold.
 	 */
 	PGPROMOTE_CANDIDATE,
+#endif
+	/* PGDEMOTE_*: pages demoted */
+	PGDEMOTE_KSWAPD,
+	PGDEMOTE_DIRECT,
+	PGDEMOTE_KHUGEPAGED,
+
+#ifndef __GENKSYMS__
+
+#ifdef CONFIG_NUMA_BALANCING
 	/**
 	 * Not rate-limited (NRL) candidate pages for those can be promoted
 	 * without considering hot threshold because of enough free pages in
@@ -241,16 +250,18 @@ enum node_stat_item {
 	 * This is for statistics/monitoring purposes.
 	 */
 	PGPROMOTE_CANDIDATE_NRL,
-#endif
-	/* PGDEMOTE_*: pages demoted */
-	PGDEMOTE_KSWAPD,
-	PGDEMOTE_DIRECT,
-	PGDEMOTE_KHUGEPAGED,
+	SUSE_KABI_NODE_STAT_PADDING2,
+	NR_VM_NODE_STAT_ITEMS_USED = SUSE_KABI_NODE_STAT_PADDING2,
+#else /* CONFIG_NUMA_BALANCING */
 	SUSE_KABI_NODE_STAT_PADDING1,
-#ifndef __GENKSYMS__
 	NR_VM_NODE_STAT_ITEMS_USED = SUSE_KABI_NODE_STAT_PADDING1,
-#endif
 	SUSE_KABI_NODE_STAT_PADDING2,
+#endif /* CONFIG_NUMA_BALANCING */
+
+#else /* __GENKSYMS__ */
+	SUSE_KABI_NODE_STAT_PADDING1,
+	SUSE_KABI_NODE_STAT_PADDING2,
+#endif
 	SUSE_KABI_NODE_STAT_PADDING3,
 	SUSE_KABI_NODE_STAT_PADDING4,
 	SUSE_KABI_NODE_STAT_PADDING5,
--- a/mm/vmstat.c
+++ b/mm/vmstat.c
@@ -1276,12 +1276,16 @@ const char * const vmstat_text[] = {
 #ifdef CONFIG_NUMA_BALANCING
 	"pgpromote_success",
 	"pgpromote_candidate",
-	"pgpromote_candidate_nrl",
 #endif
 	"pgdemote_kswapd",
 	"pgdemote_direct",
 	"pgdemote_khugepaged",
+
+#ifdef CONFIG_NUMA_BALANCING
+	"pgpromote_candidate_nrl",
+#else
 	vmstat_text_unused, /*SUSE_KABI_NODE_STAT_PADDING1*/
+#endif
 	vmstat_text_unused, /*SUSE_KABI_NODE_STAT_PADDING2*/
 	vmstat_text_unused, /*SUSE_KABI_NODE_STAT_PADDING3*/
 	vmstat_text_unused, /*SUSE_KABI_NODE_STAT_PADDING4*/
