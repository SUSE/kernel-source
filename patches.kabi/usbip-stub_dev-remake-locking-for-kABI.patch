From fb1d125f2e5b2c25a16320347065f2ecf99a0795 Mon Sep 17 00:00:00 2001
From: Oliver Neukum <oneukum@suse.com>
Date: Thu, 17 Nov 2022 13:23:57 +0100
Subject: [PATCH] usbip: stub_dev: remake locking for kABI
Patch-mainline: Never (kABI fixup)
References: git-fixes

use the global lock to preserve kABI

signed-off-by: Oliver Neukum <oneukum@suse.com>
---
 drivers/usb/usbip/stub_dev.c | 9 ++++-----
 drivers/usb/usbip/vhci_hcd.c | 1 +
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/drivers/usb/usbip/stub_dev.c b/drivers/usb/usbip/stub_dev.c
index c64964c32..c60e6236a 100644
--- a/drivers/usb/usbip/stub_dev.c
+++ b/drivers/usb/usbip/stub_dev.c
@@ -63,7 +63,7 @@ static ssize_t usbip_sockfd_store(struct device *dev, struct device_attribute *a
 
 		dev_info(dev, "stub up\n");
 
-		mutex_lock(&sdev->ud.sysfs_lock);
+		mutex_lock(&suse_big_usbip_lock);
 		spin_lock_irq(&sdev->ud.lock);
 
 		if (sdev->ud.status != SDEV_ST_AVAILABLE) {
@@ -113,7 +113,7 @@ static ssize_t usbip_sockfd_store(struct device *dev, struct device_attribute *a
 		wake_up_process(sdev->ud.tcp_rx);
 		wake_up_process(sdev->ud.tcp_tx);
 
-		mutex_unlock(&sdev->ud.sysfs_lock);
+		mutex_unlock(&suse_big_usbip_lock);
 
 	} else {
 		dev_info(dev, "stub down\n");
@@ -125,7 +125,7 @@ static ssize_t usbip_sockfd_store(struct device *dev, struct device_attribute *a
 		spin_unlock_irq(&sdev->ud.lock);
 
 		usbip_event_add(&sdev->ud, SDEV_EVENT_DOWN);
-		mutex_unlock(&sdev->ud.sysfs_lock);
+		mutex_unlock(&suse_big_usbip_lock);
 	}
 
 	return count;
@@ -135,7 +135,7 @@ static ssize_t usbip_sockfd_store(struct device *dev, struct device_attribute *a
 err:
 	spin_unlock_irq(&sdev->ud.lock);
 unlock_mutex:
-	mutex_unlock(&sdev->ud.sysfs_lock);
+	mutex_unlock(&suse_big_usbip_lock);
 	return -EINVAL;
 }
 static DEVICE_ATTR_WO(usbip_sockfd);
@@ -301,7 +301,6 @@ static struct stub_device *stub_device_alloc(struct usb_device *udev)
 	sdev->ud.side		= USBIP_STUB;
 	sdev->ud.status		= SDEV_ST_AVAILABLE;
 	spin_lock_init(&sdev->ud.lock);
-	mutex_init(&sdev->ud.sysfs_lock);
 	sdev->ud.tcp_socket	= NULL;
 	sdev->ud.sockfd		= -1;
 
diff --git a/drivers/usb/usbip/vhci_hcd.c b/drivers/usb/usbip/vhci_hcd.c
index 32d653d36..f12ca9e72 100644
--- a/drivers/usb/usbip/vhci_hcd.c
+++ b/drivers/usb/usbip/vhci_hcd.c
@@ -117,6 +117,7 @@ static const char * const bit_desc_ss[] = {
 };
 
 DEFINE_MUTEX(suse_big_usbip_lock);
+EXPORT_SYMBOL(suse_big_usbip_lock);
 
 static void dump_port_status_diff(u32 prev_status, u32 new_status, bool usb3)
 {
-- 
2.35.3

