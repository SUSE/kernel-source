From: Steffen Jaeckel <sjaeckel@suse.de>
Date: Wed, 5 Feb 2025 13:18:53 +0100
Subject: kABI fix for net: defer final 'struct net' free in netns dismantle
Patch-mainline: never, kABI workaround
References: CVE-2024-56658 bsc#1235441

Upstream commit 0f6ede9fbc74 ("net: defer final 'struct
net' free in netns dismantle") introduced a new struct element
`defer_free_list` into `struct net`. In order to preserve the kABI, move
the newly added element into a hole.

```
        struct bpf_prog *          flow_dissector_prog;  /*  3584     8 */

        /* XXX 56 bytes hole, try to pack */

        /* --- cacheline 57 boundary (3648 bytes) --- */
        struct netns_xfrm          xfrm __attribute__((__aligned__(64))); /*  3648   832 */
```

Signed-off-by: Steffen Jaeckel <sjaeckel@suse.de>
---
 include/net/net_namespace.h |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

--- a/include/net/net_namespace.h
+++ b/include/net/net_namespace.h
@@ -80,7 +80,6 @@ struct net {
 						 * or to unregister pernet ops
 						 * (pernet_ops_rwsem write locked).
 						 */
-	struct llist_node	defer_free_list;
 	struct llist_node	cleanup_list;	/* namespaces on death row */
 
 #ifdef CONFIG_KEYS
@@ -167,6 +166,10 @@ struct net {
 	/* Used to store attached BPF programs */
 	struct netns_bpf	bpf;
 
+#ifndef __GENKSYMS__
+	struct llist_node defer_free_list;
+#endif
+
 	/* Note : following structs are cache line aligned */
 #ifdef CONFIG_XFRM
 	struct netns_xfrm	xfrm;
