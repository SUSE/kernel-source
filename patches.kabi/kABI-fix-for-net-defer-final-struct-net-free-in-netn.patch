From: Steffen Jaeckel <sjaeckel@suse.de>
Date: Wed, 5 Feb 2025 13:18:53 +0100
Subject: kABI fix for net: defer final 'struct net' free in netns dismantle
Patch-mainline: never, kABI workaround
References: CVE-2024-56658 bsc#1235441

Upstream commit 0f6ede9fbc74 ("net: defer final 'struct
net' free in netns dismantle") introduced a new struct element
`defer_free_list` into `struct net`. In order to preserve the kABI, move
the newly added element into a hole.

```
        struct netns_nexthop       nexthop;              /*   560    72 */

        /* XXX 8 bytes hole, try to pack */

        /* --- cacheline 10 boundary (640 bytes) --- */
        struct netns_ipv4          ipv4 __attribute__((__aligned__(64))); /*   640   704 */
```

Signed-off-by: Steffen Jaeckel <sjaeckel@suse.de>

---
 include/net/net_namespace.h |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/include/net/net_namespace.h
+++ b/include/net/net_namespace.h
@@ -77,7 +77,6 @@ struct net {
 						 * or to unregister pernet ops
 						 * (pernet_ops_rwsem write locked).
 						 */
-	struct llist_node	defer_free_list;
 	struct llist_node	cleanup_list;	/* namespaces on death row */
 
 #ifdef CONFIG_KEYS
@@ -121,6 +120,9 @@ struct net {
 	struct netns_packet	packet;
 	struct netns_unix	unx;
 	struct netns_nexthop	nexthop;
+#ifndef __GENKSYMS__
+	struct llist_node	defer_free_list;
+#endif
 	struct netns_ipv4	ipv4;
 #if IS_ENABLED(CONFIG_IPV6)
 	struct netns_ipv6	ipv6;
