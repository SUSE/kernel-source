Patch-mainline: never, kABI fix
References: bsc#1226158
From: Juergen Gross <jgross@suse.com>
Subject: [PATCH] kABI fix of KVM: x86/pmu: Prioritize VMX interception
 over #GP on RDPMC due to bad index

For kABI check keep x86_emulate_ops.check_pmc and
KVM_X86_PMU_OP(is_valid_rdpmc_ecx).

Signed-off-by: Juergen Gross <jgross@suse.com>
---
diff --git a/arch/x86/include/asm/kvm-x86-pmu-ops.h b/arch/x86/include/asm/kvm-x86-pmu-ops.h
index 058bc636356a..d7eebee4450c 100644
--- a/arch/x86/include/asm/kvm-x86-pmu-ops.h
+++ b/arch/x86/include/asm/kvm-x86-pmu-ops.h
@@ -15,7 +15,11 @@ BUILD_BUG_ON(1)
 KVM_X86_PMU_OP(pmc_idx_to_pmc)
 KVM_X86_PMU_OP(rdpmc_ecx_to_pmc)
 KVM_X86_PMU_OP(msr_idx_to_pmc)
+#ifdef __GENKSYMS__
+KVM_X86_PMU_OP(is_valid_rdpmc_ecx)
+#else
 KVM_X86_PMU_OP_OPTIONAL(check_rdpmc_early)
+#endif
 KVM_X86_PMU_OP(is_valid_msr)
 KVM_X86_PMU_OP(get_msr)
 KVM_X86_PMU_OP(set_msr)
diff --git a/arch/x86/kvm/kvm_emulate.h b/arch/x86/kvm/kvm_emulate.h
index 7caeb3d8d4fd..87ecf22f5b25 100644
--- a/arch/x86/kvm/kvm_emulate.h
+++ b/arch/x86/kvm/kvm_emulate.h
@@ -208,7 +208,11 @@ struct x86_emulate_ops {
 	int (*set_msr_with_filter)(struct x86_emulate_ctxt *ctxt, u32 msr_index, u64 data);
 	int (*get_msr_with_filter)(struct x86_emulate_ctxt *ctxt, u32 msr_index, u64 *pdata);
 	int (*get_msr)(struct x86_emulate_ctxt *ctxt, u32 msr_index, u64 *pdata);
+#ifdef __GENKSYMS__
+	int (*check_pmc)(struct x86_emulate_ctxt *ctxt, u32 pmc);
+#else
 	int (*check_rdpmc_early)(struct x86_emulate_ctxt *ctxt, u32 pmc);
+#endif
 	int (*read_pmc)(struct x86_emulate_ctxt *ctxt, u32 pmc, u64 *pdata);
 	void (*halt)(struct x86_emulate_ctxt *ctxt);
 	void (*wbinvd)(struct x86_emulate_ctxt *ctxt);
