From: Lee Duncan <lduncan@suse.com>
Date: Tue 12 Apr 2022 12:50:17 PM PDT
Subject: SCSI: iscsi: fix iscsi_cls_conn changes
Patch-mainline: Never, kABI workaround
References: bsc#1197685

Patch:

> scsi-iscsi-Fix-conn-cleanup-and-stop-race-during-iscsid-restart.patch

Added a "lock" field to iscsi_cls_conn. All callers of this in scsi/drivers
have been updated.

Signed-off-by: Lee Duncan <lduncan@suse.com>
---
 include/scsi/scsi_transport_iscsi.h |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

--- a/include/scsi/scsi_transport_iscsi.h
+++ b/include/scsi/scsi_transport_iscsi.h
@@ -213,13 +213,15 @@ struct iscsi_cls_conn {
 	struct mutex ep_mutex;
 	struct iscsi_endpoint *ep;
 
-	/* Used when accessing flags and queueing work. */
-	spinlock_t lock;
 	unsigned long flags;
 	struct work_struct cleanup_work;
 
 	struct device dev;		/* sysfs transport/container device */
 	enum iscsi_connection_state state;
+#ifndef __GENKSYMS__
+	/* Used when accessing flags and queueing work. */
+	spinlock_t lock;
+#endif
 };
 
 #define iscsi_dev_to_conn(_dev) \
