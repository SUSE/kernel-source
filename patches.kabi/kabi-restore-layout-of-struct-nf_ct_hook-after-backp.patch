From: Michal Kubecek <mkubecek@suse.cz>
Date: Thu, 10 Apr 2025 00:32:40 +0200
Subject: kabi: restore layout of struct nf_ct_hook after backport of commit 62e7151ae3eb
Patch-mainline: Never, kabi workaround
References: CVE-2024-27415 bsc#1224757

Backport of mainline commit 62e7151ae3eb ("netfilter: bridge: confirm
multicast packets before passing them up the stack") adds ->confirm()
callback to kabi protected struct nf_ct_hook. Thankfully the only function
actually used for that callback is __nf_conntrack_confirm() so that we can
drop this callback from the hook structure and call this function directly
(it is exported anyway).

Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
---
 include/linux/netfilter.h         | 1 -
 net/bridge/br_netfilter_hooks.c   | 2 +-
 net/netfilter/nf_conntrack_core.c | 1 -
 3 files changed, 1 insertion(+), 3 deletions(-)

--- a/include/linux/netfilter.h
+++ b/include/linux/netfilter.h
@@ -464,7 +464,6 @@ struct nf_ct_hook {
 			      const struct sk_buff *);
 	void (*attach)(struct sk_buff *nskb, const struct sk_buff *skb);
 	void (*set_closing)(struct nf_conntrack *nfct);
-	int (*confirm)(struct sk_buff *skb);
 };
 extern const struct nf_ct_hook __rcu *nf_ct_hook;
 
--- a/net/bridge/br_netfilter_hooks.c
+++ b/net/bridge/br_netfilter_hooks.c
@@ -628,7 +628,7 @@ static unsigned int br_nf_local_in(void *priv,
 	}
 
 	nf_bridge_pull_encap_header(skb);
-	ret = ct_hook->confirm(skb);
+	ret = __nf_conntrack_confirm(skb);
 	switch (ret & NF_VERDICT_MASK) {
 	case NF_STOLEN:
 		return NF_STOLEN;
--- a/net/netfilter/nf_conntrack_core.c
+++ b/net/netfilter/nf_conntrack_core.c
@@ -2766,7 +2766,6 @@ static const struct nf_ct_hook nf_conntrack_hook = {
 	.get_tuple_skb  = nf_conntrack_get_tuple_skb,
 	.attach		= nf_conntrack_attach,
 	.set_closing	= nf_conntrack_set_closing,
-	.confirm	= __nf_conntrack_confirm,
 };
 
 void nf_conntrack_init_end(void)
