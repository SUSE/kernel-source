From: Joerg Roedel <jroedel@suse.de>
Date: Tue, 21 Feb 2023 15:16:24 +0100
Subject: [PATCH] kABI: Work around kABI changes after '20347fca71a3 swiotlb:
 split up the global swiotlb lock'
Patch-mainline: Never, kABI workaround
References: jsc#PED-3259, bsc#1224331

Signed-off-by: Joerg Roedel <jroedel@suse.de>
[iivanov: fixups after af133562d5aff]
Signed-off-by: Ivan T. Ivanov <iivanov@suse.de>
---
 include/linux/swiotlb.h |   20 +++++++++++++++++---
 1 file changed, 17 insertions(+), 3 deletions(-)

--- a/include/linux/swiotlb.h
+++ b/include/linux/swiotlb.h
@@ -95,19 +95,33 @@ struct io_tlb_mem {
 	void *vaddr;
 	unsigned long nslabs;
 	unsigned long used;
+	unsigned int index;
+	spinlock_t lock;
 	struct dentry *debugfs;
 	bool late_alloc;
 	bool force_bounce;
 	bool for_alloc;
-	unsigned int nareas;
-	unsigned int area_nslabs;
-	struct io_tlb_area *areas;
 	struct io_tlb_slot {
 		phys_addr_t orig_addr;
 		size_t alloc_size;
+#ifdef __GENKSYMS__
+		unsigned int list;
+#else
+		/*
+		 * There is no public API to modify struct io_tlb_mem or
+		 * struct io_tlb_mem::io_tlb_slot. They are allocated and
+		 * dereferenced only inside swiotlb.c. The only instance of
+		 * struct io_tlb_mem is io_tlb_default_mem.
+		 */
 		unsigned short list;
 		unsigned short pad_slots;
+#endif
 	} *slots;
+#ifndef __GENKSYMS__
+	unsigned int nareas;
+	unsigned int area_nslabs;
+	struct io_tlb_area *areas;
+#endif
 };
 extern struct io_tlb_mem io_tlb_default_mem;
 
