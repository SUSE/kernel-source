From: Takashi Iwai <tiwai@suse.de>
Subject: kABI workaround for pps changes
Patch-mainline: Never, kABI workaround
References: CVE-2024-57979 bsc#1238521

The recent CVE fix for pps changed the device management for pps_device.
Make it kABI compatible by moving the new embedded struct device at the
end and pointing the old device pointer to the embedded device.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/pps/pps.c          |    1 +
 include/linux/pps_kernel.h |   10 +++++++++-
 2 files changed, 10 insertions(+), 1 deletion(-)

--- a/drivers/pps/pps.c
+++ b/drivers/pps/pps.c
@@ -372,6 +372,7 @@ int pps_register_cdev(struct pps_device
 	}
 	pps->id = err;
 
+	pps->_dev = &pps->dev; // XXX for kABI compatibility
 	pps->dev.class = pps_class;
 	pps->dev.parent = pps->info.dev;
 	pps->dev.devt = MKDEV(pps_major, pps->id);
--- a/include/linux/pps_kernel.h
+++ b/include/linux/pps_kernel.h
@@ -56,9 +56,17 @@ struct pps_device {
 
 	unsigned int id;			/* PPS source unique ID */
 	void const *lookup_cookie;		/* For pps_lookup_dev() only */
-	struct device dev;
+	struct cdev cdev;
+#ifdef __GENKSYMS__
+	struct device *dev;
+#else
+	struct device *_dev;
+#endif
 	struct fasync_struct *async_queue;	/* fasync method */
 	spinlock_t lock;
+#ifndef __GENKSYMS__
+	struct device dev;
+#endif
 };
 
 /*
