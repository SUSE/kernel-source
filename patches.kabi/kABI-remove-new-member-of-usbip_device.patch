From 549ba47e758e45b63a2dabaf522ee79e1f6ee770 Mon Sep 17 00:00:00 2001
From: Oliver Neukum <oneukum@suse.com>
Date: Thu, 17 Nov 2022 10:35:48 +0100
Subject: [PATCH] kABI: remove new member of usbip_device
Patch-mainline: Never (kABI fixup)
References: git-fixes

The structure is embedded into other structures, hence
it cannot be enlarged.
This replaces the per HC lock with a global lock.

Signed-off-by: Oliver Neukum <oneukum@suse.com>
---
 drivers/usb/usbip/usbip_common.h |  5 ++---
 drivers/usb/usbip/vhci_hcd.c     |  3 ++-
 drivers/usb/usbip/vhci_sysfs.c   | 12 ++++++------
 scripts/bpf_helpers_doc.py       |  0
 4 files changed, 10 insertions(+), 10 deletions(-)
 mode change 100644 => 100755 scripts/bpf_helpers_doc.py

diff --git a/drivers/usb/usbip/usbip_common.h b/drivers/usb/usbip/usbip_common.h
index a7e6ce96f..1180c931e 100644
--- a/drivers/usb/usbip/usbip_common.h
+++ b/drivers/usb/usbip/usbip_common.h
@@ -263,9 +263,6 @@ struct usbip_device {
 	/* lock for status */
 	spinlock_t lock;
 
-	/* mutex for synchronizing sysfs store paths */
-	struct mutex sysfs_lock;
-
 	int sockfd;
 	struct socket *tcp_socket;
 
@@ -340,4 +337,6 @@ static inline int interface_to_devnum(struct usb_interface *interface)
 	return udev->devnum;
 }
 
+extern struct mutex suse_big_usbip_lock;
+
 #endif /* __USBIP_COMMON_H */
diff --git a/drivers/usb/usbip/vhci_hcd.c b/drivers/usb/usbip/vhci_hcd.c
index 170abb06a..32d653d36 100644
--- a/drivers/usb/usbip/vhci_hcd.c
+++ b/drivers/usb/usbip/vhci_hcd.c
@@ -116,6 +116,8 @@ static const char * const bit_desc_ss[] = {
 	"R31",			/*31*/
 };
 
+DEFINE_MUTEX(suse_big_usbip_lock);
+
 static void dump_port_status_diff(u32 prev_status, u32 new_status, bool usb3)
 {
 	int i = 0;
@@ -1126,7 +1128,6 @@ static void vhci_device_init(struct vhci_device *vdev)
 	vdev->ud.side   = USBIP_VHCI;
 	vdev->ud.status = VDEV_ST_NULL;
 	spin_lock_init(&vdev->ud.lock);
-	mutex_init(&vdev->ud.sysfs_lock);
 
 	INIT_LIST_HEAD(&vdev->priv_rx);
 	INIT_LIST_HEAD(&vdev->priv_tx);
diff --git a/drivers/usb/usbip/vhci_sysfs.c b/drivers/usb/usbip/vhci_sysfs.c
index ebc7be1d9..de5ab6f9c 100644
--- a/drivers/usb/usbip/vhci_sysfs.c
+++ b/drivers/usb/usbip/vhci_sysfs.c
@@ -185,7 +185,7 @@ static int vhci_port_disconnect(struct vhci_hcd *vhci_hcd, __u32 rhport)
 
 	usbip_dbg_vhci_sysfs("enter\n");
 
-	mutex_lock(&vdev->ud.sysfs_lock);
+	mutex_lock(&suse_big_usbip_lock);
 
 	/* lock */
 	spin_lock_irqsave(&vhci->lock, flags);
@@ -197,7 +197,7 @@ static int vhci_port_disconnect(struct vhci_hcd *vhci_hcd, __u32 rhport)
 		/* unlock */
 		spin_unlock(&vdev->ud.lock);
 		spin_unlock_irqrestore(&vhci->lock, flags);
-		mutex_unlock(&vdev->ud.sysfs_lock);
+		mutex_unlock(&suse_big_usbip_lock);
 
 		return -EINVAL;
 	}
@@ -208,7 +208,7 @@ static int vhci_port_disconnect(struct vhci_hcd *vhci_hcd, __u32 rhport)
 
 	usbip_event_add(&vdev->ud, VDEV_EVENT_DOWN);
 
-	mutex_unlock(&vdev->ud.sysfs_lock);
+	mutex_unlock(&suse_big_usbip_lock);
 
 	return 0;
 }
@@ -354,7 +354,7 @@ static ssize_t attach_store(struct device *dev, struct device_attribute *attr,
 	else
 		vdev = &vhci->vhci_hcd_hs->vdev[rhport];
 
-	mutex_lock(&vdev->ud.sysfs_lock);
+	mutex_lock(&suse_big_usbip_lock);
 
 	/* Extract socket from fd. */
 	socket = sockfd_lookup(sockfd, &err);
@@ -436,12 +436,12 @@ static ssize_t attach_store(struct device *dev, struct device_attribute *attr,
 
 	dev_info(dev, "Device attached\n");
 
-	mutex_unlock(&vdev->ud.sysfs_lock);
+	mutex_unlock(&suse_big_usbip_lock);
 
 	return count;
 
 unlock_mutex:
-	mutex_unlock(&vdev->ud.sysfs_lock);
+	mutex_unlock(&suse_big_usbip_lock);
 	return err;
 }
 static DEVICE_ATTR_WO(attach);
diff --git a/scripts/bpf_helpers_doc.py b/scripts/bpf_helpers_doc.py
old mode 100644
new mode 100755
-- 
2.35.3

