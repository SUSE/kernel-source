From 9e5fdec6fb3e4a709d39ca3e6fa0c72cf2531fbd Mon Sep 17 00:00:00 2001
From: Denis Kirjanov <denis.kirjanov@suse.com>
Date: Sat, 4 May 2024 13:51:41 +0300
Subject: [PATCH] netfilter: preserve nf_tables kabi
Patch-mainline: Never, kabi workaround
References: bsc#1215420 CVE-2023-424
---
 include/net/netfilter/nf_tables.h |   12 +++++++++++-
 include/net/netns/nftables.h      |    4 +++-
 2 files changed, 14 insertions(+), 2 deletions(-)

--- a/include/net/netfilter/nf_tables.h
+++ b/include/net/netfilter/nf_tables.h
@@ -437,7 +437,6 @@ struct nft_set_type {
 struct nft_set {
 	struct list_head		list;
 	struct list_head		bindings;
-	refcount_t                      refs;
 	struct nft_table		*table;
 	possible_net_t			net;
 	char				*name;
@@ -455,12 +454,19 @@ struct nft_set {
 	u32				gc_int;
 	u16				policy;
 	u16				udlen;
+#ifndef __GENKSYMS__
+	refcount_t                      refs;
+#endif
 	unsigned char			*udata;
 	struct nft_expr			*expr;
 	/* runtime data below here */
 	const struct nft_set_ops	*ops ____cacheline_aligned;
+#ifndef __GENKSYMS__
 	u16                             flags:13,
 					dead:1,
+#else
+	u16				flags:14,
+#endif
 					genmask:2;
 	u8				klen;
 	u8				dlen;
@@ -1550,7 +1556,11 @@ struct nft_trans_gc {
 	struct net              *net;
 	struct nft_set          *set;
 	u32                     seq;
+#ifndef __GENKSYMS__
 	u16                     count;
+#else
+	u8	                count;
+#endif
 	void                    *priv[NFT_TRANS_GC_BATCHCOUNT];
 	struct rcu_head         rcu;
 };
--- a/include/net/netns/nftables.h
+++ b/include/net/netns/nftables.h
@@ -10,9 +10,11 @@ struct netns_nftables {
 	struct list_head	module_list;
 	struct mutex		commit_mutex;
 	unsigned int		base_seq;
-	unsigned int            gc_seq;
 	u8			gencursor;
 	u8			validate_state;
+#ifndef __GENKSYMS__
+	unsigned int            gc_seq;
+#endif
 };
 
 #endif
