From: Michal Kubecek <mkubecek@suse.cz>
Date: Wed, 9 Jul 2025 21:50:46 +0200
Subject: kabi: restore encap_sk in struct xfrm_state
Patch-mainline: Never, kabi workaround
References: CVE-2025-38097 bsc#1245660

Backport of mainline commit 028363685bd0 ("espintcp: remove encap socket
caching to avoid reference leak") removes encap_sk member of kabi protected
struct xfrm_state. Add the member back but preserve the name only for
genksyms so that it is not accidentally used by some later backport.

Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
---
 include/net/xfrm.h | 5 +++++
 1 file changed, 5 insertions(+)

--- a/include/net/xfrm.h
+++ b/include/net/xfrm.h
@@ -232,6 +232,11 @@ struct xfrm_state {
 
 	/* Data for encapsulator */
 	struct xfrm_encap_tmpl	*encap;
+#ifdef __GENKSYMS__
+	struct sock __rcu	*encap_sk;
+#else
+	struct sock __rcu	*__unused_encap_sk;
+#endif
 
 	/* Data for care-of address */
 	xfrm_address_t	*coaddr;
