Patch-mainline: never, kABI fix
References: git-fixes
From: Juergen Gross <jgross@suse.com>
Date: Wed, 21 Sep 2025 14:17:05 +0200
Subject: [PATCH] kABI fix after vsock/virtio: fix `rx_bytes` accounting
 for stream sockets
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fix kABI breakage due to inserted field "buf_used" in struct
virtio_vsock_sock.

Move the new field to the end of the struct and hide it from genksyms.
This is fine as the struct is allocated only in
virtio_transport_common.c and it is never part of another struct.

Signed-off-by: Juergen Gross <jgross@suse.com>
Reviewed-by: Michal Koutn√Ω <mkoutny@suse.com>
---
diff --git a/include/linux/virtio_vsock.h b/include/linux/virtio_vsock.h
index 0387d64e2c66..36fb3edfa403 100644
--- a/include/linux/virtio_vsock.h
+++ b/include/linux/virtio_vsock.h
@@ -140,9 +140,11 @@ struct virtio_vsock_sock {
 	u32 last_fwd_cnt;
 	u32 rx_bytes;
 	u32 buf_alloc;
-	u32 buf_used;
 	struct sk_buff_head rx_queue;
 	u32 msg_count;
+#ifndef __GENKSYMS__
+	u32 buf_used;
+#endif
 };
 
 struct virtio_vsock_pkt_info {
-- 
2.43.0

