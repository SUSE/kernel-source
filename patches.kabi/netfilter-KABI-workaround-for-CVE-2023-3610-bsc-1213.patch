From 2cebb95a1e20eb2498e3d6d69b2c3b13be749945 Mon Sep 17 00:00:00 2001
From: Denis Kirjanov <denis.kirjanov@suse.com>
Date: Sat, 12 Aug 2023 13:31:45 +0300
Subject: [PATCH 2/2] netfilter: KABI workaround for CVE-2023-3610 bsc#1213580
Patch-mainline: never, kabi
References: git-fixes

Signed-off-by: Denis Kirjanov <denis.kirjanov@suse.com>
---
 include/net/netfilter/nf_tables.h | 9 +++++++--
 net/netfilter/nf_tables_api.c     | 7 ++++++-
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/include/net/netfilter/nf_tables.h b/include/net/netfilter/nf_tables.h
index fddb4f759227..195934004338 100644
--- a/include/net/netfilter/nf_tables.h
+++ b/include/net/netfilter/nf_tables.h
@@ -937,6 +937,7 @@ static inline struct nft_userdata *nft_userdata(const struct nft_rule *rule)
 	return (void *)&rule->data[rule->dlen];
 }
 
+void nf_tables_rule_release(const struct nft_ctx *ctx, struct nft_rule *rule);
 void nft_rule_expr_activate(const struct nft_ctx *ctx, struct nft_rule *rule);
 void nft_rule_expr_deactivate(const struct nft_ctx *ctx, struct nft_rule *rule,
 			      enum nft_trans_phase phase);
@@ -1484,7 +1485,9 @@ struct nft_trans_rule {
 	struct nft_rule			*rule;
 	struct nft_flow_rule		*flow;
 	u32				rule_id;
+#ifndef __GENKSYMS__
 	bool				bound;
+#endif
 };
 
 #define nft_trans_rule(trans)	\
@@ -1510,13 +1513,15 @@ struct nft_trans_set {
 	(((struct nft_trans_set *)trans->data)->bound)
 
 struct nft_trans_chain {
-	struct nft_chain		*chain;
 	bool				update;
 	char				*name;
 	struct nft_stats __percpu	*stats;
 	u8				policy;
-	bool				bound;
 	u32				chain_id;
+#ifndef __GENKSYMS__
+	struct nft_chain                *chain;
+	bool                            bound;
+#endif
 };
 
 #define nft_trans_chain(trans)	\
diff --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c
index ced708d675d6..bd5f08c6f58c 100644
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@ -3246,12 +3246,17 @@ void nf_tables_rule_destroy(const struct nft_ctx *ctx, struct nft_rule *rule)
 	kfree(rule);
 }
 
-static void nf_tables_rule_release(const struct nft_ctx *ctx, struct nft_rule *rule)
+static void __nf_tables_rule_release(const struct nft_ctx *ctx, struct nft_rule *rule)
 {
 	nft_rule_expr_deactivate(ctx, rule, NFT_TRANS_RELEASE);
 	nf_tables_rule_destroy(ctx, rule);
 }
 
+void nf_tables_rule_release(const struct nft_ctx *ctx, struct nft_rule *rule)
+{
+	return __nf_tables_rule_release(ctx, rule);
+}
+
 int nft_chain_validate(const struct nft_ctx *ctx, const struct nft_chain *chain)
 {
 	struct nft_expr *expr, *last;
-- 
2.16.4

