From: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Subject: kABI: bpf: struct xsk_buff_pool kABI workaround
Patch-mainline: never, kabi
References: bsc#1221303 CVE-2024-26611

Commit c5114710c8ce "xsk: fix usage of multi-buffer BPF helpers for ZC XDP"
introduced net/xdp_sock_drv.h to net/core/filter.c, which cause forward
declaration of struct xsk_buff_pool to become a full declaration, and causes
modversion of several symbols to change.

Simply workaround the kABI breakge by simply wrapping the newly introduced
code with __GENKSYMS__.

Link: https://suse.slack.com/archives/C02DQLWPALQ/p1713853179595109
Signed-off-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
---
 net/core/filter.c |   10 ++++++++++
 1 file changed, 10 insertions(+)

--- a/net/core/filter.c
+++ b/net/core/filter.c
@@ -81,7 +81,9 @@
 #include <net/xdp.h>
 #include <net/mptcp.h>
 #include <net/netfilter/nf_conntrack_bpf.h>
+#ifndef __GENKSYMS__
 #include <net/xdp_sock_drv.h>
+#endif
 
 #include "dev.h"
 
@@ -4068,6 +4070,7 @@ static int bpf_xdp_frags_increase_tail(s
 	return 0;
 }
 
+#ifndef __GENKSYMS__
 static void bpf_xdp_shrink_data_zc(struct xdp_buff *xdp, int shrink,
 				   struct xdp_mem_info *mem_info, bool release)
 {
@@ -4101,6 +4104,13 @@ static bool bpf_xdp_shrink_data(struct x
 out:
 	return release;
 }
+#else
+static bool bpf_xdp_shrink_data(struct xdp_buff *xdp, skb_frag_t *frag,
+				int shrink)
+{
+	return false;
+}
+#endif
 
 static int bpf_xdp_frags_shrink_tail(struct xdp_buff *xdp, int offset)
 {
