From: Michal Koutný <mkoutny@suse.com>
Subject: [PATCH] kabi: blkcg_policy_data fix KABI
Patch-mainline: Never (kABI fixup)
References: bsc#1216062

The 4B padding can be used to accomodate the added boolean.
Break build if this invariant did not apply.

In theory, 3rd party modules may implement custom blkcg policies including
allocation of blkg_policy_data. (If they also rely on the padding, it's a
problem.)

Signed-off-by: Michal Koutný <mkoutny@suse.com>
---
 block/blk-cgroup.c         |    3 +++
 include/linux/blk-cgroup.h |    2 ++
 2 files changed, 5 insertions(+)

--- a/block/blk-cgroup.c
+++ b/block/blk-cgroup.c
@@ -1484,6 +1484,12 @@ int blkcg_policy_register(struct blkcg_p
 	struct blkcg *blkcg;
 	int i, ret;
 
+	/* KABI preservation of struct blkg_policy_data, 32b is broken */
+#ifndef CONFIG_ARM
+	BUILD_BUG_ON(sizeof(struct blkg_policy_data) != 2*sizeof(void *));
+	BUILD_BUG_ON(sizeof(struct blkg_policy_data) <= sizeof(void*)+sizeof(int));
+#endif
+
 	mutex_lock(&blkcg_pol_register_mutex);
 	mutex_lock(&blkcg_pol_mutex);
 
--- a/include/linux/blk-cgroup.h
+++ b/include/linux/blk-cgroup.h
@@ -91,7 +91,9 @@ struct blkg_policy_data {
 	/* the blkg and policy id this per-policy data belongs to */
 	struct blkcg_gq			*blkg;
 	int				plid;
+#ifndef __GENKSYMS__
 	bool				online;
+#endif
 };
 
 /*
