From ca8c144198723d743540f518f4ecfd6767d15e92 Mon Sep 17 00:00:00 2001
From: Vasant Karasulli <vkarasulli@suse.de>
Date: Tue, 27 Aug 2024 18:27:03 +0200
Subject: [PATCH] kABI: vfio: struct virqfd kABI workaround
Patch-mainline: never, kABI workaround
References: CVE-2024-26812 bsc#1222808

Upstream commit b620ecbd17a0("vfio: Introduce interface to flush virqfd inject
workqueue") adds new member flush_inject to struct virqfd.

So add a kABI workaround by moving flush_inject member to the end, and
hide it during ksyms generation.

Signed-off-by: Vasant Karasulli <vkarasulli@suse.de>

---
 include/linux/vfio.h | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/include/linux/vfio.h b/include/linux/vfio.h
index 5ac5f182c..48901ff5c 100644
--- a/include/linux/vfio.h
+++ b/include/linux/vfio.h
@@ -349,8 +349,10 @@ struct virqfd {
 	wait_queue_entry_t		wait;
 	poll_table		pt;
 	struct work_struct	shutdown;
-	struct work_struct	flush_inject;
 	struct virqfd		**pvirqfd;
+#ifndef __GENKSYMS__
+	struct work_struct	flush_inject;
+#endif
 };
 
 int vfio_virqfd_enable(void *opaque, int (*handler)(void *, void *),
-- 
2.34.1

