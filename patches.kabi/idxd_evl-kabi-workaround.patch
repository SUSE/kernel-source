From: Takashi Iwai <tiwai@suse.de>
Subject: kABI workaround for struct idxd_evl
Patch-mainline: Never, kABI workaround
References: CVE-2024-35991 bsc#1224553

struct idxd_evl lock is changed from spinlock to mutex in the patch
  patches.suse/dmaengine-idxd-Convert-spinlock-to-mutex-to-lock-evl.patch

Move the new mutex into the tail with ifdef for a kABI workaround.
 
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/dma/idxd/idxd.h |    9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

--- a/drivers/dma/idxd/idxd.h
+++ b/drivers/dma/idxd/idxd.h
@@ -296,7 +296,11 @@ struct idxd_driver_data {
 
 struct idxd_evl {
 	/* Lock to protect event log access. */
-	struct mutex lock;
+#ifdef __GENKSYMS__
+	spinlock_t lock;
+#else
+	spinlock_t lock_unused;
+#endif
 	void *log;
 	dma_addr_t dma;
 	/* Total size of event log = number of entries * entry size. */
@@ -306,6 +310,9 @@ struct idxd_evl {
 	u16 head;
 	unsigned long *bmap;
 	bool batch_fail[IDXD_MAX_BATCH_IDENT];
+#ifndef __GENKSYMS__
+	struct mutex lock;
+#endif
 };
 
 struct idxd_evl_fault {
