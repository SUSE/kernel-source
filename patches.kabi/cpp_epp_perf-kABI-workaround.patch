From: Takashi Iwai <tiwai@suse.de>
Subject: kABI workaround for cpp_acpi extensions for EPP
Patch-mainline: Never, kABI workaround
References: bsc#1212445

The extension of cppc_perf_caps and cppc_perf_ctrls for supporting EPP
caused kABI breakage.  As those new fields are accessed only by the new
functions, put them into the newly renamed structs (with _epp prefix),
and replace with those types to keep the old structs intact.

Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/acpi/cppc_acpi.c |    4 ++--
 include/acpi/cppc_acpi.h |   26 +++++++++++++++++++++-----
 2 files changed, 23 insertions(+), 7 deletions(-)

--- a/drivers/acpi/cppc_acpi.c
+++ b/drivers/acpi/cppc_acpi.c
@@ -1392,7 +1392,7 @@ EXPORT_SYMBOL_GPL(cppc_get_perf_ctrs);
  * Set Energy Performance Preference Register value through
  * Performance Controls Interface
  */
-int cppc_set_epp_perf(int cpu, struct cppc_perf_ctrls *perf_ctrls, bool enable)
+int cppc_set_epp_perf(int cpu, struct cppc_epp_perf_ctrls *perf_ctrls, bool enable)
 {
 	int pcc_ss_id = per_cpu(cpu_pcc_subspace_idx, cpu);
 	struct cpc_register_resource *epp_set_reg;
@@ -1447,7 +1447,7 @@ EXPORT_SYMBOL_GPL(cppc_set_epp_perf);
  * @cpunum : CPU from which to read register.
  * @perf_caps : struct where autonomous selection register value is updated.
  */
-int cppc_get_auto_sel_caps(int cpunum, struct cppc_perf_caps *perf_caps)
+int cppc_get_auto_sel_caps(int cpunum, struct cppc_epp_perf_caps *perf_caps)
 {
 	struct cpc_desc *cpc_desc = per_cpu(cpc_desc_ptr, cpunum);
 	struct cpc_register_resource *auto_sel_reg;
--- a/include/acpi/cppc_acpi.h
+++ b/include/acpi/cppc_acpi.h
@@ -108,11 +108,27 @@ struct cppc_perf_caps {
 	u32 lowest_nonlinear_perf;
 	u32 lowest_freq;
 	u32 nominal_freq;
+};
+
+struct cppc_perf_ctrls {
+	u32 max_perf;
+	u32 min_perf;
+	u32 desired_perf;
+};
+
+struct cppc_epp_perf_caps {
+	u32 guaranteed_perf;
+	u32 highest_perf;
+	u32 nominal_perf;
+	u32 lowest_perf;
+	u32 lowest_nonlinear_perf;
+	u32 lowest_freq;
+	u32 nominal_freq;
 	u32 energy_perf;
 	bool auto_sel;
 };
 
-struct cppc_perf_ctrls {
+struct cppc_epp_perf_ctrls {
 	u32 max_perf;
 	u32 min_perf;
 	u32 desired_perf;
@@ -153,8 +169,8 @@ extern bool cpc_supported_by_cpu(void);
 extern int cpc_read_ffh(int cpunum, struct cpc_reg *reg, u64 *val);
 extern int cpc_write_ffh(int cpunum, struct cpc_reg *reg, u64 val);
 extern int cppc_get_epp_perf(int cpunum, u64 *epp_perf);
-extern int cppc_set_epp_perf(int cpu, struct cppc_perf_ctrls *perf_ctrls, bool enable);
-extern int cppc_get_auto_sel_caps(int cpunum, struct cppc_perf_caps *perf_caps);
+extern int cppc_set_epp_perf(int cpu, struct cppc_epp_perf_ctrls *perf_ctrls, bool enable);
+extern int cppc_get_auto_sel_caps(int cpunum, struct cppc_epp_perf_caps *perf_caps);
 extern int cppc_set_auto_sel(int cpu, bool enable);
 #else /* !CONFIG_ACPI_CPPC_LIB */
 static inline int cppc_get_desired_perf(int cpunum, u64 *desired_perf)
@@ -209,7 +225,7 @@ static inline int cpc_write_ffh(int cpun
 {
 	return -ENOTSUPP;
 }
-static inline int cppc_set_epp_perf(int cpu, struct cppc_perf_ctrls *perf_ctrls, bool enable)
+static inline int cppc_set_epp_perf(int cpu, struct cppc_epp_perf_ctrls *perf_ctrls, bool enable)
 {
 	return -ENOTSUPP;
 }
@@ -221,7 +237,7 @@ static inline int cppc_set_auto_sel(int
 {
 	return -ENOTSUPP;
 }
-static inline int cppc_get_auto_sel_caps(int cpunum, struct cppc_perf_caps *perf_caps)
+static inline int cppc_get_auto_sel_caps(int cpunum, struct cppc_epp_perf_caps *perf_caps)
 {
 	return -ENOTSUPP;
 }
