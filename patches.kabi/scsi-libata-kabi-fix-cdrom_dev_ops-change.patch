From: Lee Duncan <lduncan@suse.com>
Date: Fri 22 Nov 2024 12:10:18 PM PST
Subject: scsi: cdrom: kABI: fix cdrom_dev_ops change
Patch-mainline: Never, kABI workaround
References: git-fixes

The patch:

> patches.git-fixes-applied/scsi-sr-Fix-unintentional-arithmetic-wraparound.patch

changed the CD-ROM speed selection to use an unsigned long instead
of an int, but this breaks kABI. The real bug fix for this commit
was masking the speed passed in, so leave that in place to fix
possible overflow problems, but switch the speed argument back
to an integer, for kABI purposes. The maximum allowed speed value
is 0xffff, so this change should be fine.
---
 drivers/scsi/sr.h       |    2 +-
 drivers/scsi/sr_ioctl.c |    2 +-
 include/linux/cdrom.h   |    2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

--- a/drivers/scsi/sr.h
+++ b/drivers/scsi/sr.h
@@ -65,7 +65,7 @@ int sr_disk_status(struct cdrom_device_i
 int sr_get_last_session(struct cdrom_device_info *, struct cdrom_multisession *);
 int sr_get_mcn(struct cdrom_device_info *, struct cdrom_mcn *);
 int sr_reset(struct cdrom_device_info *);
-int sr_select_speed(struct cdrom_device_info *cdi, unsigned long speed);
+int sr_select_speed(struct cdrom_device_info *cdi, int speed);
 int sr_audio_ioctl(struct cdrom_device_info *, unsigned int, void *);
 
 int sr_is_xa(Scsi_CD *);
--- a/drivers/scsi/sr_ioctl.c
+++ b/drivers/scsi/sr_ioctl.c
@@ -425,7 +425,7 @@ int sr_reset(struct cdrom_device_info *c
 	return 0;
 }
 
-int sr_select_speed(struct cdrom_device_info *cdi, unsigned long speed)
+int sr_select_speed(struct cdrom_device_info *cdi, int speed)
 {
 	Scsi_CD *cd = cdi->handle;
 	struct packet_command cgc;
--- a/include/linux/cdrom.h
+++ b/include/linux/cdrom.h
@@ -77,7 +77,7 @@ struct cdrom_device_ops {
 				      unsigned int clearing, int slot);
 	int (*tray_move) (struct cdrom_device_info *, int);
 	int (*lock_door) (struct cdrom_device_info *, int);
-	int (*select_speed) (struct cdrom_device_info *, unsigned long);
+	int (*select_speed) (struct cdrom_device_info *, int);
 	int (*get_last_session) (struct cdrom_device_info *,
 				 struct cdrom_multisession *);
 	int (*get_mcn) (struct cdrom_device_info *,
