From: Vasant Karasulli <vkarasulli@suse.de>
Date: Tue, 5 Aug 2025 17:23:18 +0200
Subject: [PATCH] kABI: restore layout of struct msi_desc
Patch-mainline: Never, kabi work around
References: CVE-2025-38062 bsc#1245216

Upstream commit 1f7df3a6917 removes member iommu_cookie and adds
two members to struct msi_desc. Add back the removed member and
move the new members to the end to preserve kABI.

Signed-off-by: Vasant Karasulli <vkarasulli@suse.de>
---
 include/linux/msi.h | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/include/linux/msi.h b/include/linux/msi.h
index a2de72639..8df740a75 100644
--- a/include/linux/msi.h
+++ b/include/linux/msi.h
@@ -193,8 +193,7 @@ struct msi_desc {
 	struct msi_msg			msg;
 	struct irq_affinity_desc	*affinity;
 #ifdef CONFIG_IRQ_MSI_IOMMU
-	u64				iommu_msi_iova : 58;
-	u64				iommu_msi_shift : 6;
+	const void			*iommu_cookie;
 #endif
 #ifdef CONFIG_SYSFS
 	struct device_attribute		*sysfs_attrs;
@@ -208,6 +207,10 @@ struct msi_desc {
 		struct pci_msi_desc	pci;
 		struct msi_desc_data	data;
 	};
+#if defined(CONFIG_IRQ_MSI_IOMMU) && !defined(__GENKSYMS__)
+	u64				iommu_msi_iova : 58;
+	u64				iommu_msi_shift : 6;
+#endif
 };
 
 /*
-- 
2.34.1

