From: Davide Benini <davide.benini@suse.com>
Date: Thu, 19 Sep 2024 13:24:21 +0200
Subject: [PATCH] kcm: Serialise kcm_sendmsg() for the same socket.
Patch-mainline: never, kabi workaround
References: CVE-2024-44946 bsc#1230015

Backport of mainline commit 807067bf014d4a3ae2cc55bd3de16f22a01eb580
("kcm: Serialise kcm_sendmsg() for the same socket") adds a new
struct mutex tx_mutex in kabi protected struct kcm_sock.

Move the struct to the the low part of the struct and hide the change from
genksyms

Signed-off-by: Davide Benini <davide.benini@suse.com>
---
 include/net/kcm.h |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/include/net/kcm.h
+++ b/include/net/kcm.h
@@ -73,7 +73,6 @@ struct kcm_sock {
 	struct work_struct tx_work;
 	struct list_head wait_psock_list;
 	struct sk_buff *seq_skb;
-	struct mutex tx_mutex;
 	u32 tx_stopped : 1;
 
 	/* Don't use bit fields here, these are set under different locks */
@@ -85,6 +84,9 @@ struct kcm_sock {
 	struct list_head wait_rx_list; /* KCMs waiting for receiving */
 	bool rx_wait;
 	u32 rx_disabled : 1;
+#ifndef __GENKSYMS__
+	struct mutex tx_mutex;
+#endif
 };
 
 struct bpf_prog;
