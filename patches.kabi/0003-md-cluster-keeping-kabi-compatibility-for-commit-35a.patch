From d35e53d3b5c802ee8d55db36b9cac333483b0c42 Mon Sep 17 00:00:00 2001
From: Heming Zhao <heming.zhao@suse.com>
Date: Mon, 5 Aug 2024 21:07:35 +0800
Subject: [PATCH] md-cluster: keeping kabi compatibility for upstream
 commit 35a0a409fa26
Patch-mainline: never, kABI fix
References: bsc#1223395

Upstream commit 35a0a409fa26 ("md-cluster: fix no recovery job
when adding/re-adding a disk") changes kabi. For keeping kabi
compatibility, move the position of struct md_cluster_operations
new members, and use __GENKSYMS__ to remove Genksyms complaint.

Signed-off-by: Heming Zhao <heming.zhao@suse.com>
---
 drivers/md/md-cluster.c | 6 ++++--
 drivers/md/md-cluster.h | 6 ++++--
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/drivers/md/md-cluster.c b/drivers/md/md-cluster.c
index bf6a0dd8dac7..cb4197db7386 100644
--- a/drivers/md/md-cluster.c
+++ b/drivers/md/md-cluster.c
@@ -1604,8 +1604,6 @@ static struct md_cluster_operations cluster_ops = {
 	.resync_start = resync_start,
 	.resync_finish = resync_finish,
 	.resync_info_update = resync_info_update,
-	.resync_start_notify = resync_start_notify,
-	.resync_status_get = resync_status_get,
 	.resync_info_get = resync_info_get,
 	.metadata_update_start = metadata_update_start,
 	.metadata_update_finish = metadata_update_finish,
@@ -1621,6 +1619,10 @@ static struct md_cluster_operations cluster_ops = {
 	.lock_all_bitmaps = lock_all_bitmaps,
 	.unlock_all_bitmaps = unlock_all_bitmaps,
 	.update_size = update_size,
+#ifndef __GENKSYMS__
+	.resync_start_notify = resync_start_notify,
+	.resync_status_get = resync_status_get,
+#endif
 };
 
 static int __init cluster_init(void)
diff --git a/drivers/md/md-cluster.h b/drivers/md/md-cluster.h
index 470bf18ffde5..ed05e782ca3c 100644
--- a/drivers/md/md-cluster.h
+++ b/drivers/md/md-cluster.h
@@ -14,8 +14,6 @@ struct md_cluster_operations {
 	int (*leave)(struct mddev *mddev);
 	int (*slot_number)(struct mddev *mddev);
 	int (*resync_info_update)(struct mddev *mddev, sector_t lo, sector_t hi);
-	int (*resync_start_notify)(struct mddev *mddev);
-	int (*resync_status_get)(struct mddev *mddev);
 	void (*resync_info_get)(struct mddev *mddev, sector_t *lo, sector_t *hi);
 	int (*metadata_update_start)(struct mddev *mddev);
 	int (*metadata_update_finish)(struct mddev *mddev);
@@ -33,6 +31,10 @@ struct md_cluster_operations {
 	int (*lock_all_bitmaps)(struct mddev *mddev);
 	void (*unlock_all_bitmaps)(struct mddev *mddev);
 	void (*update_size)(struct mddev *mddev, sector_t old_dev_sectors);
+#ifndef __GENKSYMS__
+	int (*resync_start_notify)(struct mddev *mddev);
+	int (*resync_status_get)(struct mddev *mddev);
+#endif
 };
 
 #endif /* _MD_CLUSTER_H */
-- 
2.35.3

